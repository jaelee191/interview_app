<div class="max-w-7xl mx-auto px-6 py-8">
  <h1 class="text-2xl font-semibold text-gray-900 mb-6">결제 현황</h1>
  <form class="mb-4 flex items-end gap-3" method="get">
    <div>
      <label class="block text-xs text-gray-500 mb-1">시작일</label>
      <input type="date" name="since" value="<%= @since.to_date %>" class="border border-gray-200 rounded-lg px-3 py-2 text-sm" />
    </div>
    <div>
      <label class="block text-xs text-gray-500 mb-1">종료일</label>
      <input type="date" name="until" value="<%= @until.to_date %>" class="border border-gray-200 rounded-lg px-3 py-2 text-sm" />
    </div>
    <button class="h-10 px-4 rounded-lg bg-emerald-500 text-white text-sm">필터 적용</button>
    <%= link_to "CSV 내보내기", admin_payments_path(request.query_parameters.merge(format: :csv)), class: "h-10 px-4 rounded-lg bg-gray-900 text-white text-sm inline-flex items-center" %>
  </form>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <div class="bg-white rounded-lg border border-gray-100 p-4">
      <p class="text-sm text-gray-600">총 매출</p>
      <p class="text-2xl font-bold text-gray-900">₩<%= number_with_delimiter(@total_revenue) %></p>
    </div>
    <div class="bg-white rounded-lg border border-gray-100 p-4">
      <p class="text-sm text-gray-600">최근 7일 매출</p>
      <p class="text-2xl font-bold text-gray-900">₩<%= number_with_delimiter(@last_7d) %></p>
    </div>
    <div class="bg-white rounded-lg border border-gray-100 p-4">
      <p class="text-sm text-gray-600">건수</p>
      <p class="text-2xl font-bold text-gray-900"><%= @payments.total_count rescue @payments.size %>건</p>
    </div>
  </div>

  <div class="bg-white rounded-lg border border-gray-100 overflow-hidden">
    <table class="min-w-full divide-y divide-gray-100" id="paymentsTable">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">시간</th>
          <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">유저</th>
          <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">주문ID</th>
          <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">금액</th>
          <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">상태</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-100 bg-white">
        <% @payments.each do |p| %>
          <tr class="hover:bg-gray-50 cursor-pointer" data-payment='<%= p.to_json(only: [:id,:order_id,:amount,:status,:payment_key,:created_at]) %>'>
            <td class="px-4 py-3 text-sm text-gray-700"><%= p.created_at.strftime('%Y-%m-%d %H:%M') %></td>
            <td class="px-4 py-3 text-sm text-gray-700"><%= p.user&.email %></td>
            <td class="px-4 py-3 text-sm text-gray-700"><%= p.order_id %></td>
            <td class="px-4 py-3 text-sm text-gray-900 font-medium">₩<%= number_with_delimiter(p.amount) %></td>
            <td class="px-4 py-3 text-xs">
              <span class="px-2 py-1 rounded-full bg-emerald-50 text-emerald-700"><%= p.status %></span>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>

<!-- 상세 모달 -->
<div id="paymentModal" class="fixed inset-0 hidden items-center justify-center z-50">
  <div class="absolute inset-0 bg-black/40" onclick="this.parentElement.classList.add('hidden')"></div>
  <div class="relative bg-white rounded-xl shadow-xl w-full max-w-md p-6">
    <h3 class="text-lg font-semibold text-gray-900 mb-4">결제 상세</h3>
    <div class="space-y-2 text-sm text-gray-700" id="paymentBody"></div>
    <div class="mt-6 text-right">
      <button class="px-4 py-2 rounded-lg bg-gray-900 text-white" onclick="document.getElementById('paymentModal').classList.add('hidden')">닫기</button>
    </div>
  </div>
</div>

<script>
  document.getElementById('paymentsTable')?.addEventListener('click', function(e){
    const tr = e.target.closest('tr[data-payment]');
    if(!tr) return;
    const p = JSON.parse(tr.dataset.payment);
    const body = document.getElementById('paymentBody');
    body.innerHTML = `
      <div><span class='text-gray-500'>주문ID</span> : ${p.order_id}</div>
      <div><span class='text-gray-500'>금액</span> : ₩${p.amount.toLocaleString()}</div>
      <div><span class='text-gray-500'>상태</span> : ${p.status}</div>
      <div><span class='text-gray-500'>결제키</span> : ${p.payment_key || '-'}</div>
      <div><span class='text-gray-500'>시간</span> : ${p.created_at}</div>
    `;
    document.getElementById('paymentModal').classList.remove('hidden');
  });
</script>


