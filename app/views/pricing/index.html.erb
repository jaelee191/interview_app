<!-- Pricing Page -->
<% content_for :head do %>
  <script src="https://js.tosspayments.com/v2/"></script>
<% end %>
<div class="min-h-screen bg-white">
  <!-- Header Section -->
  <section class="py-16 bg-gray-50 border-b border-gray-100">
    <div class="max-w-4xl mx-auto px-4">
      <div class="text-center">
        <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4">
          건별 과금 중심 요금제
        </h1>
        <p class="text-lg text-gray-600">
          3건까지는 무료, 그 이후는 필요한 만큼만 결제하세요
        </p>
      </div>
    </div>
  </section>
  
  <!-- Purchase Confirm Modal -->
  <div id="purchaseModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-gray-900/50 backdrop-blur-sm"></div>
    <div class="relative mx-auto max-w-md w-[90%] md:w-full top-28">
      <div class="bg-white rounded-2xl shadow-xl ring-1 ring-gray-900/5 overflow-hidden">
        <div class="px-6 py-5 bg-gradient-to-r from-emerald-500 to-emerald-600 text-white">
          <div class="flex items-center justify-between">
            <h3 class="text-base font-semibold">결제 확인</h3>
            <button id="modalClose" class="p-1.5 rounded-full hover:bg-white/10 focus:outline-none">
              <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6L6 18M6 6l12 12"/></svg>
            </button>
          </div>
        </div>
        <div class="px-6 py-6 space-y-2">
          <p class="text-sm text-gray-600">아래 내용으로 결제를 진행할까요?</p>
          <div class="mt-3 grid grid-cols-1 gap-3">
            <div class="flex items-center justify-between bg-gray-50 rounded-lg px-4 py-3">
              <span class="text-sm text-gray-600">상품</span>
              <span id="modalProduct" class="text-sm font-medium text-gray-900">-</span>
            </div>
            <div class="flex items-center justify-between bg-gray-50 rounded-lg px-4 py-3">
              <span class="text-sm text-gray-600">결제금액</span>
              <span class="text-sm font-bold text-gray-900"><span id="modalAmount">-</span>원</span>
            </div>
          </div>
        </div>
        <div class="px-6 pb-6">
          <div class="flex gap-2">
            <button id="modalCancel" class="flex-1 h-11 rounded-full border border-gray-200 text-gray-700 font-medium hover:bg-gray-50 transition-colors">취소</button>
            <button id="modalConfirm" class="flex-1 h-11 rounded-full bg-emerald-500 text-white font-semibold hover:bg-emerald-600 transition-colors shadow-sm">결제 진행</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Pricing Section -->
  <section class="py-16">
    <div class="max-w-6xl mx-auto px-4">
      <!-- Pricing Cards -->
      <div class="grid md:grid-cols-3 gap-6">
        <!-- Free Plan -->
        <div class="bg-white rounded-lg border border-gray-100 p-6">
          <div class="mb-6">
            <h3 class="text-xl font-semibold text-gray-900 mb-2">무료</h3>
            <p class="text-gray-600 text-sm">첫 3건 무료 제공</p>
            <div class="mt-4">
              <span class="text-3xl font-bold text-gray-900">₩0</span>
              <span class="text-gray-500">/ 3건</span>
            </div>
          </div>
          
          <ul class="space-y-3 mb-6">
            <li class="flex items-start">
              <div class="w-5 h-5 bg-emerald-100 rounded-full flex items-center justify-center flex-shrink-0 mr-3 mt-0.5">
                <div class="w-2 h-2 bg-emerald-500 rounded-full"></div>
              </div>
              <span class="text-gray-700 text-sm">자소서 분석 3건 무료</span>
            </li>
            <li class="flex items-start">
              <div class="w-5 h-5 bg-emerald-100 rounded-full flex items-center justify-center flex-shrink-0 mr-3 mt-0.5">
                <div class="w-2 h-2 bg-emerald-500 rounded-full"></div>
              </div>
              <span class="text-gray-700 text-sm">기본 AI 분석</span>
            </li>
            <li class="flex items-start">
              <div class="w-5 h-5 bg-emerald-100 rounded-full flex items-center justify-center flex-shrink-0 mr-3 mt-0.5">
                <div class="w-2 h-2 bg-emerald-500 rounded-full"></div>
              </div>
              <span class="text-gray-700 text-sm">채용공고 텍스트/URL 분석</span>
            </li>
          </ul>
          
          <button class="w-full py-2.5 px-4 bg-gray-100 text-gray-700 rounded-full font-medium hover:bg-gray-200 transition-colors text-sm">
            바로 시작하기
          </button>
        </div>

        <!-- 10-Pack Plan (Most Popular) -->
        <div class="bg-white rounded-lg border-2 border-emerald-500 p-6 relative">
          <div class="absolute -top-3 left-1/2 transform -translate-x-1/2">
            <span class="bg-emerald-500 text-white px-3 py-1 rounded-full text-xs font-medium">
              가장 인기
            </span>
          </div>
          
          <div class="mb-6">
            <h3 class="text-xl font-semibold text-gray-900 mb-2">10건 패키지</h3>
            <p class="text-gray-600 text-sm">필요할 때마다 사용하는 합리적 선택</p>
            <div class="mt-4">
              <span class="text-3xl font-bold text-gray-900">₩20,000</span>
              <span class="text-gray-500">/ 10건</span>
            </div>
            <p class="text-xs text-gray-500 mt-1">건당 약 ₩2,000</p>
          </div>
          
          <ul class="space-y-3 mb-6">
            <li class="flex items-start">
              <div class="w-5 h-5 bg-emerald-100 rounded-full flex items-center justify-center flex-shrink-0 mr-3 mt-0.5">
                <div class="w-2 h-2 bg-emerald-500 rounded-full"></div>
              </div>
              <span class="text-gray-700 text-sm">자소서 분석 10건</span>
            </li>
            <li class="flex items-start">
              <div class="w-5 h-5 bg-emerald-100 rounded-full flex items-center justify-center flex-shrink-0 mr-3 mt-0.5">
                <div class="w-2 h-2 bg-emerald-500 rounded-full"></div>
              </div>
              <span class="text-gray-700 text-sm">고급 분석 리포트</span>
            </li>
            <li class="flex items-start">
              <div class="w-5 h-5 bg-emerald-100 rounded-full flex items-center justify-center flex-shrink-0 mr-3 mt-0.5">
                <div class="w-2 h-2 bg-emerald-500 rounded-full"></div>
              </div>
              <span class="text-gray-700 text-sm">분석 결과 저장 & 비교</span>
            </li>
          </ul>
          
          <button id="buyPackBtn" class="w-full py-2.5 px-4 bg-emerald-500 text-white rounded-full font-medium hover:bg-emerald-600 transition-colors text-sm">
            10건 패키지 구매
          </button>
        </div>

        <!-- Premium Plan -->
        <div class="bg-white rounded-lg border border-gray-100 p-6">
          <div class="mb-6">
            <h3 class="text-xl font-semibold text-gray-900 mb-2">프리미엄 컨설팅</h3>
            <p class="text-gray-600 text-sm">개별 맞춤형 1:1 고도화 컨설팅</p>
            <div class="mt-4">
              <span class="text-3xl font-bold text-gray-900">₩500,000</span>
            </div>
          </div>
          
          <ul class="space-y-3 mb-6">
            <li class="flex items-start">
              <div class="w-5 h-5 bg-emerald-100 rounded-full flex items-center justify-center flex-shrink-0 mr-3 mt-0.5">
                <div class="w-2 h-2 bg-emerald-500 rounded-full"></div>
              </div>
              <span class="text-gray-700 text-sm">전담 컨설턴트 1:1 코칭(온라인)</span>
            </li>
            <li class="flex items-start">
              <div class="w-5 h-5 bg-emerald-100 rounded-full flex items-center justify-center flex-shrink-0 mr-3 mt-0.5">
                <div class="w-2 h-2 bg-emerald-500 rounded-full"></div>
              </div>
              <span class="text-gray-700 text-sm">자소서 완성까지 무제한 피드백(기간 내)</span>
            </li>
            <li class="flex items-start">
              <div class="w-5 h-5 bg-emerald-100 rounded-full flex items-center justify-center flex-shrink-0 mr-3 mt-0.5">
                <div class="w-2 h-2 bg-emerald-500 rounded-full"></div>
              </div>
              <span class="text-gray-700 text-sm">기업·직무 맞춤 전략 수립</span>
            </li>
          </ul>
          
          <button class="w-full py-2.5 px-4 bg-gray-900 text-white rounded-full font-medium hover:bg-gray-800 transition-colors text-sm">
            프리미엄 상담 신청
          </button>
        </div>
      </div>
    </div>
  </section>

  <!-- FAQ Section -->
  <section class="py-16 bg-gray-50">
    <div class="max-w-3xl mx-auto px-4">
      <h2 class="text-2xl font-bold text-center text-gray-900 mb-12">
        자주 묻는 질문
      </h2>
      
      <div class="space-y-4">
        <div class="bg-white rounded-lg p-6 border border-gray-100">
          <h3 class="font-medium text-gray-900 mb-2">
            "건"의 기준은 무엇인가요?
          </h3>
          <p class="text-gray-600 text-sm">
            한 번의 자소서 분석 요청을 1건으로 산정합니다. 동일 자소서라도 재분석을 요청하면 추가 1건이 차감됩니다.
          </p>
        </div>
        
        <div class="bg-white rounded-lg p-6 border border-gray-100">
          <h3 class="font-medium text-gray-900 mb-2">
            10건 패키지의 유효기간이 있나요?
          </h3>
          <p class="text-gray-600 text-sm">
            기본 유효기간은 구매일로부터 12개월입니다. 남은 건수는 마이페이지에서 확인하실 수 있습니다.
          </p>
        </div>
        
        <div class="bg-white rounded-lg p-6 border border-gray-100">
          <h3 class="font-medium text-gray-900 mb-2">
            환불 정책은 어떻게 되나요?
          </h3>
          <p class="text-gray-600 text-sm">
            미사용 건에 대해서는 구매 후 7일 이내 전액 환불, 이후에는 사용 건을 제외한 금액을 일할 계산하여 환불합니다.
          </p>
        </div>
      </div>
    </div>
  </section>
</div>

<script>
  (function() {
    const buyBtn = document.getElementById('buyPackBtn');
    const modal = document.getElementById('purchaseModal');
    const modalClose = document.getElementById('modalClose');
    const modalCancel = document.getElementById('modalCancel');
    const modalConfirm = document.getElementById('modalConfirm');
    const productEl = document.getElementById('modalProduct');
    const amountEl = document.getElementById('modalAmount');

    const csrf = () => document.querySelector('meta[name="csrf-token"]').content;
    const open = () => modal.classList.remove('hidden');
    const close = () => modal.classList.add('hidden');

    let pendingOrder = null;

    buyBtn?.addEventListener('click', async () => {
      try {
        const prep = await fetch('/pricing/purchase_pack', { method: 'POST', headers: { 'X-CSRF-Token': csrf() } });
        const data = await prep.json();
        if (!data.success) { alert('결제 준비에 실패했습니다. 잠시 후 다시 시도해주세요.'); return; }

        pendingOrder = data;
        productEl.textContent = data.orderName;
        amountEl.textContent = data.amount.toLocaleString();
        modal.dataset.orderId = data.orderId;
        modal.dataset.amount = String(data.amount);
        open();
      } catch (e) {
        console.error(e);
        alert('결제 준비 중 오류가 발생했습니다.');
      }
    });

    modalClose?.addEventListener('click', close);
    modalCancel?.addEventListener('click', close);
    modal?.addEventListener('click', (e) => {
      if (e.target === modal) close();
    });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') close(); });

    modalConfirm?.addEventListener('click', async () => {
      if (!pendingOrder) return;
      try {
        modalConfirm.disabled = true;
        modalConfirm.textContent = '처리 중…';

        const clientKey = '<%= (ENV["TOSS_CLIENT_KEY"].presence || Rails.application.credentials.dig(:toss, :client_key)).to_s %>';
        if (!clientKey) {
          // 개발용 우회: 결제창 없이 모의 승인 호출
          try {
            const mock = await fetch('/pricing/mock_success', {
              method: 'POST',
              headers: { 'X-CSRF-Token': csrf() }
            });
            const r = await mock.json();
            if (r.success) {
              alert('개발모드: 결제 없이 10건이 지급되었습니다. 잔여: ' + r.credits + '건');
              location.href = '/mypage';
            } else {
              alert('개발모드 모의 승인 실패');
            }
          } catch (e) {
            console.error(e);
            alert('개발모드 모의 승인 중 오류가 발생했습니다.');
          }
          return;
        }

        // 결제창 요청 (TossPayments v2)
        const tossPayments = TossPayments(clientKey);
        const base = window.location.origin;
        const successUrl = `${base}/pricing/success`;
        const failUrl = `${base}/pricing/fail`;

        // 결제창으로 이동하면 이후 처리는 success/fail URL에서 진행됩니다.
        close();
        await tossPayments.requestPayment('CARD', {
          amount: pendingOrder.amount,
          orderId: pendingOrder.orderId,
          orderName: pendingOrder.orderName,
          successUrl,
          failUrl,
          customerEmail: pendingOrder.customerEmail,
          customerName: pendingOrder.customerName
        });
      } catch (e) {
        console.error(e);
        alert('결제창 호출 중 오류가 발생했습니다.');
      } finally {
        modalConfirm.disabled = false;
        modalConfirm.textContent = '결제 진행';
      }
    });
  })();
</script>