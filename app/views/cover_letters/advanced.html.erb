<!-- Advanced Cover Letter Analysis Page -->
<div class="min-h-screen bg-white">
  <!-- Header Section -->
  <div class="bg-gray-50 border-b border-gray-100 py-16">
    <div class="max-w-4xl mx-auto px-4">
      <div class="text-center">
        <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4">
          3단계 <span class="text-emerald-500">AI 심층 분석</span>
        </h1>
        <p class="text-lg text-gray-600">
          기업 분석 → 자소서 평가 → 맞춤형 자소서 생성까지
        </p>
        
        <!-- Process Steps -->
        <div class="flex justify-center items-center mt-8 space-x-6">
          <div class="flex items-center">
            <div class="w-8 h-8 bg-emerald-500 text-white rounded-full flex items-center justify-center text-sm font-medium">1</div>
            <span class="ml-2 text-sm text-gray-700">기업 분석</span>
          </div>
          <div class="h-px w-8 bg-gray-300"></div>
          <div class="flex items-center">
            <div class="w-8 h-8 bg-emerald-500 text-white rounded-full flex items-center justify-center text-sm font-medium">2</div>
            <span class="ml-2 text-sm text-gray-700">자소서 평가</span>
          </div>
          <div class="h-px w-8 bg-gray-300"></div>
          <div class="flex items-center">
            <div class="w-8 h-8 bg-emerald-500 text-white rounded-full flex items-center justify-center text-sm font-medium">3</div>
            <span class="ml-2 text-sm text-gray-700">맞춤 생성</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="max-w-4xl mx-auto px-4 py-12">
    <!-- Form -->
    <%= form_with(model: @cover_letter, url: analyze_advanced_cover_letters_path, local: true, class: "bg-white rounded-lg border border-gray-100 p-8") do |form| %>
      <% if @cover_letter.errors.any? %>
        <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
          <p class="text-red-800 font-medium mb-2">다음 오류를 확인해주세요:</p>
          <ul class="list-disc list-inside text-red-700 text-sm">
            <% @cover_letter.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <!-- PDF Upload Section -->
      <div class="mb-6 p-5 bg-gray-50 rounded-lg">
        <h3 class="font-medium text-gray-900 mb-3">이력서/자소서 PDF 업로드 (선택)</h3>
        <div class="space-y-4">
          <div class="flex items-center justify-center w-full">
            <label for="pdf-upload" class="flex flex-col items-center justify-center w-full h-24 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-white hover:bg-gray-50 transition-colors">
              <div class="flex flex-col items-center justify-center">
                <p class="mb-1 text-sm text-gray-700"><span class="font-medium">클릭하여 PDF 업로드</span></p>
                <p class="text-xs text-gray-500">PDF 파일만 가능 (최대 10MB)</p>
              </div>
              <input id="pdf-upload" type="file" class="hidden" accept=".pdf" />
            </label>
          </div>
          <div id="pdf-info" class="hidden">
            <div class="bg-white p-3 rounded-lg border border-gray-200">
              <div class="flex items-center justify-between">
                <div class="flex items-center">
                  <span id="pdf-filename" class="text-sm font-medium text-gray-700"></span>
                </div>
                <button id="remove-pdf" class="text-gray-500 hover:text-gray-700">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Features -->
      <div class="mb-6 p-5 bg-gray-50 rounded-lg">
        <h3 class="font-medium text-gray-900 mb-3">3단계 심층 분석의 특별함</h3>
        <div class="grid md:grid-cols-3 gap-4">
          <div>
            <p class="font-medium text-gray-800 text-sm">기업 분석</p>
            <p class="text-xs text-gray-600">최신 현안과 인재상 파악</p>
          </div>
          <div>
            <p class="font-medium text-gray-800 text-sm">15년 경력 평가</p>
            <p class="text-xs text-gray-600">인사팀 선배의 디테일한 조언</p>
          </div>
          <div>
            <p class="font-medium text-gray-800 text-sm">맞춤형 생성</p>
            <p class="text-xs text-gray-600">기업별 최적화된 자소서</p>
          </div>
        </div>
      </div>

      <!-- Basic Information -->
      <div class="space-y-4">
        <div>
          <%= form.label :user_name, "이름", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= form.text_field :user_name, 
              placeholder: "홍길동",
              class: "w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent" %>
        </div>

        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <%= form.label :company_name, "지원 기업", class: "block text-sm font-medium text-gray-700 mb-2" %>
            <%= form.text_field :company_name, 
                placeholder: "삼성전자",
                class: "w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent" %>
          </div>

          <div>
            <%= form.label :position, "지원 직무", class: "block text-sm font-medium text-gray-700 mb-2" %>
            <%= form.text_field :position, 
                placeholder: "소프트웨어 개발",
                class: "w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent" %>
          </div>
        </div>

        <div>
          <%= form.label :title, "제목", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= form.text_field :title, 
              placeholder: "2025 상반기 신입 자기소개서",
              class: "w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent" %>
        </div>

        <div>
          <%= form.label :content, "자기소개서 내용", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <div class="relative">
            <%= form.text_area :content, 
                rows: 12,
                placeholder: "자기소개서 내용을 입력해주세요.\n\n예시:\n저는 대학에서 컴퓨터공학을 전공하며...",
                class: "w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent resize-none" %>
            <div class="absolute bottom-3 right-3 text-xs text-gray-400">
              <span id="char-count">0</span> / 5000자
            </div>
          </div>
        </div>
      </div>

      <!-- Process Description -->
      <div class="mt-6 p-5 bg-gray-50 rounded-lg">
        <h4 class="font-medium text-gray-900 mb-3">분석 프로세스</h4>
        <ol class="space-y-2 text-sm text-gray-700">
          <li class="flex items-start">
            <span class="font-medium mr-2">1단계:</span>
            <span>기업의 핵심 사업, 최근 현안, 인재상을 분석합니다</span>
          </li>
          <li class="flex items-start">
            <span class="font-medium mr-2">2단계:</span>
            <span>15년 경력 인사팀 선배의 관점으로 자소서를 평가합니다</span>
          </li>
          <li class="flex items-start">
            <span class="font-medium mr-2">3단계:</span>
            <span>분석 결과를 바탕으로 맞춤형 자소서를 생성합니다</span>
          </li>
        </ol>
      </div>

      <!-- Submit Button -->
      <div class="mt-8 flex justify-center">
        <%= form.submit "3단계 심층 분석 시작", 
            class: "px-6 py-3 bg-emerald-500 hover:bg-emerald-600 text-white font-medium rounded-full transition-colors cursor-pointer" %>
      </div>
    <% end %>

    <!-- Links -->
    <div class="mt-8 text-center">
      <p class="text-gray-600 mb-3">다른 분석 방법을 원하시나요?</p>
      <div class="flex justify-center space-x-4">
        <%= link_to "기본 분석", new_cover_letter_path, class: "text-emerald-600 hover:text-emerald-700 font-medium text-sm" %>
        <%= link_to "AI와 대화하며 작성", interactive_cover_letters_path, class: "text-emerald-600 hover:text-emerald-700 font-medium text-sm" %>
      </div>
    </div>
  </div>
</div>

<script>
  // Character count and PDF upload
  document.addEventListener('turbo:load', () => {
    const textarea = document.querySelector('textarea[name="cover_letter[content]"]');
    const charCount = document.getElementById('char-count');
    
    if (textarea && charCount) {
      const updateCount = () => {
        charCount.textContent = textarea.value.length;
      };
      
      textarea.addEventListener('input', updateCount);
      updateCount();
    }
    
    // PDF Upload functionality
    const pdfUpload = document.getElementById('pdf-upload');
    const pdfInfo = document.getElementById('pdf-info');
    const pdfFilename = document.getElementById('pdf-filename');
    const removePdf = document.getElementById('remove-pdf');
    let selectedFile = null;
    
    if (pdfUpload) {
      pdfUpload.addEventListener('change', function(e) {
        const file = e.target.files[0];
        
        if (file) {
          // Validate file type
          if (file.type !== 'application/pdf') {
            alert('PDF 파일만 업로드 가능합니다.');
            this.value = '';
            return;
          }
          
          // Validate file size (10MB)
          if (file.size > 10 * 1024 * 1024) {
            alert('파일 크기는 10MB 이하여야 합니다.');
            this.value = '';
            return;
          }
          
          selectedFile = file;
          pdfFilename.textContent = file.name;
          pdfInfo.classList.remove('hidden');
          
          // Add hidden input for file
          const existingInput = document.getElementById('pdf-file-data');
          if (existingInput) {
            existingInput.remove();
          }
          
          // Create FormData for file upload
          const reader = new FileReader();
          reader.onload = function(e) {
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.id = 'pdf-file-data';
            hiddenInput.name = 'cover_letter[pdf_content]';
            hiddenInput.value = e.target.result;
            document.querySelector('form').appendChild(hiddenInput);
          };
          reader.readAsDataURL(file);
        }
      });
    }
    
    if (removePdf) {
      removePdf.addEventListener('click', function(e) {
        e.preventDefault();
        selectedFile = null;
        pdfUpload.value = '';
        pdfInfo.classList.add('hidden');
        pdfFilename.textContent = '';
        
        // Remove hidden input
        const hiddenInput = document.getElementById('pdf-file-data');
        if (hiddenInput) {
          hiddenInput.remove();
        }
      });
    }
  });
</script>