<div class="min-h-screen bg-gradient-to-b from-gray-50 to-white">
  <!-- Page Header -->
  <div class="border-b border-gray-100 bg-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-3xl font-bold text-gray-900">AIì™€ í•¨ê»˜í•˜ëŠ” ìê¸°ì†Œê°œì„œ ì‘ì„±</h1>
          <p class="text-gray-600 mt-2">ë‹¨ê³„ë³„ ì§ˆë¬¸ì— ë‹µí•˜ë©´ì„œ ì™„ë²½í•œ ìê¸°ì†Œê°œì„œë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”</p>
        </div>
        <%= link_to cover_letters_path, class: "inline-flex items-center text-sm font-medium text-gray-700 hover:text-black transition-colors" do %>
          <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
          ëª©ë¡ìœ¼ë¡œ
        <% end %>
      </div>
    </div>
  </div>
  
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <!-- ì‹œì‘ í™”ë©´ -->
    <div id="startScreen" class="bg-white rounded-xl border border-gray-100 p-8">
      <div class="text-center mb-8">
        <div class="w-20 h-20 bg-gradient-to-br from-purple-500 to-blue-500 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
          </svg>
        </div>
        <h2 class="text-2xl font-bold text-gray-900 mb-2">AI ì½”ì¹˜ì™€ í•¨ê»˜ ì‹œì‘í•˜ê¸°</h2>
        <p class="text-gray-600">7ë‹¨ê³„ì˜ ëŒ€í™”ë¥¼ í†µí•´ ë§ì¶¤í˜• ìê¸°ì†Œê°œì„œë¥¼ ì™„ì„±í•©ë‹ˆë‹¤</p>
      </div>
      
      <div class="space-y-4 mb-8">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">ì§€ì› ê¸°ì—… <span class="text-red-500">*</span></label>
          <input type="text" 
                 id="companyName" 
                 placeholder="ì˜ˆ: ì‚¼ì„±ì „ì"
                 class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:border-black focus:outline-none focus:ring-1 focus:ring-black transition-all">
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">ì§€ì› ì§ë¬´ <span class="text-red-500">*</span></label>
          <input type="text" 
                 id="position" 
                 placeholder="ì˜ˆ: ì†Œí”„íŠ¸ì›¨ì–´ ê°œë°œì"
                 class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:border-black focus:outline-none focus:ring-1 focus:ring-black transition-all">
        </div>
      </div>
      
      <div class="bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg p-6 mb-6">
        <h3 class="font-semibold text-gray-900 mb-3">ğŸ“ 7ë‹¨ê³„ ì‘ì„± í”„ë¡œì„¸ìŠ¤</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
          <div class="flex items-center"><span class="mr-2">1ï¸âƒ£</span> ê¸°ì—… ì¡°ì‚¬ ë° ì´í•´</div>
          <div class="flex items-center"><span class="mr-2">2ï¸âƒ£</span> ìê¸°ì†Œê°œ êµ¬ì„±</div>
          <div class="flex items-center"><span class="mr-2">3ï¸âƒ£</span> ì§€ì›ë™ê¸° ëª…í™•í™”</div>
          <div class="flex items-center"><span class="mr-2">4ï¸âƒ£</span> í•µì‹¬ ê²½í—˜ ì •ë¦¬</div>
          <div class="flex items-center"><span class="mr-2">5ï¸âƒ£</span> ê°•ì  ë° ì—­ëŸ‰ ë„ì¶œ</div>
          <div class="flex items-center"><span class="mr-2">6ï¸âƒ£</span> ì…ì‚¬ í›„ í¬ë¶€ ì„¤ì •</div>
          <div class="flex items-center"><span class="mr-2">7ï¸âƒ£</span> ìµœì¢… ê²€í†  ë° ì™„ì„±</div>
        </div>
      </div>
      
      <button onclick="startInteractive()" 
              class="w-full py-4 bg-black text-white rounded-lg hover:bg-gray-800 transition-all font-medium text-lg">
        ğŸš€ AI ì½”ì¹˜ì™€ ëŒ€í™” ì‹œì‘í•˜ê¸°
      </button>
    </div>
    
    <!-- ëŒ€í™” í™”ë©´ -->
    <div id="chatScreen" class="hidden">
      <!-- ì§„í–‰ë¥  í‘œì‹œ -->
      <div class="bg-white rounded-xl border border-gray-100 p-6 mb-6">
        <div class="flex items-center justify-between mb-2">
          <span class="text-sm font-medium text-gray-700">ì§„í–‰ ìƒí™©</span>
          <span id="progressText" class="text-sm text-gray-600">1/7 ë‹¨ê³„</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2">
          <div id="progressBar" class="bg-gradient-to-r from-purple-600 to-blue-600 h-2 rounded-full transition-all duration-500" style="width: 14%"></div>
        </div>
        
        <!-- ë‹¨ê³„ ì•„ì´ì½˜ -->
        <div class="flex justify-between mt-4">
          <div class="step-icon" data-step="1">ğŸ¢</div>
          <div class="step-icon" data-step="2">ğŸ‘¤</div>
          <div class="step-icon" data-step="3">ğŸ¯</div>
          <div class="step-icon" data-step="4">ğŸ’¼</div>
          <div class="step-icon" data-step="5">ğŸ’ª</div>
          <div class="step-icon" data-step="6">ğŸš€</div>
          <div class="step-icon" data-step="7">âœ…</div>
        </div>
      </div>
      
      <!-- ì±„íŒ… ì˜ì—­ -->
      <div class="bg-white rounded-xl border border-gray-100 p-6">
        <div id="chatMessages" class="space-y-4 mb-6 max-h-96 overflow-y-auto">
          <!-- ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
        </div>
        
        <!-- ì…ë ¥ ì˜ì—­ -->
        <div id="inputArea" class="flex gap-3">
          <textarea id="userMessage" 
                    placeholder="ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”..."
                    rows="3"
                    class="flex-1 px-4 py-3 border border-gray-200 rounded-lg focus:border-black focus:outline-none focus:ring-1 focus:ring-black transition-all resize-none"></textarea>
          <button onclick="sendMessage()" 
                  id="sendButton"
                  class="px-6 py-3 bg-black text-white rounded-lg hover:bg-gray-800 transition-all font-medium self-end">
            ì „ì†¡
          </button>
        </div>
        
        <!-- ë¡œë”© í‘œì‹œ -->
        <div id="loadingIndicator" class="hidden mt-4">
          <div class="flex items-center justify-center space-x-2">
            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
            <span class="text-sm text-gray-600 ml-2">AIê°€ ìƒê° ì¤‘...</span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- ì™„ì„± í™”ë©´ -->
    <div id="completeScreen" class="hidden">
      <div class="bg-white rounded-xl border border-gray-100 p-8">
        <div class="text-center mb-6">
          <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </div>
          <h2 class="text-2xl font-bold text-gray-900 mb-2">ìê¸°ì†Œê°œì„œê°€ ì™„ì„±ë˜ì—ˆìŠµë‹ˆë‹¤!</h2>
          <p class="text-gray-600">AIê°€ ì‘ì„±í•œ ìê¸°ì†Œê°œì„œë¥¼ ê²€í† í•˜ê³  ì €ì¥í•˜ì„¸ìš”</p>
        </div>
        
        <div class="bg-gray-50 rounded-lg p-6 mb-6">
          <h3 class="font-semibold text-gray-900 mb-3">ğŸ“ ì™„ì„±ëœ ìê¸°ì†Œê°œì„œ</h3>
          <div id="finalContent" class="prose prose-sm max-w-none text-gray-700 whitespace-pre-wrap"></div>
        </div>
        
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">ì œëª©</label>
            <input type="text" 
                   id="coverLetterTitle" 
                   placeholder="ì˜ˆ: ì‚¼ì„±ì „ì SWê°œë°œ ìê¸°ì†Œê°œì„œ"
                   class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:border-black focus:outline-none focus:ring-1 focus:ring-black transition-all">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">ì´ë¦„</label>
            <input type="text" 
                   id="userName" 
                   placeholder="ì˜ˆ: í™ê¸¸ë™"
                   class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:border-black focus:outline-none focus:ring-1 focus:ring-black transition-all">
          </div>
        </div>
        
        <div class="flex gap-3 mt-6">
          <button onclick="saveInteractive()" 
                  class="flex-1 py-3 bg-black text-white rounded-lg hover:bg-gray-800 transition-all font-medium">
            ğŸ’¾ ì €ì¥í•˜ê³  AI ë¶„ì„ ë°›ê¸°
          </button>
          <button onclick="restartInteractive()" 
                  class="flex-1 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-all font-medium">
            ğŸ”„ ë‹¤ì‹œ ì‘ì„±í•˜ê¸°
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .step-icon {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f3f4f6;
    border-radius: 50%;
    font-size: 18px;
    transition: all 0.3s;
  }
  
  .step-icon.active {
    background: linear-gradient(135deg, #9333ea, #2563eb);
    box-shadow: 0 4px 12px rgba(147, 51, 234, 0.3);
  }
  
  .step-icon.completed {
    background: #10b981;
  }
  
  .message-user {
    background: linear-gradient(135deg, #9333ea, #2563eb);
    color: white;
    padding: 12px 16px;
    border-radius: 16px 16px 4px 16px;
    max-width: 80%;
    margin-left: auto;
  }
  
  .message-assistant {
    background: #f3f4f6;
    color: #1f2937;
    padding: 12px 16px;
    border-radius: 16px 16px 16px 4px;
    max-width: 80%;
  }
</style>

<script>
  let currentSession = null;
  
  function startInteractive() {
    const companyName = document.getElementById('companyName').value;
    const position = document.getElementById('position').value;
    
    if (!companyName || !position) {
      alert('ê¸°ì—…ëª…ê³¼ ì§ë¬´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
    
    // í™”ë©´ ì „í™˜
    document.getElementById('startScreen').classList.add('hidden');
    document.getElementById('chatScreen').classList.remove('hidden');
    
    // ì„¸ì…˜ ì‹œì‘
    fetch('/cover_letters/start_interactive', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
      },
      body: JSON.stringify({ company_name: companyName, position: position })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        addMessage('assistant', data.message);
        updateProgress(data.progress);
      }
    });
  }
  
  function sendMessage() {
    const messageInput = document.getElementById('userMessage');
    const message = messageInput.value.trim();
    
    if (!message) return;
    
    // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
    addMessage('user', message);
    messageInput.value = '';
    
    // ë¡œë”© í‘œì‹œ
    showLoading(true);
    
    // ë©”ì‹œì§€ ì „ì†¡
    fetch('/cover_letters/send_message', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
      },
      body: JSON.stringify({ message: message })
    })
    .then(response => response.json())
    .then(data => {
      showLoading(false);
      
      if (data.success) {
        addMessage('assistant', data.message);
        updateProgress(data.progress);
        
        // ìµœì¢… ë‹¨ê³„ í™•ì¸
        if (data.final_content) {
          showCompleteScreen(data.final_content);
        }
      }
    });
  }
  
  function addMessage(role, content) {
    const messagesDiv = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = role === 'user' ? 'message-user' : 'message-assistant';
    messageDiv.innerHTML = content.replace(/\n/g, '<br>');
    messagesDiv.appendChild(messageDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }
  
  function updateProgress(progress) {
    document.getElementById('progressBar').style.width = progress + '%';
    const step = Math.ceil(progress / 14.3);
    document.getElementById('progressText').textContent = `${step}/7 ë‹¨ê³„`;
    
    // ë‹¨ê³„ ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
    document.querySelectorAll('.step-icon').forEach((icon, index) => {
      if (index < step - 1) {
        icon.classList.add('completed');
        icon.classList.remove('active');
      } else if (index === step - 1) {
        icon.classList.add('active');
        icon.classList.remove('completed');
      } else {
        icon.classList.remove('active', 'completed');
      }
    });
  }
  
  function showLoading(show) {
    document.getElementById('loadingIndicator').classList.toggle('hidden', !show);
    document.getElementById('sendButton').disabled = show;
  }
  
  function showCompleteScreen(content) {
    document.getElementById('chatScreen').classList.add('hidden');
    document.getElementById('completeScreen').classList.remove('hidden');
    document.getElementById('finalContent').textContent = content;
  }
  
  function saveInteractive() {
    const title = document.getElementById('coverLetterTitle').value;
    const userName = document.getElementById('userName').value;
    const content = document.getElementById('finalContent').textContent;
    
    if (!title) {
      alert('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
    
    fetch('/cover_letters/save_interactive', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
      },
      body: JSON.stringify({ 
        title: title, 
        user_name: userName,
        content: content 
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        window.location.href = data.redirect_url;
      } else {
        alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    });
  }
  
  function restartInteractive() {
    if (confirm('ë‹¤ì‹œ ì‘ì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ? í˜„ì¬ ë‚´ìš©ì€ ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.')) {
      location.reload();
    }
  }
  
  // Enter í‚¤ë¡œ ì „ì†¡
  document.getElementById('userMessage')?.addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });
</script>