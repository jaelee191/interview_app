<div class="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 py-12">
  <div class="max-w-6xl mx-auto px-4">
    <!-- 헤더 -->
    <div class="text-center mb-12">
      <h1 class="text-4xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent mb-4">
        AI 맥락 기반 자소서 생성
      </h1>
      <p class="text-gray-600 text-lg">
        기업의 현재 이슈와 당신의 숨은 강점을 연결하여 차별화된 자소서를 작성합니다
      </p>
    </div>

    <!-- 3단계 프로세스 표시 -->
    <div class="grid grid-cols-3 gap-4 mb-12">
      <div class="bg-white rounded-xl p-6 shadow-sm border-2 border-blue-200">
        <div class="flex items-center mb-3">
          <div class="w-10 h-10 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold">1</div>
          <h3 class="ml-3 font-semibold">기업 맥락 분석</h3>
        </div>
        <p class="text-sm text-gray-600">최근 뉴스, 채용 패턴으로 기업의 현재 이슈 파악</p>
      </div>
      
      <div class="bg-white rounded-xl p-6 shadow-sm border-2 border-purple-200">
        <div class="flex items-center mb-3">
          <div class="w-10 h-10 bg-purple-500 text-white rounded-full flex items-center justify-center font-bold">2</div>
          <h3 class="ml-3 font-semibold">숨은 강점 발견</h3>
        </div>
        <p class="text-sm text-gray-600">당신도 몰랐던 차별화된 역량 발굴</p>
      </div>
      
      <div class="bg-white rounded-xl p-6 shadow-sm border-2 border-green-200">
        <div class="flex items-center mb-3">
          <div class="w-10 h-10 bg-green-500 text-white rounded-full flex items-center justify-center font-bold">3</div>
          <h3 class="ml-3 font-semibold">맥락적 연결</h3>
        </div>
        <p class="text-sm text-gray-600">기업 니즈와 개인 역량의 최적 매칭</p>
      </div>
    </div>

    <!-- 입력 폼 -->
    <div class="bg-white rounded-2xl shadow-xl p-8">
      <form id="intelligent-analysis-form">
        <!-- 기업 정보 섹션 -->
        <div class="mb-8">
          <h2 class="text-xl font-bold mb-4 flex items-center">
            <svg class="w-6 h-6 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-1 4h1m-1 4h1"></path>
            </svg>
            기업 정보
          </h2>
          
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">기업명*</label>
              <input type="text" 
                     name="company_name" 
                     class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                     placeholder="예: 삼성전자"
                     required>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">지원 직무*</label>
              <input type="text" 
                     name="position" 
                     class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                     placeholder="예: 백엔드 개발자"
                     required>
            </div>
          </div>
        </div>

        <!-- 채용공고 입력 섹션 -->
        <div class="mb-8">
          <h2 class="text-xl font-bold mb-4 flex items-center">
            <svg class="w-6 h-6 mr-2 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            채용공고
          </h2>
          
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">채용공고 URL</label>
              <input type="url" 
                     name="job_posting_url" 
                     class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                     placeholder="https://...">
              <p class="text-xs text-gray-500 mt-1">URL이 없다면 아래에 직접 입력하세요</p>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">또는 채용공고 내용 직접 입력</label>
              <textarea name="job_posting_data" 
                        rows="6" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                        placeholder="채용공고 내용을 붙여넣으세요..."></textarea>
            </div>
          </div>
        </div>

        <!-- 프로필 확인 섹션 -->
        <% if @user_profile %>
        <div class="mb-8">
          <h2 class="text-xl font-bold mb-4 flex items-center">
            <svg class="w-6 h-6 mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
            </svg>
            내 프로필
          </h2>
          
          <div class="bg-gray-50 rounded-lg p-4">
            <p class="text-sm text-gray-600 mb-2">등록된 프로필 정보를 기반으로 분석합니다</p>
            <div class="flex items-center justify-between">
              <div>
                <p class="font-medium"><%= @user_profile.name %></p>
                <p class="text-sm text-gray-500">희망 직무: <%= @user_profile.desired_position || "미설정" %></p>
              </div>
              <%= link_to "프로필 수정", edit_user_profile_path(@user_profile), 
                          class: "text-blue-600 hover:text-blue-700 text-sm font-medium" %>
            </div>
          </div>
        </div>
        <% else %>
        <div class="mb-8 bg-yellow-50 border border-yellow-200 rounded-lg p-4">
          <p class="text-yellow-800">
            <strong>프로필이 없습니다.</strong> 
            <%= link_to "프로필을 작성", new_user_profile_path, class: "text-yellow-700 underline" %>하면 더 정확한 분석이 가능합니다.
          </p>
        </div>
        <% end %>

        <!-- 분석 시작 버튼 -->
        <div class="flex justify-center">
          <button type="submit" 
                  class="px-8 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white font-bold rounded-lg hover:shadow-lg transform transition hover:scale-105">
            <span class="flex items-center">
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
              </svg>
              지능형 분석 시작
            </span>
          </button>
        </div>
      </form>
    </div>

    <!-- 결과 표시 영역 -->
    <div id="analysis-result" class="hidden mt-12">
      <div class="bg-white rounded-2xl shadow-xl p-8">
        <h2 class="text-2xl font-bold mb-6">분석 결과</h2>
        
        <!-- 로딩 상태 -->
        <div id="loading-state" class="text-center py-12">
          <div class="inline-flex items-center">
            <svg class="animate-spin h-8 w-8 mr-3 text-blue-600" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="text-lg">지능형 분석 진행 중...</span>
          </div>
          <div id="progress-steps" class="mt-6 space-y-2">
            <div class="step-item text-gray-500">⏳ 기업 맥락 분석 중...</div>
            <div class="step-item text-gray-500">⏳ 숨은 강점 발견 중...</div>
            <div class="step-item text-gray-500">⏳ 맥락적 연결 생성 중...</div>
            <div class="step-item text-gray-500">⏳ 자소서 작성 중...</div>
          </div>
        </div>
        
        <!-- 결과 내용 -->
        <div id="result-content" class="hidden">
          <!-- 인사이트 카드들 -->
          <div class="grid grid-cols-3 gap-4 mb-8">
            <div class="bg-blue-50 rounded-lg p-4">
              <h3 class="font-semibold text-blue-900 mb-2">기업 현재 이슈</h3>
              <div id="company-issues" class="text-sm text-blue-700"></div>
            </div>
            
            <div class="bg-purple-50 rounded-lg p-4">
              <h3 class="font-semibold text-purple-900 mb-2">발견된 강점</h3>
              <div id="hidden-strengths" class="text-sm text-purple-700"></div>
            </div>
            
            <div class="bg-green-50 rounded-lg p-4">
              <h3 class="font-semibold text-green-900 mb-2">핵심 연결점</h3>
              <div id="key-connections" class="text-sm text-green-700"></div>
            </div>
          </div>
          
          <!-- 생성된 자소서 -->
          <div class="border-t pt-6">
            <h3 class="text-xl font-bold mb-4">생성된 자소서</h3>
            <div id="generated-cover-letter" class="bg-gray-50 rounded-lg p-6 whitespace-pre-wrap"></div>
          </div>
          
          <!-- 액션 버튼들 -->
          <div class="flex justify-center gap-4 mt-6">
            <button id="copy-btn" class="px-6 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
              📋 복사하기
            </button>
            <button id="save-btn" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
              💾 저장하기
            </button>
            <button id="regenerate-btn" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
              🔄 다시 생성
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('intelligent-analysis-form');
  const resultSection = document.getElementById('analysis-result');
  const loadingState = document.getElementById('loading-state');
  const resultContent = document.getElementById('result-content');
  
  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // 결과 섹션 표시
    resultSection.classList.remove('hidden');
    loadingState.classList.remove('hidden');
    resultContent.classList.add('hidden');
    
    // 프로그레스 애니메이션 시작
    animateProgress();
    
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    
    try {
      const response = await fetch('/cover_letters/perform_intelligent_analysis', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
        },
        body: JSON.stringify(data)
      });
      
      const result = await response.json();
      
      if (result.success) {
        displayResults(result);
      } else {
        alert('분석 중 오류가 발생했습니다: ' + result.error);
      }
    } catch (error) {
      alert('네트워크 오류가 발생했습니다.');
      console.error(error);
    } finally {
      loadingState.classList.add('hidden');
      resultContent.classList.remove('hidden');
    }
  });
  
  function animateProgress() {
    const steps = document.querySelectorAll('.step-item');
    steps.forEach((step, index) => {
      setTimeout(() => {
        step.innerHTML = step.innerHTML.replace('⏳', '✅');
        step.classList.remove('text-gray-500');
        step.classList.add('text-green-600');
      }, (index + 1) * 2000);
    });
  }
  
  function displayResults(result) {
    // 기업 이슈 표시
    const issues = result.metadata.company_context;
    document.getElementById('company-issues').innerHTML = 
      Object.entries(issues).map(([key, value]) => `<div>• ${value}</div>`).join('');
    
    // 발견된 강점 표시
    const strengths = result.metadata.discovered_strengths;
    document.getElementById('hidden-strengths').innerHTML = 
      strengths.map(s => `<div>• ${s}</div>`).join('');
    
    // 핵심 연결점 표시
    const connections = result.metadata.key_connections;
    document.getElementById('key-connections').innerHTML = 
      connections.map(c => `<div>• ${c.narrative}</div>`).join('');
    
    // 자소서 표시
    document.getElementById('generated-cover-letter').textContent = result.content;
    
    // 버튼 이벤트 설정
    setupResultButtons(result);
  }
  
  function setupResultButtons(result) {
    // 복사 버튼
    document.getElementById('copy-btn').addEventListener('click', () => {
      navigator.clipboard.writeText(result.content);
      alert('자소서가 클립보드에 복사되었습니다!');
    });
    
    // 저장 버튼
    document.getElementById('save-btn').addEventListener('click', () => {
      // 저장 로직 구현
      alert('자소서가 저장되었습니다!');
    });
    
    // 재생성 버튼
    document.getElementById('regenerate-btn').addEventListener('click', () => {
      form.dispatchEvent(new Event('submit'));
    });
  }
});
</script>