<div class="min-h-screen bg-gray-50">
  <!-- Hero Section -->
  <div class="bg-white border-b border-gray-100">
    <div class="max-w-4xl mx-auto px-4 py-16">
      <div class="text-center">
        <h1 class="text-3xl font-bold text-gray-900 mb-4">
          ì±„ìš©ê³µê³ ë¥¼ <span class="text-emerald-500">ë¶„ì„</span>í•©ë‹ˆë‹¤
        </h1>
        <p class="text-gray-600 text-lg">
          ì±„ìš©ê³µê³  URLì„ ì…ë ¥í•˜ë©´ ê¸°ì—…ì˜ ì‹¤ì œ ë‹ˆì¦ˆë¥¼ íŒŒì•…í•©ë‹ˆë‹¤
        </p>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="max-w-4xl mx-auto px-4 py-12">
    <!-- Features Grid -->
    <div class="grid md:grid-cols-3 gap-6 mb-12">
      <div class="bg-white rounded-lg p-6 border border-gray-100">
        <h3 class="font-semibold text-gray-900 mb-2">í•µì‹¬ í‚¤ì›Œë“œ</h3>
        <p class="text-sm text-gray-600">ì±„ìš©ê³µê³ ì—ì„œ ì¤‘ìš”í•œ í‚¤ì›Œë“œì™€ ìˆ¨ê²¨ì§„ ìš”êµ¬ì‚¬í•­ íŒŒì•…</p>
      </div>
      
      <div class="bg-white rounded-lg p-6 border border-gray-100">
        <h3 class="font-semibold text-gray-900 mb-2">ìš”êµ¬ ì—­ëŸ‰</h3>
        <p class="text-sm text-gray-600">í•„ìˆ˜ ì—­ëŸ‰ê³¼ ìš°ëŒ€ì‚¬í•­ì„ ì²´ê³„ì ìœ¼ë¡œ ì •ë¦¬</p>
      </div>
      
      <div class="bg-white rounded-lg p-6 border border-gray-100">
        <h3 class="font-semibold text-gray-900 mb-2">ì±„ìš© ë§¥ë½</h3>
        <p class="text-sm text-gray-600">ê¸°ì—…ì˜ í˜„ì¬ ìƒí™©ê³¼ ì—°ê²°í•˜ì—¬ ì±„ìš© ë°°ê²½ í•´ì„</p>
      </div>
    </div>

    <!-- URL Input Form -->
    <div class="bg-white rounded-lg border border-gray-100 p-8">
      <form id="jobPostingForm" class="space-y-6">
        <!-- URL Input -->
        <div>
          <label for="job_url" class="block text-sm font-medium text-gray-700 mb-2">
            ì±„ìš©ê³µê³  URL
          </label>
          <input type="url" 
                 id="job_url" 
                 name="url"
                 placeholder="https://www.jobkorea.co.kr/..."
                 class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all"
                 value="<%= params[:url] || @auto_url %>">
        </div>
        
        <!-- Job Title Input -->
        <div>
          <label for="job_title" class="block text-sm font-medium text-gray-700 mb-2">
            ì§ë¬´ëª… <span class="text-gray-400 font-normal">(ì„ íƒì‚¬í•­)</span>
          </label>
          <input type="text" 
                 id="job_title" 
                 name="job_title"
                 placeholder="ì˜ˆ: í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œì"
                 class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all">
        </div>
        
        <!-- Submit Button -->
        <button type="submit" 
                id="analyzeBtn"
                class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-medium py-3 rounded-lg transition-colors">
          <span id="btnText">ë¶„ì„ ì‹œì‘</span>
        </button>
      </form>
    </div>

    <!-- Results & Loading containers -->
    <div id="analysisResults" class="hidden mt-8"></div>
    <div id="loadingState" class="hidden bg-white rounded-lg border border-gray-100 p-8 mt-8">
      <div class="text-center">
        <!-- ë¡œë”© ìŠ¤í”¼ë„ˆì™€ íƒ€ì´ë¨¸ -->
        <div class="relative inline-block mb-4">
          <style>
            @keyframes spin {
              from { transform: rotate(0deg); }
              to { transform: rotate(360deg); }
            }
            .animate-spin-custom {
              animation: spin 1s linear infinite;
            }
          </style>
          <div class="relative w-20 h-20">
            <div class="absolute inset-0 border-4 border-gray-200 rounded-full"></div>
            <div class="absolute inset-0 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin-custom"></div>
            <div class="absolute inset-0 flex items-center justify-center">
              <span id="loadingTimer" class="text-lg font-bold text-gray-700">0ì´ˆ</span>
            </div>
          </div>
        </div>
        
        <!-- ìƒíƒœ ë©”ì‹œì§€ -->
        <h3 class="text-xl font-bold text-gray-900 mb-2">ì±„ìš©ê³µê³ ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤</h3>
        <p id="loadingStatus" class="text-gray-600 mb-4">í˜ì´ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        
        <!-- í”„ë¡œê·¸ë ˆìŠ¤ ë°” -->
        <div class="max-w-sm mx-auto mb-4">
          <div class="bg-gray-200 rounded-full h-2 overflow-hidden">
            <div id="loadingProgress" class="bg-gradient-to-r from-emerald-400 to-emerald-600 h-full rounded-full transition-all duration-500" style="width: 10%"></div>
          </div>
          <div class="flex justify-between text-xs text-gray-500 mt-1">
            <span>ì‹œì‘</span>
            <span id="progressPercent">10%</span>
            <span>ì™„ë£Œ</span>
          </div>
        </div>
        
        <!-- ë‹¨ê³„ë³„ ìƒíƒœ -->
        <div class="flex justify-center space-x-8 mb-4">
          <div id="step1" class="flex items-center text-sm">
            <div class="w-2 h-2 bg-emerald-500 rounded-full mr-2 animate-pulse"></div>
            <span class="text-gray-600">í¬ë¡¤ë§</span>
          </div>
          <div id="step2" class="flex items-center text-sm">
            <div class="w-2 h-2 bg-gray-300 rounded-full mr-2"></div>
            <span class="text-gray-400">ë¶„ì„</span>
          </div>
          <div id="step3" class="flex items-center text-sm">
            <div class="w-2 h-2 bg-gray-300 rounded-full mr-2"></div>
            <span class="text-gray-400">ìƒì„±</span>
          </div>
        </div>
        
        <!-- íŒ ë©”ì‹œì§€ (ìˆœí™˜) -->
        <div class="text-sm text-gray-500 italic">
          <p id="loadingTip">ğŸ’¡ ì‚¬ëŒì¸ì˜ ë³µì‚¬ ë°©ì§€ ê¸°ëŠ¥ë„ ìš°íšŒí•˜ì—¬ ë¶„ì„í•©ë‹ˆë‹¤</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('jobPostingForm');
  const analyzeBtn = document.getElementById('analyzeBtn');
  const btnText = document.getElementById('btnText');
  const loadingState = document.getElementById('loadingState');
  const resultsContainer = document.getElementById('analysisResults');
  
  <% if @auto_analyze %>
    setTimeout(() => form.dispatchEvent(new Event('submit')), 1000);
  <% end %>
  
  form.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const url = document.getElementById('job_url').value.trim();
    const jobTitle = document.getElementById('job_title').value.trim();
    
    if (!url) {
      alert('ì±„ìš©ê³µê³  URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
    
    // UI ìƒíƒœ ì—…ë°ì´íŠ¸
    console.log('ë¶„ì„ ì‹œì‘ - ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ í‘œì‹œ');
    analyzeBtn.disabled = true;
    btnText.textContent = 'ë¶„ì„ ì¤‘...';
    
    // ë¡œë”© ìƒíƒœ ê°•ì œ í‘œì‹œ
    loadingState.style.display = 'block';
    loadingState.classList.remove('hidden');
    console.log('ë¡œë”© ì—˜ë¦¬ë¨¼íŠ¸:', loadingState);
    console.log('display ìƒíƒœ:', window.getComputedStyle(loadingState).display);
    
    resultsContainer.classList.add('hidden');
    resultsContainer.innerHTML = '';
    
    // íƒ€ì´ë¨¸ì™€ í”„ë¡œê·¸ë ˆìŠ¤ ì´ˆê¸°í™”
    let startTime = Date.now();
    let progressValue = 10;
    
    // íƒ€ì´ë¨¸ ì—…ë°ì´íŠ¸
    const timerInterval = setInterval(() => {
      const elapsed = Math.floor((Date.now() - startTime) / 1000);
      document.getElementById('loadingTimer').textContent = `${elapsed}ì´ˆ`;
    }, 100);
    
    // í”„ë¡œê·¸ë ˆìŠ¤ ì—…ë°ì´íŠ¸
    const progressInterval = setInterval(() => {
      if (progressValue < 90) {
        progressValue += Math.random() * 10;
        progressValue = Math.min(progressValue, 90);
        document.getElementById('loadingProgress').style.width = `${progressValue}%`;
        document.getElementById('progressPercent').textContent = `${Math.floor(progressValue)}%`;
      }
    }, 500);
    
    // ë‹¨ê³„ë³„ ìƒíƒœ ì—…ë°ì´íŠ¸
    setTimeout(() => {
      document.getElementById('loadingStatus').textContent = 'AIê°€ ì±„ìš©ê³µê³ ë¥¼ ë¶„ì„ ì¤‘...';
      document.querySelector('#step1 .w-2').classList.remove('animate-pulse');
      document.querySelector('#step1 .w-2').classList.add('bg-emerald-500');
      document.querySelector('#step2 .w-2').classList.remove('bg-gray-300');
      document.querySelector('#step2 .w-2').classList.add('bg-emerald-500', 'animate-pulse');
      document.querySelector('#step2 span').classList.remove('text-gray-400');
      document.querySelector('#step2 span').classList.add('text-gray-600');
    }, 3000);
    
    setTimeout(() => {
      document.getElementById('loadingStatus').textContent = 'ë§ì¶¤í˜• ì¸ì‚¬ì´íŠ¸ ìƒì„± ì¤‘...';
      document.querySelector('#step2 .w-2').classList.remove('animate-pulse');
      document.querySelector('#step3 .w-2').classList.remove('bg-gray-300');
      document.querySelector('#step3 .w-2').classList.add('bg-emerald-500', 'animate-pulse');
      document.querySelector('#step3 span').classList.remove('text-gray-400');
      document.querySelector('#step3 span').classList.add('text-gray-600');
    }, 6000);
    
    // íŒ ë©”ì‹œì§€ ìˆœí™˜
    const tips = [
      'ğŸ’¡ ì‚¬ëŒì¸ì˜ ë³µì‚¬ ë°©ì§€ ê¸°ëŠ¥ë„ ìš°íšŒí•˜ì—¬ ë¶„ì„í•©ë‹ˆë‹¤',
      'ğŸ“Š ê¸°ì—…ì˜ í•µì‹¬ ìš”êµ¬ì‚¬í•­ì„ íŒŒì•…í•˜ê³  ìˆìŠµë‹ˆë‹¤',
      'ğŸ¯ ë§ì¶¤í˜• ìì†Œì„œ ì „ëµì„ ìˆ˜ë¦½ ì¤‘ì…ë‹ˆë‹¤',
      'âœ¨ AIê°€ ìµœì ì˜ í‚¤ì›Œë“œë¥¼ ì¶”ì¶œí•˜ê³  ìˆìŠµë‹ˆë‹¤',
      'ğŸ” ê²½ìŸë ¥ ìˆëŠ” ì§€ì› ì „ëµì„ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤'
    ];
    let tipIndex = 0;
    const tipInterval = setInterval(() => {
      tipIndex = (tipIndex + 1) % tips.length;
      document.getElementById('loadingTip').textContent = tips[tipIndex];
    }, 3000);
    
    fetch('/cover_letters/analyze_job_posting', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
      },
      body: JSON.stringify({
        url: url,
        job_title: jobTitle,
        use_enhanced: 'true',
        use_python: 'true'
      })
    })
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      console.log('ë¶„ì„ ì‘ë‹µ:', data); // ë””ë²„ê¹…ìš©
      
      // íƒ€ì´ë¨¸ì™€ ì¸í„°ë²Œ ì •ë¦¬
      clearInterval(timerInterval);
      clearInterval(progressInterval);
      clearInterval(tipInterval);
      
      // í”„ë¡œê·¸ë ˆìŠ¤ 100% ì™„ë£Œ
      document.getElementById('loadingProgress').style.width = '100%';
      document.getElementById('progressPercent').textContent = '100%';
      document.getElementById('loadingStatus').textContent = 'ë¶„ì„ ì™„ë£Œ!';
      
      // ëª¨ë“  ë‹¨ê³„ ì™„ë£Œ í‘œì‹œ
      document.querySelectorAll('.w-2').forEach(dot => {
        dot.classList.remove('animate-pulse', 'bg-gray-300');
        dot.classList.add('bg-emerald-500');
      });
      
      // ì ì‹œ í›„ ë¡œë”© ìˆ¨ê¸°ê¸°
      setTimeout(() => {
        loadingState.style.display = 'none';
        loadingState.classList.add('hidden');
        console.log('ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ ìˆ¨ê¹€');
      }, 500);
      
      if (data.success) {
        let analysisContent = '';
        
        // ë§ˆí¬ë‹¤ìš´ í…ìŠ¤íŠ¸ë¥¼ HTMLë¡œ ë³€í™˜í•˜ëŠ” ê°„ë‹¨í•œ í•¨ìˆ˜
        const parseMarkdown = (text) => {
          if (!text) return '';
          return text
            .replace(/### (.*)/g, '<h3 class="text-lg font-semibold mb-2 mt-4 text-gray-900">$1</h3>')
            .replace(/## (.*)/g, '<h2 class="text-xl font-semibold mb-3 mt-6 text-gray-900">$1</h2>')
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/- (.*)/g, '<li class="ml-4">$1</li>')
            .replace(/\n\n/g, '</p><p class="mb-4">')
            .replace(/^/, '<p class="mb-4">')
            .replace(/$/, '</p>')
            .replace(/<li/g, '<ul class="list-disc mb-4"><li')
            .replace(/<\/li>(?!<li)/g, '</li></ul>');
        };
        
        if (data.analysis_data && data.analysis_data.sections) {
          const sections = data.analysis_data.sections;
          analysisContent = `
            <div class="space-y-6">
              ${sections.company_overview ? `<div class="bg-white rounded-lg border border-gray-100 p-6">
                <h3 class="text-lg font-semibold mb-3 text-gray-900">ê¸°ì—… ê°œìš”</h3>
                <div class="text-gray-700 prose prose-sm max-w-none">${sections.company_overview}</div>
              </div>` : ''}
              
              ${sections.job_context ? `<div class="bg-white rounded-lg border border-gray-100 p-6">
                <h3 class="text-lg font-semibold mb-3 text-gray-900">ì±„ìš© ë°°ê²½</h3>
                <div class="text-gray-700 prose prose-sm max-w-none">${sections.job_context}</div>
              </div>` : ''}
              
              ${sections.job_requirements ? `<div class="bg-white rounded-lg border border-gray-100 p-6">
                <h3 class="text-lg font-semibold mb-3 text-gray-900">ì§ë¬´ ìš”êµ¬ì‚¬í•­</h3>
                <div class="text-gray-700 prose prose-sm max-w-none">${sections.job_requirements}</div>
              </div>` : ''}
              
              ${sections.preparation_strategy ? `<div class="bg-white rounded-lg border border-gray-100 p-6">
                <h3 class="text-lg font-semibold mb-3 text-gray-900">ì¤€ë¹„ ì „ëµ</h3>
                <div class="text-gray-700 prose prose-sm max-w-none">${sections.preparation_strategy}</div>
              </div>` : ''}
            </div>
          `;
        } else if (typeof data.analysis === 'string') {
          // ë§ˆí¬ë‹¤ìš´ í˜•ì‹ì˜ ë¶„ì„ ê²°ê³¼ë¥¼ HTMLë¡œ ë³€í™˜
          analysisContent = `<div class="bg-white rounded-lg border border-gray-100 p-6">
            <div class="prose prose-sm max-w-none text-gray-700">${parseMarkdown(data.analysis)}</div>
          </div>`;
        }
        
        resultsContainer.innerHTML = `
          <div class="space-y-6">
            <div class="bg-white rounded-lg border border-gray-100 p-6">
              <div class="flex items-center justify-between mb-4">
                <div>
                  <h2 class="text-xl font-semibold text-gray-900">${data.company_name || 'ê¸°ì—…'}</h2>
                  <p class="text-gray-600">${data.position || 'ì§ë¬´'}</p>
                </div>
                <span class="px-3 py-1 bg-emerald-50 text-emerald-600 text-sm font-medium rounded-full">ë¶„ì„ ì™„ë£Œ</span>
              </div>
            </div>
            
            ${analysisContent}
            
            <div class="bg-white rounded-lg border border-gray-100 p-6">
              <a href="/cover_letters/interactive" 
                 class="inline-flex items-center px-6 py-3 bg-emerald-500 hover:bg-emerald-600 text-white font-medium rounded-lg transition-colors">
                ì´ ë¶„ì„ìœ¼ë¡œ ìì†Œì„œ ì‘ì„±
              </a>
            </div>
          </div>
        `;
        resultsContainer.classList.remove('hidden');
      } else {
        resultsContainer.innerHTML = `
          <div class="bg-white border border-red-100 rounded-lg p-6">
            <h3 class="text-red-900 font-semibold mb-2">ë¶„ì„ ì‹¤íŒ¨</h3>
            <p class="text-red-700">${data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'}</p>
          </div>
        `;
        resultsContainer.classList.remove('hidden');
      }
    })
    .catch(error => {
      // íƒ€ì´ë¨¸ì™€ ì¸í„°ë²Œ ì •ë¦¬
      clearInterval(timerInterval);
      clearInterval(progressInterval);
      clearInterval(tipInterval);
      
      loadingState.style.display = 'none';
      loadingState.classList.add('hidden');
      console.log('ì—ëŸ¬ ë°œìƒ - ë¡œë”© ìˆ¨ê¹€');
      
      resultsContainer.innerHTML = `
        <div class="bg-white border border-red-100 rounded-lg p-6">
          <h3 class="text-red-900 font-semibold mb-2">ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜</h3>
          <p class="text-red-700">ì„œë²„ì™€ ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${error.message}</p>
        </div>
      `;
      resultsContainer.classList.remove('hidden');
    })
    .finally(() => {
      analyzeBtn.disabled = false;
      btnText.textContent = 'ë¶„ì„ ì‹œì‘';
    });
  });
});
</script>