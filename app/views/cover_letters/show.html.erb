<% content_for :head do %>
  <meta name="turbo-cache-control" content="no-cache">
  <meta name="turbo-visit-control" content="reload">
<% end %>

<div class="min-h-screen bg-gradient-to-b from-white to-gray-50">
  <!-- Header Section -->
  <div class="bg-gray-50 border-b border-gray-100">
    <div class="max-w-5xl mx-auto px-4 py-8">
      <div class="text-center">
        <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4">
          AI 자소서 분석 완료
        </h1>
        <p class="text-lg text-gray-600 mb-4">
          15년차 HR 전문가가 꼼꼼히 검토한 맞춤형 피드백
        </p>
        
        <!-- Success Badge -->
        <div class="inline-flex items-center px-4 py-2 bg-emerald-50 rounded-lg border border-emerald-200">
          <svg class="w-4 h-4 text-emerald-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <span class="text-emerald-700 font-medium text-sm">분석 완료</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="max-w-5xl mx-auto px-4 py-6">
    <div class="flex flex-wrap justify-center gap-3">
      <% if current_user %>
        <% if @cover_letter.saved? && @cover_letter.user_id == current_user.id %>
          <%= button_to unsave_analysis_cover_letter_path(@cover_letter), 
              method: :delete,
              class: "inline-flex items-center px-5 py-2.5 bg-gray-100 text-gray-700 font-medium rounded-lg hover:bg-gray-200 transition-colors" do %>
            <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
            </svg>
            저장됨
          <% end %>
        <% else %>
          <%= button_to save_analysis_cover_letter_path(@cover_letter), 
              method: :post,
              class: "inline-flex items-center px-5 py-2.5 bg-emerald-500 text-white font-medium rounded-lg hover:bg-emerald-600 transition-colors" do %>
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
            </svg>
            분석 결과 저장
          <% end %>
        <% end %>
      <% else %>
        <%= link_to new_user_session_path, 
            class: "inline-flex items-center px-5 py-2.5 bg-emerald-500 text-white font-medium rounded-lg hover:bg-emerald-600 transition-colors" do %>
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
          </svg>
          로그인하고 저장하기
        <% end %>
      <% end %>
      
      <button onclick="window.print()" class="inline-flex items-center px-5 py-2.5 bg-white text-gray-700 font-medium rounded-lg hover:bg-gray-50 transition-colors border border-gray-300">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
        </svg>
        PDF로 저장
      </button>
    </div>
  </div>

  <!-- Main Content -->
  <div class="max-w-5xl mx-auto px-4 pb-20">
    
    <!-- Company Info Card -->
    <% if @cover_letter.company_name.present? || @cover_letter.position.present? %>
      <div class="bg-white rounded-lg border border-gray-100 p-6 mb-8">
        <div class="flex flex-wrap items-center justify-center gap-8">
          <% if @cover_letter.company_name.present? %>
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-emerald-100 rounded-full flex items-center justify-center">
                <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                </svg>
              </div>
              <div>
                <span class="text-sm text-gray-500 block">지원 기업</span>
                <strong class="text-lg text-gray-900"><%= @cover_letter.company_name %></strong>
              </div>
            </div>
          <% end %>
          <% if @cover_letter.position.present? %>
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-emerald-100 rounded-full flex items-center justify-center">
                <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                </svg>
              </div>
              <div>
                <span class="text-sm text-gray-500 block">지원 직무</span>
                <strong class="text-lg text-gray-900"><%= @cover_letter.position %></strong>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

    <!-- Analysis Results -->
    <div class="bg-white rounded-lg border border-gray-100 mb-8">
      <div class="px-6 py-4 bg-gray-50 border-b border-gray-100">
        <h2 class="text-xl font-bold text-gray-900">
          HR 전문가 분석 결과
        </h2>
      </div>
      
      <div class="p-6 lg:p-8">
        <% if @cover_letter.advanced_analysis_json.present? %>
          <!-- JSON 구조 사용 (신규) -->
          <% sections = @cover_letter.advanced_analysis_json['sections'] %>
          
          <div class="space-y-8">
            <% sections.each do |section| %>
              <div class="bg-gray-50 rounded-lg p-6 border border-gray-100">
                <div class="flex items-start mb-4">
                  <div class="w-8 h-8 bg-emerald-100 rounded-full flex items-center justify-center font-semibold mr-3 flex-shrink-0 text-emerald-700">
                    <%= section['number'] %>
                  </div>
                  <h3 class="text-lg font-bold text-gray-900 pt-1">
                    <%= section['title'] %>
                  </h3>
                </div>
                
                <div class="pl-11 space-y-4">
                  <% if section['content'].present? %>
                    <div class="text-gray-700 leading-relaxed text-base lg:text-lg">
                      <%= simple_format(section['content'], class: "whitespace-pre-wrap") %>
                    </div>
                  <% end %>
                  
                  <% if section['items'].present? && section['items'].any? %>
                    <% section['items'].each do |item| %>
                      <div class="mb-6">
                        <% if item['title'].present? %>
                          <h4 class="text-lg font-semibold text-emerald-600 mb-3">
                            <%= "#{section['title'].include?('강점') ? '강점' : section['title'].include?('개선') ? '개선점' : '보석'} #{item['number']}: #{item['title']}" %>
                          </h4>
                        <% end %>
                        <p class="text-gray-700 leading-relaxed text-base">
                          <%= simple_format(item['content'], class: "whitespace-pre-wrap") %>
                        </p>
                      </div>
                    <% end %>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
          
        <% elsif @cover_letter.analysis_result.present? || @cover_letter.advanced_analysis.present? %>
          <!-- 텍스트 파싱 사용 (기존 호환성) -->
          <% analysis_content = @cover_letter.advanced_analysis.present? ? @cover_letter.advanced_analysis : @cover_letter.analysis_result %>
          <% sections = parse_analysis_sections(analysis_content) %>
          
          <div class="space-y-8">
            <% if sections.is_a?(Array) %>
              <% sections.each do |section| %>
                <div class="bg-gray-50 rounded-lg p-6 border border-gray-100">
                  <div class="flex items-start mb-4">
                    <div class="w-8 h-8 bg-emerald-100 rounded-full flex items-center justify-center font-semibold mr-3 flex-shrink-0 text-emerald-700">
                      <%= section[:number] %>
                    </div>
                    <h3 class="text-lg font-bold text-gray-900 pt-1">
                      <%= section[:title] %>
                    </h3>
                  </div>
                  
                  <div class="pl-11 space-y-4">
                    <div class="text-gray-700 leading-relaxed text-base lg:text-lg">
                      <%= simple_format(section[:content], class: "whitespace-pre-wrap") %>
                    </div>
                  </div>
                </div>
              <% end %>
            <% else %>
              <!-- Fallback for the entire content if sections couldn't be parsed -->
              <div class="text-gray-700 leading-relaxed">
                <%= simple_format(analysis_content, class: "whitespace-pre-wrap") %>
              </div>
            <% end %>
          </div>
        <% else %>
          <div class="text-center py-12">
            <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg class="w-8 h-8 text-gray-400 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
            </div>
            <p class="text-gray-500">분석 결과를 준비 중입니다...</p>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Next Steps -->
    <div class="bg-gray-50 rounded-lg border border-gray-100 p-8 text-center">
      <h3 class="text-xl font-bold text-gray-900 mb-2">다음 단계</h3>
      <p class="text-gray-600 mb-6">
        분석 결과를 바탕으로 자소서를 개선해보세요
      </p>
      <div class="flex flex-col sm:flex-row gap-3 justify-center">
        <% if @cover_letter.improved_letter.present? %>
          <%= link_to rewrite_result_cover_letter_path(@cover_letter), 
              class: "inline-flex items-center justify-center px-6 py-3 bg-emerald-500 text-white font-semibold rounded-lg hover:bg-emerald-600 transition-colors shadow-sm" do %>
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            리라이트 결과 보기
          <% end %>
        <% else %>
          <!-- 리라이트 옵션 선택 드롭다운 -->
          <div class="relative inline-block" x-data="{ open: false }">
            <button @click="open = !open" 
                    @click.away="open = false"
                    class="inline-flex items-center justify-center px-6 py-3 bg-emerald-500 text-white font-semibold rounded-lg hover:bg-emerald-600 transition-colors shadow-sm">
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
              </svg>
              피드백 반영하여 리라이트
              <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            
            <!-- 드롭다운 메뉴 -->
            <div x-show="open" 
                 x-transition:enter="transition ease-out duration-100"
                 x-transition:enter-start="transform opacity-0 scale-95"
                 x-transition:enter-end="transform opacity-100 scale-100"
                 x-transition:leave="transition ease-in duration-75"
                 x-transition:leave-start="transform opacity-100 scale-100"
                 x-transition:leave-end="transform opacity-0 scale-95"
                 class="absolute z-10 mt-2 w-72 rounded-lg bg-white shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none">
              <div class="py-1">
                <%= button_to rewrite_with_feedback_cover_letter_path(@cover_letter), 
                    method: :post,
                    params: { rewrite_mode: 'preserve' },
                    class: "w-full text-left px-4 py-3 hover:bg-gray-50 transition-colors" do %>
                  <div class="flex items-start">
                    <div class="flex-shrink-0 mt-0.5">
                      <div class="w-6 h-6 bg-emerald-100 rounded-full flex items-center justify-center">
                        <span class="text-xs font-bold text-emerald-600">1</span>
                      </div>
                    </div>
                    <div class="ml-3">
                      <p class="font-semibold text-gray-900">원문 스타일 유지</p>
                      <p class="text-sm text-gray-500 mt-1">현재 문체와 어조를 최대한 보존하면서 개선</p>
                    </div>
                  </div>
                <% end %>
                
                <%= button_to rewrite_with_feedback_cover_letter_path(@cover_letter), 
                    method: :post,
                    params: { rewrite_mode: 'optimize' },
                    class: "w-full text-left px-4 py-3 hover:bg-gray-50 transition-colors" do %>
                  <div class="flex items-start">
                    <div class="flex-shrink-0 mt-0.5">
                      <div class="w-6 h-6 bg-blue-100 rounded-full flex items-center justify-center">
                        <span class="text-xs font-bold text-blue-600">2</span>
                      </div>
                    </div>
                    <div class="ml-3">
                      <p class="font-semibold text-gray-900">자연스럽게 다듬기</p>
                      <p class="text-sm text-gray-500 mt-1">AI 티 제거하고 읽기 편하게 최적화</p>
                    </div>
                  </div>
                <% end %>
                
                <%= button_to rewrite_with_feedback_cover_letter_path(@cover_letter), 
                    method: :post,
                    params: { rewrite_mode: 'recreate' },
                    class: "w-full text-left px-4 py-3 hover:bg-gray-50 transition-colors rounded-b-lg" do %>
                  <div class="flex items-start">
                    <div class="flex-shrink-0 mt-0.5">
                      <div class="w-6 h-6 bg-purple-100 rounded-full flex items-center justify-center">
                        <span class="text-xs font-bold text-purple-600">3</span>
                      </div>
                    </div>
                    <div class="ml-3">
                      <p class="font-semibold text-gray-900">전체 재작성</p>
                      <p class="text-sm text-gray-500 mt-1">피드백 반영하여 완전히 새로 작성</p>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
        
        <%= link_to advanced_cover_letters_path, 
            class: "px-6 py-3 bg-white text-gray-700 font-medium rounded-lg hover:bg-gray-50 transition-colors border border-gray-300" do %>
          새로운 자소서 분석하기
        <% end %>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>

<style>
  @media print {
    nav, header, button, .no-print { display: none !important; }
    .bg-gradient-to-b { background: white !important; }
    .shadow-sm { box-shadow: none !important; }
    @page { margin: 1.5cm; size: A4; }
  }
</style>