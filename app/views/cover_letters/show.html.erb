<% content_for :head do %>
  <meta name="turbo-cache-control" content="no-cache">
  <meta name="turbo-visit-control" content="reload">
<% end %>

<div class="min-h-screen bg-gradient-to-b from-white to-gray-50">
  <!-- Header Section -->
  <div class="bg-gray-50 border-b border-gray-100">
    <div class="max-w-5xl mx-auto px-4 py-8">
      <div class="text-center">
        <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4">
          AI ÏûêÏÜåÏÑú Î∂ÑÏÑù ÏôÑÎ£å
        </h1>
        <p class="text-lg text-gray-600 mb-4">
          15ÎÖÑÏ∞® HR Ï†ÑÎ¨∏Í∞ÄÍ∞Ä ÍººÍººÌûà Í≤ÄÌÜ†Ìïú ÎßûÏ∂§Ìòï ÌîºÎìúÎ∞±
        </p>
        
        <!-- Success Badge -->
        <div class="inline-flex items-center px-4 py-2 bg-emerald-50 rounded-lg border border-emerald-200">
          <svg class="w-4 h-4 text-emerald-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <span class="text-emerald-700 font-medium text-sm">Î∂ÑÏÑù ÏôÑÎ£å</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="max-w-5xl mx-auto px-4 py-6">
    <div class="flex flex-wrap justify-center gap-3">
      <% if current_user %>
        <% if @cover_letter.saved? && @cover_letter.user_id == current_user.id %>
          <%= button_to unsave_analysis_cover_letter_path(@cover_letter), 
              method: :delete,
              class: "inline-flex items-center px-5 py-2.5 bg-gray-100 text-gray-700 font-medium rounded-lg hover:bg-gray-200 transition-colors" do %>
            <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path>
            </svg>
            Ï†ÄÏû•Îê®
          <% end %>
        <% else %>
          <%= button_to save_analysis_cover_letter_path(@cover_letter), 
              method: :post,
              class: "inline-flex items-center px-5 py-2.5 bg-emerald-500 text-white font-medium rounded-lg hover:bg-emerald-600 transition-colors" do %>
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
            </svg>
            Î∂ÑÏÑù Í≤∞Í≥º Ï†ÄÏû•
          <% end %>
        <% end %>
      <% else %>
        <%= link_to new_user_session_path, 
            class: "inline-flex items-center px-5 py-2.5 bg-emerald-500 text-white font-medium rounded-lg hover:bg-emerald-600 transition-colors" do %>
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
          </svg>
          Î°úÍ∑∏Ïù∏ÌïòÍ≥† Ï†ÄÏû•ÌïòÍ∏∞
        <% end %>
      <% end %>
      
      <button onclick="window.print()" class="inline-flex items-center px-5 py-2.5 bg-white text-gray-700 font-medium rounded-lg hover:bg-gray-50 transition-colors border border-gray-300">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
        </svg>
        PDFÎ°ú Ï†ÄÏû•
      </button>
    </div>
  </div>

  <!-- Main Content -->
  <div class="max-w-5xl mx-auto px-4 pb-20">
    
    <!-- Company Info Card -->
    <% if @cover_letter.company_name.present? || @cover_letter.position.present? %>
      <div class="bg-white rounded-lg border border-gray-100 p-6 mb-8">
        <div class="flex flex-wrap items-center justify-center gap-8">
          <% if @cover_letter.company_name.present? %>
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-emerald-100 rounded-full flex items-center justify-center">
                <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                </svg>
              </div>
              <div>
                <span class="text-sm text-gray-500 block">ÏßÄÏõê Í∏∞ÏóÖ</span>
                <strong class="text-lg text-gray-900"><%= @cover_letter.company_name %></strong>
              </div>
            </div>
          <% end %>
          <% if @cover_letter.position.present? %>
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-emerald-100 rounded-full flex items-center justify-center">
                <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                </svg>
              </div>
              <div>
                <span class="text-sm text-gray-500 block">ÏßÄÏõê ÏßÅÎ¨¥</span>
                <strong class="text-lg text-gray-900"><%= @cover_letter.position %></strong>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
    
    <!-- Resume Info Card (ÏÉàÎ°ú Ï∂îÍ∞Ä) -->
    <% if @cover_letter.resume_json.present? && @cover_letter.resume_json['sections'].present? %>
      <div class="bg-white rounded-lg border border-gray-100 mb-8">
        <div class="px-6 py-4 bg-gray-50 border-b border-gray-100">
          <h2 class="text-xl font-bold text-gray-900">
            üìÑ Ïù¥Î†•ÏÑú ÏöîÏïΩ
          </h2>
        </div>
        
        <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
          <% resume_sections = @cover_letter.resume_json['sections'] %>
          
          <!-- Í∞úÏù∏Ï†ïÎ≥¥ -->
          <% if resume_sections['personal_info'].present? %>
            <div class="space-y-2">
              <h3 class="font-semibold text-gray-700">Í∞úÏù∏Ï†ïÎ≥¥</h3>
              <div class="text-sm text-gray-600">
                <% info = resume_sections['personal_info'] %>
                <% if info['name'].present? %>
                  <p>Ïù¥Î¶Ñ: <%= info['name'] %></p>
                <% end %>
                <% if info['email'].present? %>
                  <p>Ïù¥Î©îÏùº: <%= info['email'] %></p>
                <% end %>
                <% if info['phone'].present? %>
                  <p>Ïó∞ÎùΩÏ≤ò: <%= info['phone'] %></p>
                <% end %>
              </div>
            </div>
          <% end %>
          
          <!-- ÌïôÎ†• -->
          <% if resume_sections['education'].present? && resume_sections['education'].any? %>
            <div class="space-y-2">
              <h3 class="font-semibold text-gray-700">ÌïôÎ†•</h3>
              <div class="text-sm text-gray-600">
                <% resume_sections['education'].each do |edu| %>
                  <p><%= edu['school'] %> <%= edu['major'] %></p>
                  <p class="text-xs text-gray-500"><%= edu['start_date'] %> ~ <%= edu['end_date'] %></p>
                <% end %>
              </div>
            </div>
          <% end %>
          
          <!-- Í≤ΩÎ†• -->
          <% if resume_sections['experience'].present? && resume_sections['experience'].any? %>
            <div class="space-y-2">
              <h3 class="font-semibold text-gray-700">Í≤ΩÎ†•ÏÇ¨Ìï≠</h3>
              <div class="text-sm text-gray-600">
                <% resume_sections['experience'].each do |exp| %>
                  <p><%= exp['company'] %></p>
                  <p class="text-xs text-gray-500"><%= exp['start_date'] %> ~ <%= exp['end_date'] %></p>
                <% end %>
              </div>
            </div>
          <% end %>
          
          <!-- Í∏∞Ïà†/Ïä§ÌÇ¨ -->
          <% if resume_sections['skills'].present? && resume_sections['skills'].any? %>
            <div class="space-y-2">
              <h3 class="font-semibold text-gray-700">Î≥¥Ïú† Í∏∞Ïà†</h3>
              <div class="flex flex-wrap gap-2">
                <% resume_sections['skills'].each do |skill| %>
                  <span class="px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded-md"><%= skill %></span>
                <% end %>
              </div>
            </div>
          <% end %>
          
          <!-- ÏûêÍ≤©Ï¶ù -->
          <% if resume_sections['certifications'].present? && resume_sections['certifications'].any? %>
            <div class="space-y-2">
              <h3 class="font-semibold text-gray-700">ÏûêÍ≤©Ï¶ù</h3>
              <div class="text-sm text-gray-600">
                <% resume_sections['certifications'].each do |cert| %>
                  <p><%= cert['name'] %> <%= cert['date'].present? ? "(#{cert['date']})" : "" %></p>
                <% end %>
              </div>
            </div>
          <% end %>
          
          <!-- Ïñ¥Ìïô -->
          <% if resume_sections['languages'].present? && resume_sections['languages'].any? %>
            <div class="space-y-2">
              <h3 class="font-semibold text-gray-700">Ïñ¥ÌïôÎä•Î†•</h3>
              <div class="text-sm text-gray-600">
                <% resume_sections['languages'].each do |lang| %>
                  <p><%= lang['name'] %>: <%= lang['score'] || lang['level'] %></p>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

    <!-- Analysis Results -->
    <div class="bg-white rounded-lg border border-gray-100 mb-8">
      <div class="px-6 py-4 bg-gray-50 border-b border-gray-100">
        <h2 class="text-xl font-bold text-gray-900">
          HR Ï†ÑÎ¨∏Í∞Ä Î∂ÑÏÑù Í≤∞Í≥º
        </h2>
      </div>
      
      <div class="p-6 lg:p-8">
        <% if @cover_letter.advanced_analysis_json.present? %>
          <!-- JSON Íµ¨Ï°∞ ÏÇ¨Ïö© (Ïã†Í∑ú) -->
          <% sections = @cover_letter.advanced_analysis_json['sections'] %>
          
          <div class="space-y-8">
            <% sections.each_with_index do |section, index| %>
              <!-- Î¶¨ÎùºÏù¥Ìä∏ ÌéòÏù¥ÏßÄÏôÄ ÎèôÏùºÌïú Ïä§ÌÉÄÏùº Ï†ÅÏö© -->
              <div class="bg-gray-50 rounded-lg p-6 border border-gray-100">
                <div class="flex items-start mb-4">
                  <div class="w-8 h-8 bg-emerald-100 rounded-full flex items-center justify-center font-semibold mr-3 flex-shrink-0 text-emerald-700">
                    <%= section['number'] %>
                  </div>
                  <h3 class="text-lg font-bold text-gray-900 pt-1">
                    <%= section['title'] %>
                  </h3>
                </div>
                
                <div class="pl-11 space-y-4">
                  <% if section['content'].present? && !section['content'].blank? %>
                    <% if section['number'].to_i == 1 || section['number'].to_i == 5 %>
                      <!-- Ï≤´Ïù∏ÏÉÅÍ≥º Í≤©Î†§ Î©îÏãúÏßÄÎäî Î¨∏Îã®Î≥ÑÎ°ú ÌëúÏãú -->
                      <div class="text-gray-700 leading-relaxed text-base lg:text-lg space-y-4">
                        <% 
                          # ÎÇ¥Ïö©ÏùÑ Îã®ÎùΩÎ≥ÑÎ°ú Î∂ÑÎ¶¨
                          # ÏÑπÏÖò 5Ïùò Í≤ΩÏö∞ Ï∂îÍ∞Ä Ï†ïÎ¶¨
                          content = section['content']
                          if section['number'].to_i == 5
                            # JSON Í¥ÄÎ†® ÌÖçÏä§Ìä∏ Ï†úÍ±∞
                            content = content.sub(/\s*items:\s*\[\].*/m, '')
                            content = content.sub(/\s*analyzed_at:.*/m, '')
                            # Ï§ëÎ≥µÎêú ÏöîÏïΩ Ï†úÍ±∞
                            content = content.sub(/Ï¢ÖÌï©Ï†ÅÏúºÎ°ú\s+Î≥º\s+Îïå.*/m, '')
                          end
                          paragraphs = content.split(/\n\n+/)
                        %>
                        <% paragraphs.each do |paragraph| %>
                          <% next if paragraph.strip.empty? %>
                          <% next if paragraph.include?('items:') || paragraph.include?('analyzed_at:') %>
                          <p class="text-gray-700">
                            <%= paragraph.strip %>
                          </p>
                        <% end %>
                      </div>
                    <% end %>
                  <% end %>
                  
                  <% if section['items'].present? && section['items'].any? %>
                    <!-- Í∞ïÏ†ê, Í∞úÏÑ†Ï†ê, Î≥¥ÏÑù Ìï≠Î™©Îì§ -->
                    <div class="space-y-8">
                      <% section['items'].each_with_index do |item, item_index| %>
                        <div class="bg-white p-5 rounded-lg border border-gray-100">
                          <% if item['title'].present? && !item['title'].blank? %>
                            <h4 class="text-lg font-semibold text-emerald-600 mb-4">
                              <%= "#{section['title'].include?('Í∞ïÏ†ê') ? 'Í∞ïÏ†ê' : section['title'].include?('Í∞úÏÑ†') ? 'Í∞úÏÑ†Ï†ê' : 'Î≥¥ÏÑù'} #{item['number'] || (item_index + 1)}: #{item['title']}" %>
                            </h4>
                          <% else %>
                            <h4 class="text-lg font-semibold text-emerald-600 mb-4">
                              <%= "#{section['title'].include?('Í∞ïÏ†ê') ? 'Í∞ïÏ†ê' : section['title'].include?('Í∞úÏÑ†') ? 'Í∞úÏÑ†Ï†ê' : 'Î≥¥ÏÑù'} #{item['number'] || (item_index + 1)}" %>
                            </h4>
                          <% end %>
                          
                          <div class="text-gray-700 leading-relaxed text-base lg:text-lg space-y-4">
                            <% 
                              # Ïª®ÌÖêÏ∏†Î•º Î¨∏Îã®Î≥ÑÎ°ú Ï≤òÎ¶¨
                              content_text = item['content'] || ''
                              paragraphs = content_text.split(/\n\n+/)
                            %>
                            <% paragraphs.each do |paragraph| %>
                              <% next if paragraph.strip.empty? %>
                              <p class="text-gray-700">
                                <%= paragraph.strip %>
                              </p>
                            <% end %>
                          </div>
                        </div>
                      <% end %>
                    </div>
                  <% elsif section['content'].present? && section['number'].to_i > 1 && section['number'].to_i < 5 %>
                    <!-- Í∞ïÏ†ê, Í∞úÏÑ†Ï†ê, Î≥¥ÏÑù ÏÑπÏÖòÏù∏Îç∞ itemsÍ∞Ä ÏóÜÎäî Í≤ΩÏö∞ Ï†ÑÏ≤¥ content ÌëúÏãú -->
                    <div class="text-gray-700 leading-relaxed text-base lg:text-lg">
                      <% 
                        # ÎÇ¥Ïö©ÏùÑ Îã®ÎùΩÎ≥ÑÎ°ú Î∂ÑÎ¶¨
                        paragraphs = section['content'].split(/\n\n+/)
                      %>
                      <% paragraphs.each do |paragraph| %>
                        <% next if paragraph.strip.empty? %>
                        
                        <% # Î≤àÌò∏Í∞Ä ÏûàÎäî Ìï≠Î™©Ïù∏ÏßÄ ÌôïÏù∏ %>
                        <% if paragraph =~ /^(\d+)[.)\s]|^(Í∞ïÏ†ê|Í∞úÏÑ†Ï†ê|Î≥¥ÏÑù)\s*(\d+)[:.\s]/ %>
                          <div class="mb-6">
                            <p class="text-gray-700 leading-relaxed">
                              <%= paragraph.strip %>
                            </p>
                          </div>
                        <% else %>
                          <p class="mb-4 last:mb-0">
                            <%= paragraph.strip %>
                          </p>
                        <% end %>
                      <% end %>
                    </div>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
          
        <% elsif @cover_letter.analysis_result.present? || @cover_letter.advanced_analysis.present? %>
          <!-- ÌÖçÏä§Ìä∏ ÌååÏã± ÏÇ¨Ïö© (Í∏∞Ï°¥ Ìò∏ÌôòÏÑ±) -->
          <% analysis_content = @cover_letter.advanced_analysis.present? ? @cover_letter.advanced_analysis : @cover_letter.analysis_result %>
          <% sections = parse_analysis_sections(analysis_content) %>
          
          <div class="space-y-8">
            <% if sections.is_a?(Array) %>
              <% sections.each do |section| %>
                <div class="bg-gray-50 rounded-lg p-6 border border-gray-100">
                  <div class="flex items-start mb-4">
                    <div class="w-8 h-8 bg-emerald-100 rounded-full flex items-center justify-center font-semibold mr-3 flex-shrink-0 text-emerald-700">
                      <%= section[:number] %>
                    </div>
                    <h3 class="text-lg font-bold text-gray-900 pt-1">
                      <%= section[:title] %>
                    </h3>
                  </div>
                  
                  <div class="pl-11 space-y-4">
                    <% 
                      # ÏÑπÏÖò Î≤àÌò∏Ïóê Îî∞Îùº Îã§Î•¥Í≤å Ï≤òÎ¶¨
                      section_num = section[:number].to_i
                    %>
                    
                    <% if section_num == 1 || section_num == 5 %>
                      <!-- Ï≤´Ïù∏ÏÉÅÍ≥º Í≤©Î†§ Î©îÏãúÏßÄÎäî Î¨∏Îã®Î≥ÑÎ°ú ÌëúÏãú -->
                      <div class="text-gray-700 leading-relaxed text-base lg:text-lg space-y-4">
                        <% 
                          # ÎÇ¥Ïö©ÏùÑ Îã®ÎùΩÎ≥ÑÎ°ú Î∂ÑÎ¶¨
                          paragraphs = section[:content].split(/\n\n+/)
                        %>
                        <% paragraphs.each do |paragraph| %>
                          <% next if paragraph.strip.empty? %>
                          <p class="text-gray-700">
                            <%= paragraph.strip %>
                          </p>
                        <% end %>
                      </div>
                    <% elsif section_num >= 2 && section_num <= 4 %>
                      <!-- Í∞ïÏ†ê, Í∞úÏÑ†Ï†ê, Î≥¥ÏÑù ÏÑπÏÖò -->
                      <% 
                        content = section[:content]
                        # Î≤àÌò∏Í∞Ä ÏûàÎäî Ìï≠Î™© Ï∞æÍ∏∞
                        item_pattern = /(?:^|\n)((?:Í∞ïÏ†ê|Í∞úÏÑ†Ï†ê|Î≥¥ÏÑù)\s*\d+[:.]\s*[^\n]+)\n?((?:(?!(?:Í∞ïÏ†ê|Í∞úÏÑ†Ï†ê|Î≥¥ÏÑù)\s*\d+)[\s\S])*)/m
                        numbered_pattern = /(?:^|\n)(\d+[.)]\s*[^\n]*)\n?((?:(?!\d+[.)])[\s\S])*)/m
                        
                        items = []
                        
                        # Î®ºÏ†Ä Î™ÖÏãúÏ†ÅÏù∏ Ìå®ÌÑ¥ ÏãúÎèÑ
                        if content =~ item_pattern
                          content.scan(item_pattern) do |title, body|
                            items << { title: title.strip, content: body.strip }
                          end
                        elsif content =~ numbered_pattern
                          content.scan(numbered_pattern) do |title, body|
                            items << { title: title.strip, content: body.strip }
                          end
                        end
                      %>
                      
                      <% if items.any? %>
                        <div class="space-y-8">
                          <% items.each_with_index do |item, index| %>
                            <div class="bg-white p-5 rounded-lg border border-gray-100">
                              <h4 class="text-lg font-semibold text-emerald-600 mb-4">
                                <%= item[:title] %>
                              </h4>
                              <div class="text-gray-700 leading-relaxed text-base lg:text-lg space-y-4">
                                <% 
                                  # Ïª®ÌÖêÏ∏†Î•º Î¨∏Îã®Î≥ÑÎ°ú Ï≤òÎ¶¨
                                  paragraphs = item[:content].split(/\n\n+/)
                                %>
                                <% paragraphs.each do |paragraph| %>
                                  <% next if paragraph.strip.empty? %>
                                  <p class="text-gray-700">
                                    <%= paragraph.strip %>
                                  </p>
                                <% end %>
                              </div>
                            </div>
                          <% end %>
                        </div>
                      <% else %>
                        <!-- Ìå®ÌÑ¥ÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏúºÎ©¥ Ï†ÑÏ≤¥ ÌÖçÏä§Ìä∏ ÌëúÏãú -->
                        <div class="text-gray-700 leading-relaxed text-base lg:text-lg">
                          <%= simple_format(section[:content], class: "whitespace-pre-wrap") %>
                        </div>
                      <% end %>
                    <% else %>
                      <!-- Í∏∞ÌÉÄ ÏÑπÏÖò -->
                      <div class="text-gray-700 leading-relaxed text-base lg:text-lg">
                        <%= simple_format(section[:content], class: "whitespace-pre-wrap") %>
                      </div>
                    <% end %>
                  </div>
                </div>
              <% end %>
            <% else %>
              <!-- Fallback for the entire content if sections couldn't be parsed -->
              <div class="text-gray-700 leading-relaxed">
                <%= simple_format(analysis_content, class: "whitespace-pre-wrap") %>
              </div>
            <% end %>
          </div>
        <% else %>
          <div class="text-center py-12">
            <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg class="w-8 h-8 text-gray-400 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
            </div>
            <p class="text-gray-500">Î∂ÑÏÑù Í≤∞Í≥ºÎ•º Ï§ÄÎπÑ Ï§ëÏûÖÎãàÎã§...</p>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Next Steps -->
    <div class="bg-gray-50 rounded-lg border border-gray-100 p-8 text-center">
      <h3 class="text-xl font-bold text-gray-900 mb-2">Îã§Ïùå Îã®Í≥Ñ</h3>
      <p class="text-gray-600 mb-6">
        Î∂ÑÏÑù Í≤∞Í≥ºÎ•º Î∞îÌÉïÏúºÎ°ú ÏûêÏÜåÏÑúÎ•º Í∞úÏÑ†Ìï¥Î≥¥ÏÑ∏Ïöî
      </p>
      <div class="flex flex-col sm:flex-row gap-3 justify-center">
        <% if @cover_letter.improved_letter.present? %>
          <%= link_to rewrite_result_cover_letter_path(@cover_letter), 
              class: "inline-flex items-center justify-center px-6 py-3 bg-emerald-500 text-white font-semibold rounded-lg hover:bg-emerald-600 transition-colors shadow-sm" do %>
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            Î¶¨ÎùºÏù¥Ìä∏ Í≤∞Í≥º Î≥¥Í∏∞
          <% end %>
        <% else %>
          <!-- Î¶¨ÎùºÏù¥Ìä∏ ÏòµÏÖò ÏÑ†ÌÉù ÎìúÎ°≠Îã§Ïö¥ -->
          <div class="relative inline-block" x-data="{ open: false }">
            <button @click="open = !open" 
                    @click.away="open = false"
                    class="inline-flex items-center justify-center px-6 py-3 bg-emerald-500 text-white font-semibold rounded-lg hover:bg-emerald-600 transition-colors shadow-sm">
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
              </svg>
              ÌîºÎìúÎ∞± Î∞òÏòÅÌïòÏó¨ Î¶¨ÎùºÏù¥Ìä∏
              <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            
            <!-- ÎìúÎ°≠Îã§Ïö¥ Î©îÎâ¥ -->
            <div x-show="open" 
                 x-transition:enter="transition ease-out duration-100"
                 x-transition:enter-start="transform opacity-0 scale-95"
                 x-transition:enter-end="transform opacity-100 scale-100"
                 x-transition:leave="transition ease-in duration-75"
                 x-transition:leave-start="transform opacity-100 scale-100"
                 x-transition:leave-end="transform opacity-0 scale-95"
                 class="absolute z-10 mt-2 w-72 rounded-lg bg-white shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none">
              <div class="py-1">
                <%= button_to rewrite_with_feedback_cover_letter_path(@cover_letter), 
                    method: :post,
                    params: { rewrite_mode: 'preserve' },
                    class: "w-full text-left px-4 py-3 hover:bg-gray-50 transition-colors" do %>
                  <div class="flex items-start">
                    <div class="flex-shrink-0 mt-0.5">
                      <div class="w-6 h-6 bg-emerald-100 rounded-full flex items-center justify-center">
                        <span class="text-xs font-bold text-emerald-600">1</span>
                      </div>
                    </div>
                    <div class="ml-3">
                      <p class="font-semibold text-gray-900">ÏõêÎ¨∏ Ïä§ÌÉÄÏùº Ïú†ÏßÄ</p>
                      <p class="text-sm text-gray-500 mt-1">ÌòÑÏû¨ Î¨∏Ï≤¥ÏôÄ Ïñ¥Ï°∞Î•º ÏµúÎåÄÌïú Î≥¥Ï°¥ÌïòÎ©¥ÏÑú Í∞úÏÑ†</p>
                    </div>
                  </div>
                <% end %>
                
                <%= button_to rewrite_with_feedback_cover_letter_path(@cover_letter), 
                    method: :post,
                    params: { rewrite_mode: 'optimize' },
                    class: "w-full text-left px-4 py-3 hover:bg-gray-50 transition-colors" do %>
                  <div class="flex items-start">
                    <div class="flex-shrink-0 mt-0.5">
                      <div class="w-6 h-6 bg-blue-100 rounded-full flex items-center justify-center">
                        <span class="text-xs font-bold text-blue-600">2</span>
                      </div>
                    </div>
                    <div class="ml-3">
                      <p class="font-semibold text-gray-900">ÏûêÏó∞Ïä§ÎüΩÍ≤å Îã§Îì¨Í∏∞</p>
                      <p class="text-sm text-gray-500 mt-1">AI Ìã∞ Ï†úÍ±∞ÌïòÍ≥† ÏùΩÍ∏∞ Ìé∏ÌïòÍ≤å ÏµúÏ†ÅÌôî</p>
                    </div>
                  </div>
                <% end %>
                
                <%= button_to rewrite_with_feedback_cover_letter_path(@cover_letter), 
                    method: :post,
                    params: { rewrite_mode: 'recreate' },
                    class: "w-full text-left px-4 py-3 hover:bg-gray-50 transition-colors rounded-b-lg" do %>
                  <div class="flex items-start">
                    <div class="flex-shrink-0 mt-0.5">
                      <div class="w-6 h-6 bg-purple-100 rounded-full flex items-center justify-center">
                        <span class="text-xs font-bold text-purple-600">3</span>
                      </div>
                    </div>
                    <div class="ml-3">
                      <p class="font-semibold text-gray-900">Ï†ÑÏ≤¥ Ïû¨ÏûëÏÑ±</p>
                      <p class="text-sm text-gray-500 mt-1">ÌîºÎìúÎ∞± Î∞òÏòÅÌïòÏó¨ ÏôÑÏ†ÑÌûà ÏÉàÎ°ú ÏûëÏÑ±</p>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
        
        <%= link_to advanced_cover_letters_path, 
            class: "px-6 py-3 bg-white text-gray-700 font-medium rounded-lg hover:bg-gray-50 transition-colors border border-gray-300" do %>
          ÏÉàÎ°úÏö¥ ÏûêÏÜåÏÑú Î∂ÑÏÑùÌïòÍ∏∞
        <% end %>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>

<style>
  @media print {
    nav, header, button, .no-print { display: none !important; }
    .bg-gradient-to-b { background: white !important; }
    .shadow-sm { box-shadow: none !important; }
    @page { margin: 1.5cm; size: A4; }
  }
</style>