require 'net/http'
require 'json'
require 'open3'

class AdvancedCoverLetterService
  OPENAI_API_URL = 'https://api.openai.com/v1/chat/completions'
  
  def initialize
    @api_key = ENV['OPENAI_API_KEY']
    @model = ENV['OPENAI_MODEL'] || 'gpt-4.1'
  end
  
  # PUBLIC ë©”ì„œë“œ: ì‹¤ì‹œê°„ ì§„í–‰ ìƒí™©ê³¼ í•¨ê»˜ í•˜ì´ë¸Œë¦¬ë“œ ë¶„ì„ (ë³‘ë ¬+ìˆœì°¨)
  def analyze_cover_letter_with_progress(content, cover_letter_id)
    Rails.logger.info "=== ì‹¤ì‹œê°„ ì§„í–‰ ìƒí™© ë¶„ì„ ì‹œì‘ ==="
    
    broadcaster = ProgressBroadcaster.new(cover_letter_id)
    results = {}
    errors = []
    
    begin
      # ë¶„ì„ ì‹œì‘ ì•Œë¦¼
      broadcaster.broadcast_start
      
      # 1. ì²«ì¸ìƒ ë¶„ì„
      broadcaster.broadcast_step_start(:first_impression)
      results[:first_impression] = analyze_first_impression(content)
      broadcaster.broadcast_step_complete(:first_impression)
      
      # 2. ê°•ì  ë¶„ì„
      broadcaster.broadcast_step_start(:strengths)
      results[:strengths] = analyze_strengths(content)
      broadcaster.broadcast_step_complete(:strengths, 
        { items: results[:strengths].scan(/\*\*ê°•ì /).size }
      )
      
      # 3. ê°œì„ ì  ë¶„ì„
      broadcaster.broadcast_step_start(:improvements)
      results[:improvements] = analyze_improvements(content)
      broadcaster.broadcast_step_complete(:improvements,
        { items: results[:improvements].scan(/\*\*ê°œì„ /).size }
      )
      
      # 4. ìˆ¨ì€ ë³´ì„ ë°œêµ´
      broadcaster.broadcast_step_start(:hidden_gems)
      results[:hidden_gems] = analyze_hidden_gems(content)
      broadcaster.broadcast_step_complete(:hidden_gems,
        { items: 3 }
      )
      
      # 5. ê²©ë ¤ ë©”ì‹œì§€
      broadcaster.broadcast_step_start(:encouragement)
      results[:encouragement] = generate_encouragement(content)
      broadcaster.broadcast_step_complete(:encouragement)
      
      # ë¶„ì„ ì™„ë£Œ - JSON êµ¬ì¡°ë¡œ ìƒì„±
      json_result = combine_analysis_results_to_json(results)
      text_result = combine_analysis_results(results)
      
      broadcaster.broadcast_complete(text_result)
      
      {
        text: text_result,
        json: json_result
      }
      
    rescue => e
      Rails.logger.error "Analysis with progress failed: #{e.message}"
      broadcaster.broadcast_error("ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: #{e.message}")
      raise
    end
  end
  
  # Python NLP ë¶„ì„ ìˆ˜í–‰
  def analyze_with_python(content, company_name = nil, position = nil)
    script_path = Rails.root.join('python_analysis', 'advanced_analyzer.py')
    
    input_data = {
      text: content,
      company: company_name,
      position: position
    }.to_json
    
    stdout, stderr, status = Open3.capture3(
      'python3', script_path.to_s,
      stdin_data: input_data
    )
    
    if status.success?
      begin
        JSON.parse(stdout)
      rescue JSON::ParserError => e
        Rails.logger.error "Python ë¶„ì„ ê²°ê³¼ íŒŒì‹± ì˜¤ë¥˜: #{e.message}"
        { error: "ë¶„ì„ ê²°ê³¼ ì²˜ë¦¬ ì˜¤ë¥˜" }
      end
    else
      Rails.logger.error "Python ë¶„ì„ ì‹¤í–‰ ì˜¤ë¥˜: #{stderr}"
      { error: "Python ë¶„ì„ ì‹¤í–‰ ì‹¤íŒ¨" }
    end
  rescue StandardError => e
    Rails.logger.error "Python ë¶„ì„ ì˜¤ë¥˜: #{e.message}"
    { error: "ë¶„ì„ ì‹œìŠ¤í…œ ì˜¤ë¥˜" }
  end
  
  # ìì†Œì„œ ë¶„ì„ë§Œ ìˆ˜í–‰ (ê¸°ì—… ë¶„ì„ ì œì™¸)
  def analyze_cover_letter_only(content)
    return { error: "API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤" } unless @api_key
    
    # 2ë‹¨ê³„ ìê¸°ì†Œê°œì„œ ë¶„ì„ë§Œ ì‹¤í–‰
    cover_letter_analysis = analyze_cover_letter(content)
    
    {
      success: true,
      analysis: cover_letter_analysis,
      full_analysis: format_cover_letter_analysis(cover_letter_analysis)
    }
  rescue StandardError => e
    Rails.logger.error "ìì†Œì„œ ë¶„ì„ ì˜¤ë¥˜: #{e.message}"
    { error: "ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: #{e.message}" }
  end
  
  # Python í’ˆì§ˆ í–¥ìƒì„ í¬í•¨í•œ ë¦¬ë¼ì´íŠ¸
  def rewrite_with_python_enhancement(content, feedback_analysis, company_name = nil, position = nil, rewrite_mode = 'preserve')
    Rails.logger.info "=== ìµœì í™”ëœ ë¦¬ë¼ì´íŠ¸ ì‹œì‘ (GPT â†’ Python í›„ì²˜ë¦¬) ==="
    Rails.logger.info "ë¦¬ë¼ì´íŠ¸ ëª¨ë“œ: #{rewrite_mode}"
    
    # 1ë‹¨ê³„: GPTë¡œ ê³ í’ˆì§ˆ ë¦¬ë¼ì´íŠ¸ ìƒì„± (rewrite_mode ì „ë‹¬)
    basic_result = rewrite_with_feedback_only(content, feedback_analysis, company_name, position, rewrite_mode)
    
    unless basic_result[:success]
      return basic_result
    end
    
    # 2ë‹¨ê³„: Pythonìœ¼ë¡œ í’ˆì§ˆ ë¶„ì„ ë° ë¯¸ì„¸ ì¡°ì •
    python_service = PythonAnalysisService.new
    
    # ë¶„ì„ë§Œ ìˆ˜í–‰ (í…ìŠ¤íŠ¸ ë³´ì¡´)
    analysis_result = python_service.analyze_text_quality(
      basic_result[:rewritten_letter],
      company_name
    )
    
    # 3ë‹¨ê³„: Python ë¶„ì„ ê¸°ë°˜ ì„ íƒì  í–¥ìƒ
    if analysis_result[:success]
      enhanced_text = basic_result[:rewritten_letter]
      
      # AI íŒ¨í„´ë§Œ ì œê±° (êµ¬ì¡°ëŠ” ìœ ì§€)
      if analysis_result[:data]["ai_patterns_detected"] && analysis_result[:data]["ai_patterns_detected"] > 0
        enhanced_text = python_service.remove_ai_patterns_only(enhanced_text)[:data]["text"] rescue enhanced_text
      end
      
      # ë©”íŠ¸ë¦­ìŠ¤ì™€ í•¨ê»˜ ë°˜í™˜
      {
        success: true,
        rewritten_letter: enhanced_text,
        original_rewrite: basic_result[:rewritten_letter],
        metrics: analysis_result[:data]["improvements"],
        before_metrics: analysis_result[:data]["before_metrics"],
        after_metrics: analysis_result[:data]["after_metrics"],
        suggestions: analysis_result[:data]["suggestions"],
        optimization_type: "hybrid_gpt_python"
      }
    else
      # Python ë¶„ì„ ì‹¤íŒ¨ì‹œì—ë„ GPT ê²°ê³¼ëŠ” ë³´ì¡´
      Rails.logger.warn "Python ë¶„ì„ ì‹¤íŒ¨, GPT ë¦¬ë¼ì´íŠ¸ë§Œ ì‚¬ìš©: #{analysis_result[:error]}"
      basic_result.merge(optimization_type: "gpt_only")
    end
  rescue => e
    Rails.logger.error "ìµœì í™” ì˜¤ë¥˜: #{e.message}"
    basic_result || { success: false, error: e.message }
  end
  
  # í”¼ë“œë°± ê¸°ë°˜ ìì†Œì„œ ë¦¬ë¼ì´íŠ¸ (ê¸°ì—… ë¶„ì„ ì œì™¸)
  def rewrite_with_feedback_only(content, feedback_analysis, company_name = nil, position = nil, rewrite_mode = 'preserve')
    return { error: "API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤" } unless @api_key
    
    # 3ë‹¨ê³„: í”¼ë“œë°± ê¸°ë°˜ ë§ì¶¤í˜• ìê¸°ì†Œê°œì„œ ìƒì„±
    rewritten_letter = generate_improved_letter(
      content,
      feedback_analysis,
      company_name,
      position,
      rewrite_mode
    )
    
    {
      success: true,
      rewritten_letter: rewritten_letter
    }
  rescue StandardError => e
    Rails.logger.error "ë¦¬ë¼ì´íŠ¸ ì˜¤ë¥˜: #{e.message}"
    { error: "ë¦¬ë¼ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: #{e.message}" }
  end
  
  # ê¸°ì¡´ ë©”ì„œë“œ (í•˜ìœ„ í˜¸í™˜ì„± ìœ ì§€)
  def analyze_complete(content, company_name, position)
    return { error: "API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤" } unless @api_key
    
    # Python NLP ë¶„ì„ ìˆ˜í–‰
    python_analysis = analyze_with_python(content, company_name, position)
    
    # 1ë‹¨ê³„: ê¸°ì—… ë¶„ì„ (ì„ íƒì  - í˜„ì¬ëŠ” ìŠ¤í‚µ)
    # company_analysis = analyze_company(company_name)
    
    # 2ë‹¨ê³„: ìê¸°ì†Œê°œì„œ ë¶„ì„
    cover_letter_analysis = analyze_cover_letter(content)
    
    # 3ë‹¨ê³„: í”¼ë“œë°± ê¸°ë°˜ ë§ì¶¤í˜• ìê¸°ì†Œê°œì„œ ìƒì„±
    customized_letter = generate_improved_letter(
      content,
      cover_letter_analysis,
      company_name,
      position
    )
    
    {
      success: true,
      cover_letter_analysis: cover_letter_analysis,
      customized_letter: customized_letter,
      python_analysis: python_analysis,
      full_analysis: format_full_analysis_simple(cover_letter_analysis, customized_letter)
    }
  rescue StandardError => e
    Rails.logger.error "ê³ ê¸‰ ë¶„ì„ ì˜¤ë¥˜: #{e.message}"
    { error: "ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: #{e.message}" }
  end
  
  # ê°œë³„ ë¶„ì„ ë©”ì„œë“œë“¤ (OptimizedAnalysisServiceì—ì„œ ì‚¬ìš©)
  def analyze_first_impression(content)
    return [] unless content.present?
    
    # ìˆ«ì. í˜•ì‹ì˜ í•­ëª© ì°¾ê¸° (ì˜ˆ: "1. ì§€ì› ë™ê¸°", "2. ì„±ì¥ ê³¼ì •")
    sections = content.scan(/^\d+\.\s*([^\n]+)/).flatten
    
    # ì •ë¦¬ ë° ì •ê·œí™”
    sections.map do |section|
      section.strip.gsub(/\[.*?\]/, '').strip # ëŒ€ê´„í˜¸ ì•ˆì˜ ë¶€ì œëª© ì œê±°
    end.reject(&:empty?)
  end
  
  def analyze_company(company_name)
    prompt = <<~PROMPT
      ë‹¹ì‹ ì€ ê¸°ì—… ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. #{company_name}ì— ëŒ€í•´ ë‹¤ìŒì„ ë¶„ì„í•´ì£¼ì„¸ìš”:

      **ë¶„ì„ í•­ëª©:**
      1. ê¸°ì—…ì˜ í•µì‹¬ ì‚¬ì—… ë¶„ì•¼ì™€ ë¹„ì „
      2. ìµœê·¼ 1ë…„ê°„ ì£¼ìš” ì´ìŠˆ ë° í˜„ì•ˆ (ê²½ì˜ì§„ ë°œì–¸, ì‹ ì‚¬ì—…, ìœ„ê¸°ìƒí™© ë“±)
      3. ì—…ê³„ ë‚´ í¬ì§€ì…˜ê³¼ ê²½ìŸìš°ìœ„
      4. ê¸°ì—…ì´ ì¶”êµ¬í•˜ëŠ” ì¸ì¬ìƒê³¼ í•µì‹¬ ì—­ëŸ‰
      5. ì¡°ì§ë¬¸í™”ì™€ ê°€ì¹˜ê´€

      **ì¶œë ¥ í˜•ì‹:**
      ## ğŸ¢ #{company_name} ë¶„ì„ ë¦¬í¬íŠ¸
      **í•µì‹¬ ì‚¬ì—…:** [ê°„ë‹¨ ì„¤ëª…]
      **ìµœê·¼ í˜„ì•ˆ:** [3-5ê°œ ì£¼ìš” ì´ìŠˆ]
      **ì¸ì¬ìƒ:** [ì›í•˜ëŠ” ì¸ì¬ ìœ í˜•]
      **í‚¤ì›Œë“œ:** [í•µì‹¬ í‚¤ì›Œë“œ 5ê°œ]
      
      í•œêµ­ ê¸°ì—…ì˜ ìµœì‹  ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ êµ¬ì²´ì ìœ¼ë¡œ ë¶„ì„í•´ì£¼ì„¸ìš”.
    PROMPT
    
    response = make_api_request(prompt, "ê¸°ì—… ë¶„ì„ ì „ë¬¸ê°€")
    parse_response(response)[:content]
  end
  
  # ë³‘ë ¬ì²˜ë¦¬ë¥¼ ìœ„í•œ ê°œë³„ ì„¹ì…˜ ë¶„ì„ ë©”ì„œë“œë“¤
  def analyze_first_impression(content)
    prompt = <<~PROMPT
      ë‹¹ì‹ ì€ ëŒ€ê¸°ì—… ì¸ì‚¬íŒ€ì—ì„œ 15ë…„ê°„ ê·¼ë¬´í•˜ë©° ë‹¤ìˆ˜ì˜ ë©´ì ‘ê´€ ê²½í—˜ì„ ê°€ì§„ ì„ ë°° ì¸ì‚¬ë‹´ë‹¹ìì…ë‹ˆë‹¤.
      
      ìê¸°ì†Œê°œì„œë¥¼ ì²˜ìŒ ì½ì€ HR ë‹´ë‹¹ìê°€ ëŠë‚€ ì§ì„¤ì  ì¸ìƒì„ ì„œìˆ í•´ì£¼ì„¸ìš”. 
      ê¸€ì˜ íë¦„, ë…¼ë¦¬ì„±, ì§„ì •ì„±, ì„¤ë“ë ¥ì— ëŒ€í•œ ì¢…í•© í‰ê°€ë¥¼ ìµœì†Œ 3-4ë¬¸ë‹¨ ì´ìƒìœ¼ë¡œ ì‘ì„±í•˜ë˜, 
      HR í˜„ì¥ì˜ ìƒìƒí•œ ì‹œê°ì„ ë°˜ì˜í•´ì£¼ì„¸ìš”.
      
      "ì²« ë¬¸ë‹¨ì„ ì½ìë§ˆì...", "15ë…„ê°„ ìˆ˜ë§ì€ ìì†Œì„œë¥¼ ì½ì–´ì™”ì§€ë§Œ..." ê°™ì€ 
      ì‹¤ì œ ê²½í—˜ì´ ë‹´ê¸´ í‘œí˜„ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.
      
      ìê¸°ì†Œê°œì„œ:
      #{content}
    PROMPT
    
    response = make_api_request(prompt, "HR 15ë…„ì°¨ ì„ ë°°", 2000)
    parse_response(response)[:content]
  end
  
  def analyze_strengths(content)
    prompt = <<~PROMPT
      ë‹¹ì‹ ì€ ëŒ€ê¸°ì—… ì¸ì‚¬íŒ€ì—ì„œ 15ë…„ê°„ ê·¼ë¬´í•œ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
      
      ìê¸°ì†Œê°œì„œì˜ ì˜ ì“´ ë¶€ë¶„ Top 5ë¥¼ ë¶„ì„í•´ì£¼ì„¸ìš”.
      ê° ê°•ì ë§ˆë‹¤ ìµœì†Œ 3-4ë¬¸ë‹¨, ê° ë¬¸ë‹¨ì€ 4-5ë¬¸ì¥ ì´ìƒìœ¼ë¡œ ê¹Šì´ ìˆê²Œ ì‘ì„±í•˜ì„¸ìš”.
      
      êµ¬ì¡°:
      1. ìì†Œì„œ ë‚´ìš© ì¸ìš©ê³¼ ì²«ì¸ìƒ
      2. HR ê´€ì ì—ì„œ ì™œ ì¢‹ì€ì§€
      3. ì°¨ë³„í™” í¬ì¸íŠ¸ì™€ ì‹¤ë¬´ ì—°ê²°
      4. ë©´ì ‘ í™œìš© ì „ëµ
      
      ì‹¤ì œ ì±„ìš© ì‚¬ë¡€, ë©´ì ‘ ê²½í—˜ ë“±ì„ í¬í•¨í•´ ìƒìƒí•˜ê²Œ ì‘ì„±í•´ì£¼ì„¸ìš”.
      
      ìê¸°ì†Œê°œì„œ:
      #{content}
    PROMPT
    
    response = make_api_request(prompt, "ê°•ì  ë¶„ì„ ì „ë¬¸ê°€", 3000)
    parse_response(response)[:content]
  end
  
  def analyze_improvements(content)
    prompt = <<~PROMPT
      ë‹¹ì‹ ì€ ëŒ€ê¸°ì—… ì¸ì‚¬íŒ€ì—ì„œ 15ë…„ê°„ ê·¼ë¬´í•œ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
      
      ìê¸°ì†Œê°œì„œì˜ ì•„ì‰¬ìš´ ë¶€ë¶„ Top 5ë¥¼ ë¶„ì„í•´ì£¼ì„¸ìš”.
      ê° ê°œì„ ì ë§ˆë‹¤ ìµœì†Œ 3-4ë¬¸ë‹¨, ê° ë¬¸ë‹¨ì€ 4-5ë¬¸ì¥ ì´ìƒìœ¼ë¡œ ìƒì„¸í•˜ê²Œ ì‘ì„±í•˜ì„¸ìš”.
      
      êµ¬ì¡°:
      1. ë¬¸ì œì  ì§€ì ê³¼ ì‹¤ì œ ì¸ìš©
      2. ì™œ ì´ê²ƒì´ ì¹˜ëª…ì ì¸ì§€ ì‹¤ì œ ì‚¬ë¡€ë¡œ ì„¤ëª…
      3. êµ¬ì²´ì ì¸ ê°œì„  ë°©í–¥ê³¼ ì˜ˆì‹œ ë¬¸ì¥
      4. ê²©ë ¤ì™€ ì‹¤í–‰ ê°€ëŠ¥í•œ ì¡°ì–¸
      
      "ì‘ë…„ ì±„ìš©ì—ì„œ...", "ì‹¤ì œë¡œ ì´ëŸ° ì§€ì›ìê°€..." ê°™ì€ ê²½í—˜ì„ í¬í•¨í•´ì£¼ì„¸ìš”.
      
      ìê¸°ì†Œê°œì„œ:
      #{content}
    PROMPT
    
    response = make_api_request(prompt, "ê°œì„ ì  ë¶„ì„ ì „ë¬¸ê°€", 3000)
    parse_response(response)[:content]
  end
  
  def analyze_hidden_gems(content)
    prompt = <<~PROMPT
      ë‹¹ì‹ ì€ ëŒ€ê¸°ì—… ì¸ì‚¬íŒ€ì—ì„œ 15ë…„ê°„ ê·¼ë¬´í•œ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
      
      ìê¸°ì†Œê°œì„œì—ì„œ ë†“ì¹˜ê³  ìˆëŠ” ìˆ¨ì€ ë³´ì„ 3ê°€ì§€ë¥¼ ë°œêµ´í•´ì£¼ì„¸ìš”.
      ê° í•­ëª©ë§ˆë‹¤ ìµœì†Œ 2-3ë¬¸ë‹¨, ê° ë¬¸ë‹¨ì€ 4-5ë¬¸ì¥ ì´ìƒìœ¼ë¡œ ê¹Šì´ ìˆê²Œ ì‘ì„±í•˜ì„¸ìš”.
      
      êµ¬ì¡°:
      1. ë°œê²¬ì˜ ìˆœê°„ê³¼ ë†€ë¼ì›€
      2. ì™œ ì´ê²ƒì´ ë³´ì„ì¸ì§€ ì—…ê³„ íŠ¸ë Œë“œì™€ ì—°ê²°
      3. ì–´ë–»ê²Œ í™œìš©í•˜ê³  ê°•ì¡°í• ì§€ êµ¬ì²´ì  ì œì•ˆ
      
      "ìì†Œì„œë¥¼ ì„¸ ë²ˆì§¸ ì½ë‹¤ê°€ ê°‘ìê¸°..." ê°™ì€ ìƒìƒí•œ í‘œí˜„ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.
      
      ìê¸°ì†Œê°œì„œ:
      #{content}
    PROMPT
    
    response = make_api_request(prompt, "ì ì¬ë ¥ ë°œêµ´ ì „ë¬¸ê°€", 2000)
    parse_response(response)[:content]
  end
  
  def generate_encouragement(content)
    prompt = <<~PROMPT
      ë‹¹ì‹ ì€ ëŒ€ê¸°ì—… ì¸ì‚¬íŒ€ì—ì„œ 15ë…„ê°„ ê·¼ë¬´í•œ ë”°ëœ»í•œ ë©˜í† ì…ë‹ˆë‹¤.
      
      ì§€ì›ìì—ê²Œ ì§„ì‹¬ ì–´ë¦° ê²©ë ¤ì™€ ì‘ì› ë©”ì‹œì§€ë¥¼ 5ë¬¸ë‹¨ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”:
      1. ì†”ì§í•œ ì²« ë§ˆìŒ
      2. í•µì‹¬ ê°•ì ê³¼ ê°€ëŠ¥ì„±
      3. êµ¬ì²´ì  ì‹¤í–‰ ê³„íš
      4. ì§„ì‹¬ ì–´ë¦° ì‘ì›
      5. ë§ˆì§€ë§‰ ë‹¹ë¶€
      
      "ì§€ì›ìë‹˜, ì—¬ê¸°ê¹Œì§€ ì½ìœ¼ì‹œëŠë¼...", "15ë…„ê°„ ìˆ˜ì²œ ëª…ì˜ ì§€ì›ìë¥¼ ë§Œë‚˜ë´¤ì§€ë§Œ..." 
      ê°™ì€ ì§„ì •ì„± ìˆëŠ” í‘œí˜„ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.
      
      ìê¸°ì†Œê°œì„œ:
      #{content}
    PROMPT
    
    response = make_api_request(prompt, "HR ë©˜í† ", 2000)
    parse_response(response)[:content]
  end
  
  # [ì‚­ì œë¨ - ìœ„ë¡œ ì´ë™í•¨]
  
  # ë³‘ë ¬ì²˜ë¦¬ë¡œ ìì†Œì„œ ë¶„ì„ ì‹¤í–‰ (ê¸°ì¡´ ë©”ì„œë“œ)
  def analyze_cover_letter_parallel(content)
    results = {}
    threads = []
    errors = []
    
    # ê° ì„¹ì…˜ì„ ë³‘ë ¬ë¡œ ë¶„ì„
    threads << Thread.new do
      begin
        results[:first_impression] = analyze_first_impression(content)
      rescue => e
        errors << "ì²«ì¸ìƒ ë¶„ì„ ì‹¤íŒ¨: #{e.message}"
      end
    end
    
    threads << Thread.new do
      begin
        results[:strengths] = analyze_strengths(content)
      rescue => e
        errors << "ê°•ì  ë¶„ì„ ì‹¤íŒ¨: #{e.message}"
      end
    end
    
    threads << Thread.new do
      begin
        results[:improvements] = analyze_improvements(content)
      rescue => e
        errors << "ê°œì„ ì  ë¶„ì„ ì‹¤íŒ¨: #{e.message}"
      end
    end
    
    threads << Thread.new do
      begin
        results[:hidden_gems] = analyze_hidden_gems(content)
      rescue => e
        errors << "ìˆ¨ì€ ë³´ì„ ë¶„ì„ ì‹¤íŒ¨: #{e.message}"
      end
    end
    
    threads << Thread.new do
      begin
        results[:encouragement] = generate_encouragement(content)
      rescue => e
        errors << "ê²©ë ¤ ë©”ì‹œì§€ ìƒì„± ì‹¤íŒ¨: #{e.message}"
      end
    end
    
    # ëª¨ë“  ìŠ¤ë ˆë“œ ì™„ë£Œ ëŒ€ê¸°
    threads.each(&:join)
    
    # ì—ëŸ¬ í™•ì¸
    unless errors.empty?
      Rails.logger.error "ë³‘ë ¬ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: #{errors.join(', ')}"
      # ì¼ë¶€ ì‹¤íŒ¨í•´ë„ ì„±ê³µí•œ ë¶€ë¶„ì€ ë°˜í™˜
    end
    
    # ê²°ê³¼ ì¡°í•© - JSONê³¼ í…ìŠ¤íŠ¸ ëª¨ë‘ ë°˜í™˜
    {
      text: combine_analysis_results(results),
      json: combine_analysis_results_to_json(results)
    }
  end
  
  # JSON êµ¬ì¡°ë¡œ ë¶„ì„ ê²°ê³¼ ë³€í™˜
  def combine_analysis_results_to_json(results)
    {
      sections: [
        {
          number: 1,
          title: "ì²«ì¸ìƒ & ì „ì²´ì ì¸ ëŠë‚Œ",
          content: results[:first_impression] || "ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.",
          items: []
        },
        {
          number: 2,
          title: "ì˜ ì“´ ë¶€ë¶„ (Top 5 ê°•ì )",
          content: "",
          items: parse_numbered_items(results[:strengths])
        },
        {
          number: 3,
          title: "ì•„ì‰¬ìš´ ë¶€ë¶„ (Top 5 ê°œì„ ì )",
          content: "",
          items: parse_numbered_items(results[:improvements])
        },
        {
          number: 4,
          title: "ë†“ì¹˜ê³  ìˆëŠ” ìˆ¨ì€ ë³´ì„ë“¤",
          content: "",
          items: parse_numbered_items(results[:hidden_gems])
        },
        {
          number: 5,
          title: "ê²©ë ¤ì™€ ì‘ì› ë©”ì‹œì§€",
          content: results[:encouragement] || "ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.",
          items: []
        }
      ],
      analyzed_at: Time.current
    }
  end
  
  # í…ìŠ¤íŠ¸ì—ì„œ ë²ˆí˜¸ í•­ëª© íŒŒì‹±
  def parse_numbered_items(text)
    return [] if text.blank?
    
    items = []
    # **ê°•ì  1: ì œëª©** ë˜ëŠ” ### 1. ì œëª© í˜•ì‹ ì°¾ê¸°
    pattern = /(?:\*\*(?:ê°•ì |ê°œì„ ì |ë³´ì„)\s*(\d+):\s*([^*]+)\*\*|###\s*(\d+)\.\s*([^\n]+))\n*(.*?)(?=\*\*(?:ê°•ì |ê°œì„ ì |ë³´ì„)\s*\d+:|###\s*\d+\.|$)/m
    
    text.scan(pattern) do |num1, title1, num2, title2, content|
      number = num1 || num2
      title = title1 || title2
      if number && title
        items << {
          number: number.to_i,
          title: title.strip,
          content: content.strip
        }
      end
    end
    
    # íŒ¨í„´ì´ ì—†ìœ¼ë©´ ì „ì²´ í…ìŠ¤íŠ¸ë¥¼ í•˜ë‚˜ì˜ í•­ëª©ìœ¼ë¡œ
    if items.empty? && text.present?
      items << {
        number: 1,
        title: "",
        content: text.strip
      }
    end
    
    items
  end
  
  # ë³‘ë ¬ ë¶„ì„ ê²°ê³¼ ì¡°í•©
  def combine_analysis_results(results)
    # í…ìŠ¤íŠ¸ í˜•ì‹ (ê¸°ì¡´ í˜¸í™˜ì„± ìœ ì§€)
    text_result = <<~COMBINED
      ## 1. ì²«ì¸ìƒ & ì „ì²´ì ì¸ ëŠë‚Œ
      
      #{results[:first_impression] || "ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."}
      
      ---
      
      ## 2. ì˜ ì“´ ë¶€ë¶„ (Top 5 ê°•ì )
      
      #{results[:strengths] || "ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."}
      
      ---
      
      ## 3. ì•„ì‰¬ìš´ ë¶€ë¶„ (Top 5 ê°œì„ ì )
      
      #{results[:improvements] || "ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."}
      
      ---
      
      ## 4. ë†“ì¹˜ê³  ìˆëŠ” ìˆ¨ì€ ë³´ì„ë“¤
      
      #{results[:hidden_gems] || "ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."}
      
      ---
      
      ## 5. ê²©ë ¤ì™€ ì‘ì› ë©”ì‹œì§€
      
      #{results[:encouragement] || "ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."}
      
      ---
      ğŸ’¼ 15ë…„ì°¨ ì¸ì‚¬íŒ€ ì„ ë°°ê°€ ë“œë¦¬ëŠ” ì§„ì‹¬ ì–´ë¦° ì¡°ì–¸
    COMBINED
  end
  
  # ê¸°ì¡´ ë©”ì„œë“œë¥¼ ë³‘ë ¬ì²˜ë¦¬ ë²„ì „ìœ¼ë¡œ ëŒ€ì²´
  def analyze_cover_letter(content)
    # ë³‘ë ¬ì²˜ë¦¬ ì‚¬ìš© ì—¬ë¶€ë¥¼ í™˜ê²½ë³€ìˆ˜ë¡œ ì œì–´
    if ENV['USE_PARALLEL_ANALYSIS'] == 'true'
      analyze_cover_letter_parallel(content)
    else
      # ê¸°ì¡´ ìˆœì°¨ ì²˜ë¦¬ ë°©ì‹ (fallback)
      analyze_cover_letter_sequential(content)
    end
  end
  
  # ê¸°ì¡´ ìˆœì°¨ ì²˜ë¦¬ ë°©ì‹ (ì´ë¦„ ë³€ê²½)
  def analyze_cover_letter_sequential(content)
    prompt = <<~PROMPT
      âœ… ìµœì¢… ìê¸°ì†Œê°œì„œ ë¶„ì„ìš© í”„ë¡¬í”„íŠ¸
      
      ğŸ­ Role (ì—­í• )
      "ë‹¹ì‹ ì€ ëŒ€ê¸°ì—… ì¸ì‚¬íŒ€ì—ì„œ 15ë…„ê°„ ê·¼ë¬´í•˜ë©° ë‹¤ìˆ˜ì˜ ë©´ì ‘ê´€ ê²½í—˜ì„ ê°€ì§„ ì„ ë°° ì¸ì‚¬ë‹´ë‹¹ìì…ë‹ˆë‹¤. 
      ì·¨ì—… ì¤€ë¹„ìƒì˜ ìê¸°ì†Œê°œì„œë¥¼ ì½ê³ , HR ë‹´ë‹¹ìì˜ ì‹œê°ê³¼ ë”°ëœ»í•œ ë©˜í† ë§ í†¤ìœ¼ë¡œ ê¹Šì´ ìˆëŠ” í”¼ë“œë°±ì„ ì œê³µí•©ë‹ˆë‹¤."
      
      âš™ï¸ ê¸°ë³¸ ì„¤ì •
      - ë‹µë³€ì€ ì¶©ë¶„íˆ ê¸¸ê³  êµ¬ì²´ì ìœ¼ë¡œ ì‘ì„±
      - ì²´í¬ë¦¬ìŠ¤íŠ¸Â·ì§§ì€ ë‚˜ì—´ì‹ ê¸ˆì§€ â†’ ë°˜ë“œì‹œ 2~3ë¬¸ë‹¨ ì´ìƒ ì¥ë¬¸ ë©˜í† ë§ ìŠ¤íƒ€ì¼
      - ê° í”¼ë“œë°±ì€ HR í˜„ì¥ì—ì„œì˜ ì‹¤ì œ ì‹œê°ì„ ë‹´ì•„, ì§€ì›ìê°€ ë°”ë¡œ ê°œì„  ë°©í–¥ì„ ì´í•´í•  ìˆ˜ ìˆë„ë¡
      - ê³µê° + ë¶„ì„ + ëŒ€ì•ˆ + ì˜ˆì‹œ + ë©˜í†  ì½”ë©˜íŠ¸ê¹Œì§€ í¬í•¨
      
      ğŸ“Œ ì¶œë ¥ êµ¬ì¡° & ì§€ì‹œì‚¬í•­
      
      ## 1. ì²«ì¸ìƒ & ì „ì²´ì ì¸ ëŠë‚Œ
      
      ìê¸°ì†Œê°œì„œë¥¼ ì²˜ìŒ ì½ì€ HR ë‹´ë‹¹ìê°€ ëŠë‚€ ì§ì„¤ì  ì¸ìƒì„ ì„œìˆ í•´ì£¼ì„¸ìš”. ê¸€ì˜ íë¦„, ë…¼ë¦¬ì„±, ì§„ì •ì„±, ì„¤ë“ë ¥ì— ëŒ€í•œ ì¢…í•© í‰ê°€ë¥¼ ìµœì†Œ 2~3ë¬¸ë‹¨ ì´ìƒìœ¼ë¡œ ì‘ì„±í•˜ë˜, HR í˜„ì¥ì˜ ìƒìƒí•œ ì‹œê°ì„ ë°˜ì˜í•´ì£¼ì„¸ìš”.
      
      ì˜ˆë¥¼ ë“¤ì–´, "ì²« ë¬¸ë‹¨ì„ ì½ìë§ˆì 'ì•„, ì´ ì§€ì›ìëŠ” ìš°ë¦¬ íšŒì‚¬ë¥¼ ì •ë§ ì˜ ì•Œê³  ì§€ì›í–ˆêµ¬ë‚˜'ë¼ëŠ” ìƒê°ì´ ë“¤ì—ˆìŠµë‹ˆë‹¤. íŠ¹íˆ ìµœê·¼ ìš°ë¦¬ ì—…ê³„ì˜ ë””ì§€í„¸ ì „í™˜ íŠ¸ë Œë“œë¥¼ ë³¸ì¸ì˜ ê²½í—˜ê³¼ ì—°ê²°ì‹œí‚¨ ë¶€ë¶„ì€ ë§¤ìš° ì¸ìƒì ì´ì—ˆì£ . ë‹¤ë§Œ ì¤‘ë°˜ë¶€ë¡œ ê°ˆìˆ˜ë¡ êµ¬ì²´ì„±ì´ ë–¨ì–´ì§€ë©´ì„œ ë‹¤ì†Œ ì¼ë°˜ì ì¸ ì´ì•¼ê¸°ë¡œ íë¥´ëŠ” ì ì´ ì•„ì‰¬ì› ìŠµë‹ˆë‹¤. HR ë‹´ë‹¹ì ì…ì¥ì—ì„œëŠ” 'ê³¼ì—° ì´ ì‚¬ëŒì´ ì‹¤ì œë¡œ ìš°ë¦¬ íŒ€ì—ì„œ ì–´ë–¤ ê¸°ì—¬ë¥¼ í•  ìˆ˜ ìˆì„ê¹Œ?'ë¼ëŠ” ì˜ë¬¸ì´ ë“¤ ìˆ˜ ìˆëŠ” ë¶€ë¶„ì´ì—ìš”..."ì™€ ê°™ì€ ì‹ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.
      
      ## 2. ì˜ ì“´ ë¶€ë¶„ (Top 5 ê°•ì )
      
      ê° ê°•ì ë§ˆë‹¤ ìµœì†Œ 3-4ë¬¸ë‹¨, ê° ë¬¸ë‹¨ì€ 4-5ë¬¸ì¥ ì´ìƒìœ¼ë¡œ ê¹Šì´ ìˆê²Œ ì‘ì„±. HR í˜„ì¥ì˜ ì‹¤ì œ ê²½í—˜ê³¼ ë©´ì ‘ í™œìš© íŒ í¬í•¨:
      
      **ê°•ì  1: [í•µì‹¬ ê°•ì ì„ í•œ ë¬¸ì¥ìœ¼ë¡œ - ì˜ˆ: "ê³ ê° ê´€ì  ì‚¬ê³ ë¥¼ í†µí•œ ì„±ê³¼ ì°½ì¶œ ëŠ¥ë ¥"]**
      
      [1ë¬¸ë‹¨ - ìì†Œì„œ ë‚´ìš© ì¸ìš©ê³¼ ì²«ì¸ìƒ]
      ì§€ì›ìë‹˜ì˜ ìì†Œì„œì—ì„œ "[êµ¬ì²´ì  ë¬¸ì¥ ì¸ìš©]"ë¼ê³  ì“°ì‹  ë¶€ë¶„ì„ ì½ëŠ” ìˆœê°„, ì €ëŠ” ê³§ë°”ë¡œ íœìœ¼ë¡œ ë³„í‘œë¥¼ ê·¸ì—ˆìŠµë‹ˆë‹¤. ì™œëƒí•˜ë©´ ì´ í•œ ë¬¸ì¥ì—ì„œ ì§€ì›ìë‹˜ì´ ë‹¨ìˆœíˆ 'ì¼ì„ í–ˆë‹¤'ê°€ ì•„ë‹ˆë¼ 'ì™œ ì´ ì¼ì„ í–ˆëŠ”ì§€'ë¥¼ ëª…í™•íˆ ë³´ì—¬ì£¼ì…¨ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. [êµ¬ì²´ì ì¸ ê²½í—˜ ìš”ì•½]. 15ë…„ê°„ ìˆ˜ë§ì€ ìì†Œì„œë¥¼ ì½ì–´ì™”ì§€ë§Œ, ì´ë ‡ê²Œ [í•µì‹¬ í¬ì¸íŠ¸]ë¥¼ ëª…í™•íˆ ì§šì–´ë‚¸ ì§€ì›ìëŠ” ë§ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.
      
      [2ë¬¸ë‹¨ - HR ê´€ì ì—ì„œ ì™œ ì¢‹ì€ì§€]
      HR í˜„ì¥ì—ì„œ ìš°ë¦¬ê°€ ì •ë§ ì°¾ëŠ” ì¸ì¬ëŠ” 'ì§€ì‹œë°›ì€ ì¼ì„ ì˜í•˜ëŠ” ì‚¬ëŒ'ì´ ì•„ë‹ˆë¼ 'ì™œ ì´ ì¼ì„ í•´ì•¼ í•˜ëŠ”ì§€ ìŠ¤ìŠ¤ë¡œ ì§ˆë¬¸í•˜ê³  ë‹µì„ ì°¾ëŠ” ì‚¬ëŒ'ì…ë‹ˆë‹¤. ì§€ì›ìë‹˜ì´ [êµ¬ì²´ì  í–‰ë™]ì„ í†µí•´ [êµ¬ì²´ì  ì„±ê³¼]ë¥¼ ë§Œë“¤ì–´ë‚¸ ê³¼ì •ì€ ë°”ë¡œ ì´ëŸ° ì‚¬ê³ ë ¥ì„ ì¦ëª…í•©ë‹ˆë‹¤. íŠ¹íˆ [íŠ¹ì • ë¶€ë¶„]ì—ì„œ ë³´ì—¬ì¤€ [êµ¬ì²´ì  ì—­ëŸ‰]ì€ ì‹¤ì œ [í•´ë‹¹ ì§ë¬´]ì—ì„œ ê°€ì¥ ì¤‘ìš”í•œ ì—­ëŸ‰ ì¤‘ í•˜ë‚˜ì…ë‹ˆë‹¤. ì œê°€ ì‘ë…„ì— ì±„ìš©í•œ ì‹ ì…ì‚¬ì› ì¤‘ì—ì„œë„ ì´ëŸ° ì—­ëŸ‰ì„ ê°€ì§„ ë¶„ì´ ìˆì—ˆëŠ”ë°, ì…ì‚¬ 6ê°œì›” ë§Œì— íŒ€ì˜ í•µì‹¬ ë©¤ë²„ë¡œ ì„±ì¥í–ˆë˜ ê¸°ì–µì´ ë‚˜ë„¤ìš”.
      
      [3ë¬¸ë‹¨ - ì°¨ë³„í™” í¬ì¸íŠ¸ì™€ ì‹¤ë¬´ ì—°ê²°]
      ë” ì¸ìƒì ì¸ ì ì€ ë‹¨ìˆœíˆ ì„±ê³¼ë¥¼ ë‹¬ì„±í•œ ê²ƒì—ì„œ ë©ˆì¶”ì§€ ì•Šê³ , [í›„ì† í–‰ë™ì´ë‚˜ í•™ìŠµ]ê¹Œì§€ ì´ì–´ê°„ ë¶€ë¶„ì…ë‹ˆë‹¤. ë§ì€ ì§€ì›ìë“¤ì´ "â—‹â—‹ë¥¼ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤"ì—ì„œ ëë‚˜ëŠ”ë°, ì§€ì›ìë‹˜ì€ "ê·¸ë˜ì„œ ë¬´ì—‡ì„ ë°°ì› ê³ , ì–´ë–»ê²Œ ë°œì „ì‹œì¼°ëŠ”ì§€"ê¹Œì§€ ë³´ì—¬ì£¼ì…¨ìŠµë‹ˆë‹¤. ì´ëŠ” ì‹¤ë¬´ì—ì„œ 'í•œ ë²ˆì˜ ì„±ê³µì„ ì‹œìŠ¤í…œìœ¼ë¡œ ë§Œë“¤ ìˆ˜ ìˆëŠ” ì‚¬ëŒ'ì„ì„ ë³´ì—¬ì£¼ëŠ” ê°•ë ¥í•œ ì¦ê±°ì…ë‹ˆë‹¤.
      
      [4ë¬¸ë‹¨ - ë©´ì ‘ í™œìš© ì „ëµ]
      ë©´ì ‘ì—ì„œëŠ” ì´ ë¶€ë¶„ì„ ë”ìš± ì „ëµì ìœ¼ë¡œ í™œìš©í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤. "ë‹¹ì‹œ ìƒí™©ì„ ì¢€ ë” ìì„¸íˆ ì„¤ëª…í•´ì£¼ì„¸ìš”"ë¼ëŠ” ì§ˆë¬¸ì´ ë‚˜ì˜¬ ë•Œ, "ì‚¬ì‹¤ ì²˜ìŒì—ëŠ” [ì´ˆê¸° ì–´ë ¤ì›€]ì´ ìˆì—ˆëŠ”ë°, [êµ¬ì²´ì  í•´ê²° ê³¼ì •]ì„ ê±°ì³ [ìµœì¢… ì„±ê³¼]ë¥¼ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤. íŠ¹íˆ ì´ ê³¼ì •ì—ì„œ [í•µì‹¬ ê¹¨ë‹¬ìŒ]ì„ ì–»ì—ˆê³ , ì´í›„ [ë‹¤ë¥¸ ìƒí™©]ì—ì„œë„ ê°™ì€ ì›ë¦¬ë¥¼ ì ìš©í•´ ì„±ê³¼ë¥¼ ëƒˆìŠµë‹ˆë‹¤"ë¼ëŠ” ì‹ìœ¼ë¡œ í™•ì¥í•˜ì‹œë©´ ë©ë‹ˆë‹¤. ë©´ì ‘ê´€ë“¤ì€ ë‹¨ìˆœí•œ ì„±ê³¼ë³´ë‹¤ 'ì¬í˜„ ê°€ëŠ¥í•œ ì—­ëŸ‰'ì„ ë” ë†’ì´ í‰ê°€í•œë‹¤ëŠ” ì , ê¼­ ê¸°ì–µí•˜ì„¸ìš”.
      
      [#ê³ ê°ì¤‘ì‹¬ì‚¬ê³ ] [#ì„±ê³¼ì¬í˜„ê°€ëŠ¥ì„±] [#ì „ëµì ì‹¤í–‰]
      
      **ê°•ì  2~5ë„ ë™ì¼í•˜ê²Œ 3-4ë¬¸ë‹¨ì”© ìƒì„¸ ì‘ì„±**
      
      ## 3. ì•„ì‰¬ìš´ ë¶€ë¶„ (Top 5 ê°œì„ ì )
      
      ê° ê°œì„ ì ë§ˆë‹¤ ìµœì†Œ 3-4ë¬¸ë‹¨, ê° ë¬¸ë‹¨ì€ 4-5ë¬¸ì¥ ì´ìƒìœ¼ë¡œ ìƒì„¸í•˜ê²Œ ì‘ì„±. ë¬¸ì œì  ì§€ì  + ì´ìœ  ì„¤ëª… + êµ¬ì²´ì  ê°œì„ ì•ˆ + ê²©ë ¤:
      
      **ê°œì„ ì  1: [í•µì‹¬ ë¬¸ì œë¥¼ í•œ ë¬¸ì¥ìœ¼ë¡œ - ì˜ˆ: "ê²½í—˜ ë‚˜ì—´ë¡œ ì¸í•œ í•µì‹¬ ë©”ì‹œì§€ í¬ì„"]**
      
      [1ë¬¸ë‹¨ - ë¬¸ì œì  ì§€ì ê³¼ ì¸ìš©]
      ì§€ì›ìë‹˜ì˜ ìì†Œì„œë¥¼ ì½ë‹¤ê°€ [íŠ¹ì • ë¶€ë¶„]ì—ì„œ ì ì‹œ ë©ˆì¶°ì„œ ë‹¤ì‹œ ì½ì–´ë´¤ìŠµë‹ˆë‹¤. "[ì‹¤ì œ ë¬¸ì¥ ì¸ìš©]"ë¼ê³  ì“°ì‹  ë¶€ë¶„ì¸ë°ìš”, ì†”ì§íˆ ë§ì”€ë“œë¦¬ë©´ ì´ ë¶€ë¶„ì„ ì½ìœ¼ë©´ì„œ 'ì•„, ë˜ ì´ëŸ° í‘œí˜„ì´êµ¬ë‚˜'ë¼ëŠ” ìƒê°ì´ ë“¤ì—ˆìŠµë‹ˆë‹¤. ì œê°€ í•˜ë£¨ì— í‰ê·  50ê°œì˜ ìì†Œì„œë¥¼ ê²€í† í•˜ëŠ”ë°, ì´ëŸ° í‘œí˜„ì€ ê±°ì˜ 80%ì˜ ì§€ì›ìê°€ ì‚¬ìš©í•©ë‹ˆë‹¤. ë¬¸ì œëŠ” ì´ëŸ° ì¼ë°˜ì ì¸ í‘œí˜„ì´ ë‚˜ì˜¤ëŠ” ìˆœê°„, HR ë‹´ë‹¹ìì˜ ë¨¸ë¦¿ì†ì—ì„œëŠ” ìë™ìœ¼ë¡œ 'ì°¨ë³„í™” ì—†ìŒ'ì´ë¼ëŠ” ë¹¨ê°„ ì‹ í˜¸ê°€ ì¼œì§„ë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤. íŠ¹íˆ [êµ¬ì²´ì ì¸ ë¬¸ì œ ì§€ì ] ë¶€ë¶„ì€ ì§€ì›ìë‹˜ì˜ ì§„ì§œ ì—­ëŸ‰ì„ ê°€ë¦¬ëŠ” ì•ˆê°œ ê°™ì€ ì—­í• ì„ í•˜ê³  ìˆì–´ìš”.
      
      [2ë¬¸ë‹¨ - ì™œ ì´ê²ƒì´ ì¹˜ëª…ì ì¸ì§€ ì„¤ëª…]
      ì´ê²Œ ì™œ ë¬¸ì œì¸ì§€ ì‹¤ì œ ì‚¬ë¡€ë¡œ ì„¤ëª…ë“œë¦´ê²Œìš”. ì‘ë…„ì— ë¹„ìŠ·í•œ ìì†Œì„œë¥¼ ì“´ ë‘ ëª…ì˜ ì§€ì›ìê°€ ìˆì—ˆìŠµë‹ˆë‹¤. AëŠ” "ì—´ì •ì ì´ê³  ë„ì „ì ì¸ ì„±ê²©ìœ¼ë¡œ ëª¨ë“  ì¼ì— ìµœì„ ì„ ë‹¤í•©ë‹ˆë‹¤"ë¼ê³  ì¼ê³ , BëŠ” "ë§¤ì¼ ì•„ì¹¨ 6ì‹œì— ì¶œê·¼í•´ ê²½ìŸì‚¬ ë§ˆì¼€íŒ… ë™í–¥ì„ ë¶„ì„í•˜ëŠ” ë¦¬í¬íŠ¸ë¥¼ 3ê°œì›”ê°„ ì‘ì„±í–ˆê³ , ì´ë¥¼ í†µí•´ ìš°ë¦¬ íŒ€ì´ ë†“ì¹˜ê³  ìˆë˜ íƒ€ê²Ÿì¸µì„ ë°œê²¬í•´ ì‹ ê·œ ìº í˜ì¸ìœ¼ë¡œ ì—°ê²°ì‹œì¼°ìŠµë‹ˆë‹¤"ë¼ê³  ì¼ì£ . ëˆ„ê°€ í•©ê²©í–ˆì„ê¹Œìš”? ë‹¹ì—°íˆ Bì…ë‹ˆë‹¤. HR ì…ì¥ì—ì„œëŠ” 'ë¬´ì—‡ì„ í•  ìˆ˜ ìˆëŠ” ì‚¬ëŒì¸ì§€'ê°€ ëª…í™•íˆ ë³´ì´ëŠ” ì§€ì›ìë¥¼ ì„ í˜¸í•©ë‹ˆë‹¤. ë§‰ì—°í•œ ì„±ê²© ë¬˜ì‚¬ëŠ” ì•„ë¬´ëŸ° ì •ë³´ë¥¼ ì£¼ì§€ ëª»í•´ìš”.
      
      [3ë¬¸ë‹¨ - êµ¬ì²´ì ì¸ ê°œì„  ë°©í–¥ê³¼ ì˜ˆì‹œ]
      ì´ ë¶€ë¶„ì„ ì´ë ‡ê²Œ ë°”ê¿”ë³´ì‹œë©´ ì–´ë–¨ê¹Œìš”? í˜„ì¬ì˜ "[ì›ë˜ í‘œí˜„]" ëŒ€ì‹  "[ê°œì„ ëœ êµ¬ì²´ì  ì˜ˆì‹œ - ìƒí™©/í–‰ë™/ê²°ê³¼ í¬í•¨]"ë¼ê³  ì“°ëŠ” ê²ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, "ì €ëŠ” ì±…ì„ê°ì´ ê°•í•©ë‹ˆë‹¤"ê°€ ì•„ë‹ˆë¼ "í”„ë¡œì íŠ¸ ë§ˆê° 3ì¼ ì „ íŒ€ì›ì´ ê°‘ìê¸° ì´íƒˆí–ˆì„ ë•Œ, ì œê°€ ê·¸ì˜ íŒŒíŠ¸ê¹Œì§€ ë§¡ì•„ 48ì‹œê°„ ë™ì•ˆ ì§‘ì¤‘ ì‘ì—…í•˜ì—¬ ê¸°í•œ ë‚´ ì™„ì„±í–ˆê³ , í´ë¼ì´ì–¸íŠ¸ë¡œë¶€í„° 'ìœ„ê¸° ëŒ€ì²˜ ëŠ¥ë ¥ì´ ë›°ì–´ë‚˜ë‹¤'ëŠ” í‰ê°€ë¥¼ ë°›ì•˜ìŠµë‹ˆë‹¤"ë¼ê³  ì“°ëŠ” ê±°ì£ . ì´ë ‡ê²Œ ì“°ë©´ ë©´ì ‘ê´€ì´ 'ì•„, ì´ ì‚¬ëŒì€ ì‹¤ì œë¡œ ìœ„ê¸° ìƒí™©ì—ì„œ ì±…ì„ê° ìˆê²Œ í–‰ë™í•œ ê²½í—˜ì´ ìˆêµ¬ë‚˜'ë¼ê³  êµ¬ì²´ì ìœ¼ë¡œ ì´í•´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      
      [4ë¬¸ë‹¨ - ê²©ë ¤ì™€ ì‹¤í–‰ ê°€ëŠ¥í•œ ì¡°ì–¸]
      ì§€ì›ìë‹˜, ë¶„ëª…íˆ ì´ëŸ° êµ¬ì²´ì ì¸ ê²½í—˜ë“¤ì´ ìˆìœ¼ì‹¤ ê±°ì˜ˆìš”. ë‹¨ì§€ ê·¸ê²ƒì„ 'ì¼ë°˜ì ì¸ í‘œí˜„'ì´ë¼ëŠ” í¬ì¥ì§€ë¡œ ê°ì‹¸ë²„ë¦¬ì‹  ê²ƒë¿ì…ë‹ˆë‹¤. ìì†Œì„œë¥¼ ë‹¤ì‹œ ì½ìœ¼ë©´ì„œ ëª¨ë“  í˜•ìš©ì‚¬ì™€ ì¶”ìƒì  í‘œí˜„ì— í˜•ê´‘íœì„ ì³ë³´ì„¸ìš”. ê·¸ë¦¬ê³  ê°ê°ì— ëŒ€í•´ "ì´ê±¸ ì¦ëª…í•  ìˆ˜ ìˆëŠ” ë‚˜ë§Œì˜ ì—í”¼ì†Œë“œê°€ ë­ì§€?"ë¼ê³  ìë¬¸í•´ë³´ì„¸ìš”. ê·¸ ì—í”¼ì†Œë“œë¥¼ ìˆ«ìì™€ êµ¬ì²´ì  ìƒí™©ìœ¼ë¡œ í’€ì–´ì“°ë©´, ì§€ê¸ˆë³´ë‹¤ 10ë°°ëŠ” ê°•ë ¥í•œ ìì†Œì„œê°€ ë  ê²ë‹ˆë‹¤. ì €ëŠ” ì§€ì›ìë‹˜ì´ ì¶©ë¶„íˆ ê·¸ëŸ´ ì—­ëŸ‰ì´ ìˆë‹¤ê³  í™•ì‹ í•©ë‹ˆë‹¤.
      
      [#êµ¬ì²´ì„±ê°•í™”] [#ì°¨ë³„í™”ì „ëµ] [#STARê¸°ë²•ì ìš©]
      
      **ê°œì„ ì  2~5ë„ ë™ì¼í•˜ê²Œ 3-4ë¬¸ë‹¨ì”© ìƒì„¸ ì‘ì„±**
      
      ## 4. ë†“ì¹˜ê³  ìˆëŠ” ìˆ¨ì€ ë³´ì„ë“¤
      
      ê° ìˆ¨ì€ ê°•ì ë§ˆë‹¤ ìµœì†Œ 2-3ë¬¸ë‹¨, ê° ë¬¸ë‹¨ì€ 4-5ë¬¸ì¥ ì´ìƒìœ¼ë¡œ ê¹Šì´ ìˆê²Œ ì‘ì„±:
      
      **ìˆ¨ì€ ë³´ì„ 1: [ë°œê²¬í•œ ì ì¬ ê°•ì ì„ í•œ ë¬¸ì¥ìœ¼ë¡œ - ì˜ˆ: "ê´€ì°°ë ¥ì´ë¼ëŠ” ì°¨ë³„í™”ëœ ë¬´ê¸°"]**
      
      [1ë¬¸ë‹¨ - ë°œê²¬ì˜ ìˆœê°„ê³¼ ë†€ë¼ì›€]
      ì§€ì›ìë‹˜ì˜ ìì†Œì„œë¥¼ ì„¸ ë²ˆì§¸ ì½ë‹¤ê°€ ê°‘ìê¸° "ì–´?"í•˜ê³  ë©ˆì¶° ì„°ìŠµë‹ˆë‹¤. [íŠ¹ì • ë¶€ë¶„]ì—ì„œ ì•„ì£¼ ì§§ê²Œ, ê±°ì˜ ìŠ¤ì³ ì§€ë‚˜ê°€ë“¯ ì–¸ê¸‰í•˜ì‹  "[êµ¬ì²´ì  ë¬¸ì¥ ì¸ìš©]"ë¼ëŠ” ë¶€ë¶„ ë§ì…ë‹ˆë‹¤. ëŒ€ë¶€ë¶„ì˜ ì§€ì›ìëŠ” ì´ëŸ° ë””í…Œì¼ì„ ë†“ì¹˜ëŠ”ë°, ì§€ì›ìë‹˜ì€ ì´ê±¸ í¬ì°©í•˜ê³  í–‰ë™ìœ¼ë¡œ ì˜®ê¸°ì…¨ë”êµ°ìš”. 15ë…„ê°„ HR ì—…ë¬´ë¥¼ í•˜ë©´ì„œ ì´ëŸ° ê´€ì°°ë ¥ì„ ê°€ì§„ ì§€ì›ìëŠ” ì†ì— ê¼½ì„ ì •ë„ì˜€ìŠµë‹ˆë‹¤. ê·¸ëŸ°ë° ì™œ ì´ë ‡ê²Œ ì¤‘ìš”í•œ ì—­ëŸ‰ì„ í•œ ì¤„ë¡œë§Œ ì²˜ë¦¬í•˜ì…¨ë‚˜ìš”? ì´ê±´ ì •ë§ ì•„ê¹Œìš´ ì¼ì…ë‹ˆë‹¤.
      
      [2ë¬¸ë‹¨ - ì™œ ì´ê²ƒì´ ë³´ì„ì¸ì§€ ì„¤ëª…]
      ì œê°€ ì™œ ì´ë ‡ê²Œ í¥ë¶„í•˜ëŠ”ì§€ ì„¤ëª…ë“œë¦´ê²Œìš”. í˜„ì¬ [ê´€ë ¨ ì—…ê³„/ì§ë¬´]ì—ì„œ ê°€ì¥ ë¶€ì¡±í•œ ì¸ì¬ê°€ ë°”ë¡œ 'ë””í…Œì¼ì„ ìºì¹˜í•˜ê³  ì¸ì‚¬ì´íŠ¸ë¡œ ì „í™˜í•  ìˆ˜ ìˆëŠ” ì‚¬ëŒ'ì…ë‹ˆë‹¤. ì‹¤ì œë¡œ ì‘ë…„ì— ìš°ë¦¬ íšŒì‚¬ì—ì„œ ëŒ€ë°•ì„ ì¹œ [ì˜ˆì‹œ í”„ë¡œì íŠ¸/ìº í˜ì¸]ë„ ëˆ„êµ°ê°€ì˜ ì‘ì€ ê´€ì°°ì—ì„œ ì‹œì‘ëê±°ë“ ìš”. ì§€ì›ìë‹˜ì´ [êµ¬ì²´ì  ìƒí™©]ì—ì„œ [êµ¬ì²´ì  ê´€ì°°]ì„ í†µí•´ [êµ¬ì²´ì  ê²°ê³¼]ë¥¼ ë§Œë“¤ì–´ë‚¸ ê²ƒì€, ë‹¨ìˆœí•œ ì„±ê³¼ê°€ ì•„ë‹ˆë¼ 'ë‚¨ë“¤ì´ ë³´ì§€ ëª»í•˜ëŠ” ê²ƒì„ ë³´ëŠ” ëˆˆ'ì„ ê°€ì¡Œë‹¤ëŠ” ì¦ê±°ì…ë‹ˆë‹¤. ì´ëŸ° ëŠ¥ë ¥ì€ ê°€ë¥´ì³ì„œ ë˜ëŠ” ê²Œ ì•„ë‹ˆë¼ íƒ€ê³ ë‚˜ëŠ” ê±°ì˜ˆìš”.
      
      [3ë¬¸ë‹¨ - ì–´ë–»ê²Œ í™œìš©í•˜ê³  ê°•ì¡°í• ì§€ êµ¬ì²´ì  ì œì•ˆ]
      ì œë°œ ì´ ë¶€ë¶„ì„ ì „ë©´ì— ë‚´ì„¸ìš°ì„¸ìš”! ìì†Œì„œì—ì„œ ë³„ë„ ì„¹ì…˜ìœ¼ë¡œ ë§Œë“¤ì–´ì„œ "ì €ëŠ” ì‘ì€ ì‹ í˜¸ì—ì„œ í° ê¸°íšŒë¥¼ ë°œê²¬í•˜ëŠ” ê´€ì°°ë ¥ì„ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤"ë¼ê³  ì‹œì‘í•˜ë©´ì„œ, ì´ ê²½í—˜ì„ STAR êµ¬ì¡°ë¡œ í’€ì–´ì“°ì‹œë©´ ë©ë‹ˆë‹¤. ë©´ì ‘ì—ì„œëŠ” "ì‚¬ì‹¤ ì œê°€ ê°€ì¥ ìì‹  ìˆëŠ” ì—­ëŸ‰ì´ ìˆëŠ”ë°ìš”"ë¼ê³  ìš´ì„ ë–¼ê³  ì´ ì´ì•¼ê¸°ë¥¼ í•˜ì„¸ìš”. ë©´ì ‘ê´€ë“¤ì´ "ì´ëŸ° ì‹œê°ì„ ê°€ì§„ ì‚¬ëŒì´ë¼ë©´ ìš°ë¦¬ íŒ€ì—ì„œ ìƒˆë¡œìš´ ê´€ì ì„ ì œì‹œí•´ì¤„ ìˆ˜ ìˆê² ë‹¤"ë¼ê³  ìƒê°í•  ê²ë‹ˆë‹¤. ì´ë¯¸ ê²½í—˜ì´ ìˆìœ¼ë‹ˆ ìì‹ ê°ì„ ê°€ì§€ê³  ì–´í•„í•˜ì„¸ìš”!
      
      [#ìˆ¨ì€ì—­ëŸ‰ë°œêµ´] [#ê´€ì°°ë ¥] [#ì°¨ë³„í™”í¬ì¸íŠ¸]
      
      **ìˆ¨ì€ ë³´ì„ 2~3ë„ ë™ì¼í•˜ê²Œ 2-3ë¬¸ë‹¨ì”© ìƒì„¸ ì‘ì„±**
      
      ## 5. ê²©ë ¤ì™€ ì‘ì› ë©”ì‹œì§€
      
      [1ë¬¸ë‹¨ - ì†”ì§í•œ ì²« ë§ˆìŒ]
      ì§€ì›ìë‹˜, ì—¬ê¸°ê¹Œì§€ ì½ìœ¼ì‹œëŠë¼ í˜ë“œì…¨ì£ ? ì œê°€ ê½¤ ë‚ ì¹´ë¡œìš´ í”¼ë“œë°±ì„ ë§ì´ ë“œë ¸ëŠ”ë°, ê¸°ë¶„ì´ ìƒí•˜ì§€ ì•Šìœ¼ì…¨ê¸¸ ë°”ëë‹ˆë‹¤. ì‚¬ì‹¤ ê³ ë°±í•˜ìë©´, ì €ëŠ” ì§€ì›ìë‹˜ì˜ ìì†Œì„œë¥¼ ì½ìœ¼ë©´ì„œ ì—¬ëŸ¬ ë²ˆ "ì•„, ì´ ì‚¬ëŒì€ í•©ê²©ì‹œì¼œì•¼ê² ë‹¤"ë¼ëŠ” ìƒê°ì´ ë“¤ì—ˆì–´ìš”. ì™œëƒí•˜ë©´ ì§€ì›ìë‹˜ì˜ ê²½í—˜ í•˜ë‚˜í•˜ë‚˜ì—ëŠ” 'ì§„ì§œ ì¼ì„ í•´ë³¸ ì‚¬ëŒ'ë§Œì´ ì“¸ ìˆ˜ ìˆëŠ” ë””í…Œì¼ì´ ìˆì—ˆê±°ë“ ìš”. ë‹¨ì§€ ê·¸ ë³´ì„ë“¤ì´ ë„ˆë¬´ ìˆ˜ì¤ê²Œ ìˆ¨ì–´ìˆì„ ë¿ì´ì—ìš”. ì œê°€ ì´ë ‡ê²Œ ìƒì„¸í•œ í”¼ë“œë°±ì„ ë“œë¦¬ëŠ” ì´ìœ ëŠ” ë‹¨ í•˜ë‚˜, ì§€ì›ìë‹˜ì´ ê°€ì§„ ì§„ì§œ ì—­ëŸ‰ì´ ì œëŒ€ë¡œ ë¹›ë‚˜ê¸¸ ë°”ë¼ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.
      
      [2ë¬¸ë‹¨ - í•µì‹¬ ê°•ì ê³¼ ê°€ëŠ¥ì„±]
      15ë…„ê°„ ìˆ˜ì²œ ëª…ì˜ ì§€ì›ìë¥¼ ë§Œë‚˜ë´¤ì§€ë§Œ, ì§€ì›ìë‹˜ì²˜ëŸ¼ [í•µì‹¬ ê°•ì  1], [í•µì‹¬ ê°•ì  2], ê·¸ë¦¬ê³  [í•µì‹¬ ê°•ì  3]ì„ ë™ì‹œì— ê°–ì¶˜ ë¶„ì€ ì •ë§ ë“œë¬¼ì—ˆìŠµë‹ˆë‹¤. íŠ¹íˆ [ê°€ì¥ ì¸ìƒì ì¸ ê²½í—˜/ì—­ëŸ‰]ì€ ì‹ ì… ìˆ˜ì¤€ì„ í›¨ì”¬ ë›°ì–´ë„˜ëŠ” ìˆ˜ì¤€ì´ì—ìš”. ì´ëŸ° ì—­ëŸ‰ì„ ê°€ì§„ ë¶„ì´ ì™œ ìì†Œì„œì—ì„œëŠ” ì´ë ‡ê²Œ ê²¸ì†í•œì§€ ëª¨ë¥´ê² ë„¤ìš”. ì œê°€ ë§Œì•½ í˜„ì¬ë„ ì±„ìš© ê²°ì •ê¶Œì„ ê°€ì§€ê³  ìˆë‹¤ë©´, ì§€ì›ìë‹˜ ê°™ì€ ë¶„ì€ ë¬´ì¡°ê±´ ë©´ì ‘ì— ë¶ˆëŸ¬ì„œ ì§ì ‘ ë§Œë‚˜ë³´ê³  ì‹¶ì„ ê²ë‹ˆë‹¤. ê·¸ ì •ë„ë¡œ ì¶©ë¶„í•œ ì ì¬ë ¥ì„ ê°€ì§€ê³  ê³„ì„¸ìš”.
      
      [3ë¬¸ë‹¨ - êµ¬ì²´ì  ì‹¤í–‰ ê³„íš]
      ì´ì œ êµ¬ì²´ì ìœ¼ë¡œ ë­˜ í•´ì•¼ í• ì§€ ë§ì”€ë“œë¦´ê²Œìš”. ì²«ì§¸, ì œê°€ ì§€ì í•œ ê°œì„ ì ë“¤ ì¤‘ì—ì„œ ê°€ì¥ ë§ˆìŒì— ì™€ë‹¿ëŠ” 3ê°€ì§€ë§Œ ê³¨ë¼ì„œ ë¨¼ì € ìˆ˜ì •í•´ë³´ì„¸ìš”. í•œ ë²ˆì— ë‹¤ ê³ ì¹˜ë ¤ê³  í•˜ë©´ ì˜¤íˆë ¤ ìì†Œì„œì˜ ì¼ê´€ì„±ì´ ê¹¨ì§ˆ ìˆ˜ ìˆì–´ìš”. ë‘˜ì§¸, ê° ê²½í—˜ë§ˆë‹¤ "So What?"ì„ ìë¬¸í•´ë³´ì„¸ìš”. "ê·¸ë˜ì„œ ì´ê²Œ ì™œ ì¤‘ìš”í•œë°? íšŒì‚¬ì— ì–´ë–¤ ë„ì›€ì´ ë˜ëŠ”ë°?"ë¼ëŠ” ì§ˆë¬¸ì— ë‹µí•  ìˆ˜ ìˆì–´ì•¼ í•©ë‹ˆë‹¤. ì…‹ì§¸, ìˆ¨ì€ ë³´ì„ë“¤ì„ ì „ë©´ì— ë°°ì¹˜í•˜ì„¸ìš”. ë‚¨ë“¤ê³¼ ë‹¤ë¥¸ ì§€ì›ìë‹˜ë§Œì˜ íŠ¹ë³„í•¨ì„ ì²« ë¬¸ë‹¨ë¶€í„° ë³´ì—¬ì£¼ì„¸ìš”.
      
      [4ë¬¸ë‹¨ - ì§„ì‹¬ ì–´ë¦° ì‘ì›]
      ì§€ì›ìë‹˜, ì·¨ì—… ì¤€ë¹„ê°€ ì •ë§ í˜ë“œì‹œì£ ? ë§¤ì¼ ë¹„ìŠ·í•œ ìì†Œì„œë¥¼ ì“°ê³ , ë¶ˆí•©ê²© í†µë³´ë¥¼ ë°›ê³ , ìì‹ ê°ì´ ë–¨ì–´ì§€ëŠ” ë‚ ë“¤ì´ ë§ìœ¼ì‹¤ ê±°ì˜ˆìš”. ì €ë„ ê·¸ ê¸¸ì„ ê±¸ì–´ë´¤ê³ , ì§€ê¸ˆì€ ë°˜ëŒ€í¸ì—ì„œ ì§€ì›ìë“¤ì„ í‰ê°€í•˜ëŠ” ì…ì¥ì´ ë˜ì–´ë´¤ê¸°ì— ì˜ ì••ë‹ˆë‹¤. í•˜ì§€ë§Œ ë¶„ëª…íˆ ë§ì”€ë“œë¦´ ìˆ˜ ìˆëŠ” ê±´, ì§€ì›ìë‹˜ì€ ì¶©ë¶„íˆ ì¤€ë¹„ë˜ì–´ ìˆë‹¤ëŠ” ê±°ì˜ˆìš”. ë‹¨ì§€ ê·¸ê²ƒì„ 'ì–´ë–»ê²Œ ë³´ì—¬ì¤„ ê²ƒì¸ê°€'ì˜ ë¬¸ì œë§Œ ë‚¨ì•˜ì„ ë¿ì…ë‹ˆë‹¤. ì œê°€ ë“œë¦° í”¼ë“œë°±ì´ ê·¸ ë§ˆì§€ë§‰ 1%ë¥¼ ì±„ìš°ëŠ” ë° ë„ì›€ì´ ë˜ê¸¸ ì§„ì‹¬ìœ¼ë¡œ ë°”ëë‹ˆë‹¤.
      
      [5ë¬¸ë‹¨ - ë§ˆì§€ë§‰ ë‹¹ë¶€]
      ë§ˆì§€ë§‰ìœ¼ë¡œ ê¼­ ê¸°ì–µí•˜ì…¨ìœ¼ë©´ í•˜ëŠ” ê²Œ ìˆì–´ìš”. ìì†Œì„œëŠ” 'ì™„ë²½í•œ ì‚¬ëŒ'ì„ ë³´ì—¬ì£¼ëŠ” ë¬¸ì„œê°€ ì•„ë‹ˆë¼, 'í•¨ê»˜ ì¼í•˜ê³  ì‹¶ì€ ì‚¬ëŒ'ì„ ë³´ì—¬ì£¼ëŠ” ë¬¸ì„œì…ë‹ˆë‹¤. ë„ˆë¬´ ì™„ë²½í•˜ë ¤ê³  í•˜ì§€ ë§ˆì‹œê³ , ì§€ì›ìë‹˜ì˜ ì§„ì§œ ëª¨ìŠµì„ ì „ëµì ìœ¼ë¡œ ë³´ì—¬ì£¼ì„¸ìš”. ì‹¤ìˆ˜ë„ í–ˆê³ , ì‹¤íŒ¨ë„ í–ˆì§€ë§Œ, ê·¸ê²ƒì„ í†µí•´ ì„±ì¥í•œ 'ì¸ê°„ì ì¸ í”„ë¡œí˜ì…”ë„'ì˜ ëª¨ìŠµì„ ë³´ì—¬ì£¼ì„¸ìš”. ê·¸ê²ƒì´ ë°”ë¡œ ìš°ë¦¬ê°€ ì°¾ëŠ” ì¸ì¬ì˜ ëª¨ìŠµì´ë‹ˆê¹Œìš”. ì§€ì›ìë‹˜ì˜ í•©ê²© ì†Œì‹ì„ ì§„ì‹¬ìœ¼ë¡œ ê¸°ë‹¤ë¦¬ê² ìŠµë‹ˆë‹¤. í™”ì´íŒ…!
      
      ---
      ğŸ’¼ 15ë…„ì°¨ ì¸ì‚¬íŒ€ ì„ ë°°ê°€ ë“œë¦¬ëŠ” ì§„ì‹¬ ì–´ë¦° ì¡°ì–¸
      
      ìê¸°ì†Œê°œì„œ ë‚´ìš©:
      #{content}
    PROMPT
    
    response = make_api_request(prompt, "ëŒ€ê¸°ì—… ì¸ì‚¬íŒ€ 15ë…„ ê²½ë ¥ ì„ ë°°", 8000)
    parse_response(response)[:content]
  end
  
  # [DEPRECATED] ê¸°ì—… ë¶„ì„ì„ ì‚¬ìš©í•˜ëŠ” ê¸°ì¡´ ë©”ì„œë“œ - í˜„ì¬ ë¯¸ì‚¬ìš©
  # def generate_customized_letter(company_name, position, company_analysis, cl_analysis, original_content)
  #   prompt = <<~PROMPT
  #     ë‹¹ì‹ ì€ ì „ë¬¸ ìê¸°ì†Œê°œì„œ ì‘ì„± ì»¨ì„¤í„´íŠ¸ì…ë‹ˆë‹¤. 

  #     **ì£¼ì–´ì§„ ì •ë³´:**
  #     - ëª©í‘œ ê¸°ì—…: #{company_name}
  #     - ì§€ì› ì§ë¬´: #{position}
  #     - ê¸°ì—… ë¶„ì„ ê²°ê³¼: 
  #     #{company_analysis}
      
  #     - ì§€ì›ì ë¶„ì„ ê²°ê³¼: 
  #     #{cl_analysis}
      
  #     - ê¸°ì¡´ ìê¸°ì†Œê°œì„œ: 
  #     #{original_content}

  #     **ì‘ì„± ê°€ì´ë“œë¼ì¸:**
  #     1. ê¸°ì—…ì˜ í˜„ì•ˆê³¼ ì§€ì›ì ê²½í—˜ì„ ìì—°ìŠ¤ëŸ½ê²Œ ì—°ê²°
  #     2. ê¸°ì—…ì´ ì›í•˜ëŠ” ì¸ì¬ìƒì— ë§ì¶° ê°•ì  ë¶€ê°
  #     3. êµ¬ì²´ì  ìˆ˜ì¹˜ì™€ ì„±ê³¼ë¡œ ì‹ ë¢°ì„± í™•ë³´
  #     4. ê¸°ì—… í‚¤ì›Œë“œë¥¼ ìì—°ìŠ¤ëŸ½ê²Œ í¬í•¨
  #     5. ì°¨ë³„í™”ëœ ì¸ì‚¬ì´íŠ¸ì™€ ê´€ì  ì œì‹œ

  #     **ì¶œë ¥ í˜•ì‹:**
  #     ## âœ¨ #{company_name} ë§ì¶¤ ìê¸°ì†Œê°œì„œ

  #     ### ì§€ì›ë™ê¸° ë° í¬ë¶€
  #     [ê¸°ì—… í˜„ì•ˆê³¼ ì—°ê²°ëœ ê°œì¸ ê²½í—˜ì„ ë°”íƒ•ìœ¼ë¡œ í•œ ë‹µë³€]
  #     - ê¸°ì—… ì´ìŠˆ ë°˜ì˜: [ì–´ë–¤ í˜„ì•ˆì„ ì–´ë–»ê²Œ ë°˜ì˜í–ˆëŠ”ì§€]
  #     - ì°¨ë³„í™” í¬ì¸íŠ¸: [ë‹¤ë¥¸ ì§€ì›ìì™€ êµ¬ë³„ë˜ëŠ” ê´€ì ]

  #     ### ì§ë¬´ ì—­ëŸ‰ ë° ê²½í—˜
  #     [ì§ë¬´ì™€ ê´€ë ¨ëœ êµ¬ì²´ì  ê²½í—˜ê³¼ ì„±ê³¼]
  #     - í•µì‹¬ ì—­ëŸ‰ ê°•ì¡°: [ê¸°ì—…ì´ ì›í•˜ëŠ” ì—­ëŸ‰ê³¼ ë§¤ì¹­]
  #     - ì„±ê³¼ ìˆ˜ì¹˜í™”: [êµ¬ì²´ì  ìˆ«ìì™€ ì„íŒ©íŠ¸]

  #     ### ì…ì‚¬ í›„ í¬ë¶€
  #     [ê¸°ì—…ì˜ ë¯¸ë˜ ë°©í–¥ì„±ê³¼ ì—°ê³„í•œ ë¹„ì „]
  #     - ê¸°ì—¬ ë°©ì•ˆ: [êµ¬ì²´ì ì¸ ê¸°ì—¬ ê³„íš]
  #     - ì„±ì¥ ë¹„ì „: [ì¥ê¸°ì  ëª©í‘œ]

  #     **ğŸ’¡ ì‘ì„± ì¸ì‚¬ì´íŠ¸:**
  #     - í™œìš©ëœ ê¸°ì—… í˜„ì•ˆ: [ë¦¬ìŠ¤íŠ¸]
  #     - ê°•ì¡°ëœ ê°œì¸ ì—­ëŸ‰: [ë¦¬ìŠ¤íŠ¸]  
  #     - ì°¨ë³„í™” ì „ëµ: [ì„¤ëª…]
  #   PROMPT
    
  #   response = make_api_request(prompt, "ìê¸°ì†Œê°œì„œ ì‘ì„± ì»¨ì„¤í„´íŠ¸", 6000)
  #   parse_response(response)[:content]
  # end
  
  # í”¼ë“œë°± ê¸°ë°˜ ê°œì„ ëœ ìê¸°ì†Œê°œì„œ ìƒì„±
  # rewrite_mode: 'preserve' (ì›ë³¸ ìœ ì§€) ë˜ëŠ” 'optimize' (AI ìµœì í™”)
  def generate_improved_letter(original_content, feedback_analysis, company_name = nil, position = nil, rewrite_mode = 'preserve')
    # ì›ë³¸ì—ì„œ í•­ëª© ì¶”ì¶œ
    original_sections = extract_sections_from_content(original_content)
    
    # ëª¨ë“œì— ë”°ë¥¸ í”„ë¡¬í”„íŠ¸ ì„¤ì •
    mode_instruction = if rewrite_mode == 'optimize'
      <<~MODE
        â­ï¸ AI ìµœì í™” ëª¨ë“œ:
        ì›ë³¸ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ê°€ì¥ íš¨ê³¼ì ì¸ ìì†Œì„œ êµ¬ì¡°ë¥¼ ì œì•ˆí•©ë‹ˆë‹¤.
        ì¼ë°˜ì ìœ¼ë¡œ íš¨ê³¼ì ì¸ ìì†Œì„œ í•­ëª©:
        1. ì§€ì› ë™ê¸°
        2. ì„±ì¥ ê³¼ì • (ë˜ëŠ” í•µì‹¬ ê²½í—˜)
        3. ì§ë¬´ ì—­ëŸ‰ (ë˜ëŠ” ê´€ë ¨ ê²½í—˜)
        4. í˜‘ì—…/ë„ì „ ê²½í—˜
        5. ì¥ì  ë° ë‹¨ì  (ì„ íƒì )
        6. ì…ì‚¬ í›„ í¬ë¶€
        
        ì›ë³¸ ë‚´ìš©ì„ ìœ„ êµ¬ì¡°ì— ë§ê²Œ ì¬êµ¬ì„±í•˜ë˜, ì›ë³¸ì˜ í•µì‹¬ ë‚´ìš©ì€ ëª¨ë‘ í¬í•¨ì‹œì¼œì£¼ì„¸ìš”.
      MODE
    else
      <<~MODE
        â­ï¸ ì›ë³¸ êµ¬ì¡° ìœ ì§€ ëª¨ë“œ:
        **ë°˜ë“œì‹œ ì›ë³¸ ìì†Œì„œì˜ í•­ëª©ê³¼ ë™ì¼í•œ êµ¬ì¡°ë¥¼ ìœ ì§€í•´ì•¼ í•©ë‹ˆë‹¤!**
        ì›ë³¸ í•­ëª©: #{original_sections.map.with_index { |s, i| "#{i+1}. #{s}" }.join(', ')}
        
        ìœ„ í•­ëª©ë“¤ì„ ì ˆëŒ€ ë³€ê²½í•˜ì§€ ë§ê³  ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ì„¸ìš”.
        ê° í•­ëª©ì˜ ë‚´ìš©ë§Œ ê°œì„ í•˜ê³ , í•­ëª© ìì²´ëŠ” ë³€ê²½í•˜ì§€ ë§ˆì„¸ìš”.
      MODE
    end
    
    prompt = <<~PROMPT
      ë‹¹ì‹ ì€ ëŒ€ê¸°ì—… ì¸ì‚¬íŒ€ì—ì„œ 15ë…„ ì´ìƒ ê·¼ë¬´í•˜ë©° ìˆ˜ë°± ëª…ì˜ ì§€ì›ì„œë¥¼ ê²€í† í•˜ê³  ë©´ì ‘ê´€ìœ¼ë¡œ í™œë™í•´ì˜¨ HR ì „ë¬¸ê°€ì´ì ë©˜í† ì…ë‹ˆë‹¤.
      ì•„ë˜ì—ëŠ” [ì§€ì›ìì˜ ìê¸°ì†Œê°œì„œ ì›ë³¸]ê³¼ [ë¶„ì„ í”¼ë“œë°±]ì´ ìˆìŠµë‹ˆë‹¤.
      
      ğŸ‘‰ ëª©ì :
      ë¶„ì„ í”¼ë“œë°±ì„ 100% ë°˜ì˜í•˜ì—¬ ìê¸°ì†Œê°œì„œë¥¼ **êµ¬ì²´ì ì´ê³  ì§„ì •ì„± ìˆê²Œ ë¦¬ë¼ì´íŠ¸**í•˜ì„¸ìš”.
      ìµœì¢… ê²°ê³¼ë¬¼ì€ HR ë‹´ë‹¹ìê°€ ì‹¤ì œë¡œ ì½ì—ˆì„ ë•Œ "ì§€ì›ìì˜ ê°•ì ì´ ëª…í™•íˆ ë³´ì´ê³ , ì§ë¬´ ì í•©ì„±ì´ ì‚´ì•„ë‚˜ëŠ” ìê¸°ì†Œê°œì„œ"ê°€ ë˜ë„ë¡ í•©ë‹ˆë‹¤.
      
      #{mode_instruction}
      
      â­ï¸ ì¤‘ìš”í•œ ì¶œë ¥ í˜•ì‹ ê·œì¹™:
      ê° í•­ëª©ì€ ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”:
      
      **í˜•ì‹ ì˜ˆì‹œ:**
      1. ì§€ì›ë™ê¸°
      [í•µì‹¬ ë©”ì‹œì§€ë¥¼ ë‹´ì€ í•œ ì¤„ ì œëª© - ì˜ˆ: ê³ ê° ì¤‘ì‹¬ ë§ˆì¼€íŒ…ìœ¼ë¡œ ì¼ìƒì˜ í˜ì‹ ì„ ë§Œë“¤ì–´ê°€ëŠ” ì—¬ì •]
      
      (ì²« ë²ˆì§¸ ë¬¸ë‹¨ - ë„ì…ë¶€: ë‚˜ì˜ ê´€ì‹¬ì‚¬ì™€ ê¸°ì—… ì—°ê²°)
      ì €ëŠ” ë³€í™”ì˜ íë¦„ì„ ì£¼ë„í•˜ë©° ê³ ê°ì˜ ì‚¶ì— ì‹¤ì§ˆì  ê°€ì¹˜ë¥¼ ë”í•˜ëŠ” ë§ˆì¼€íŒ…ì„ ê¿ˆê¿”ì™”ìŠµë‹ˆë‹¤...
      
      (ë‘ ë²ˆì§¸ ë¬¸ë‹¨ - ì¤‘ê°„ë¶€: êµ¬ì²´ì  ê²½í—˜ê³¼ ì„±ê³¼)
      ëŒ€í•™ ì‹œì ˆ ë§ì»¤ë¦¬ì–´ ì½˜í…ì¸  ì—ë””í„°ë¡œ í™œë™í•˜ë©´ì„œ...
      
      (ì„¸ ë²ˆì§¸ ë¬¸ë‹¨ - ë§ˆë¬´ë¦¬: ì…ì‚¬ í›„ í¬ë¶€ì™€ ë¹„ì „)
      ì‚¼ì„±ì „ìì˜ ë§ˆì¼€íŒ…íŒ€ì—ì„œ ê³ ê°ì˜ ëª©ì†Œë¦¬ë¥¼ ì§„ì •ì„± ìˆê²Œ ë“£ê³ ...
      
      ğŸ‘‰ ì‘ì„± ê·œì¹™:
      1. **ì›ë³¸ ìì†Œì„œì˜ í•­ëª© ìˆœì„œì™€ ì œëª©ì„ 100% ë™ì¼í•˜ê²Œ ìœ ì§€í•©ë‹ˆë‹¤.**
         ì˜ˆ: ì›ë³¸ì´ "1. ì§€ì› ë™ê¸°, 2. ì„±ì¥ ê³¼ì •, 3. í˜‘ì—… ê²½í—˜"ì´ë©´
             ë¦¬ë¼ì´íŠ¸ë„ "1. ì§€ì› ë™ê¸°, 2. ì„±ì¥ ê³¼ì •, 3. í˜‘ì—… ê²½í—˜"ìœ¼ë¡œ ì‘ì„±
      2. ê° í•­ëª©ë§ˆë‹¤ ë°˜ë“œì‹œ [í•œ ì¤„ ì œëª©] + 3ê°œ ë¬¸ë‹¨ êµ¬ì„±ì„ ì§€ì¼œì£¼ì„¸ìš”.
      3. í•œ ì¤„ ì œëª©ì€ í•´ë‹¹ í•­ëª©ì˜ í•µì‹¬ ë©”ì‹œì§€ë¥¼ ì••ì¶•ì ìœ¼ë¡œ í‘œí˜„í•©ë‹ˆë‹¤.
      4. ê° ë¬¸ë‹¨ì€ ìµœì†Œ 4-5ë¬¸ì¥ ì´ìƒìœ¼ë¡œ ì¶©ì‹¤í•˜ê²Œ ì‘ì„±í•©ë‹ˆë‹¤.
      5. ëª¨ë“  ê²½í—˜ì€ **ìƒí™© â†’ í–‰ë™ â†’ ì„±ê³¼ â†’ ë°°ìš´ ì  â†’ ì§ë¬´ ì—°ê²°**ì˜ êµ¬ì¡°ë¡œ ì‘ì„±í•©ë‹ˆë‹¤.
      6. í”¼ë“œë°±ì—ì„œ ì œì‹œëœ ëª¨ë“  ê°œì„ ì ì„ ë°˜ë“œì‹œ ìˆ˜ì •í•˜ì—¬ ë°˜ì˜í•©ë‹ˆë‹¤:
         - ê²½í—˜ ë‚˜ì—´ë¡œ ì¸í•œ í•µì‹¬ ë©”ì‹œì§€ í¬ì„ â†’ ê° ê²½í—˜ì˜ ì˜ë¯¸ë¥¼ ëª…í™•íˆ êµ¬ë¶„
         - ìê¸°ë§Œì˜ ìƒ‰ê¹” ë¶€ì¡± â†’ ì°¨ë³„í™”ëœ ì‹œê°ê³¼ ë…íŠ¹í•œ ê²½í—˜ ë¶€ê°
         - ê³¼ì •ê³¼ ë‚´ë©´ ì„œì‚¬ ë¶€ì¡± â†’ ê³ ë¯¼ê³¼ ì‹œí–‰ì°©ì˜¤, ì„±ì°° ê³¼ì • ì¶”ê°€
         - íšŒì‚¬ ë§ì¶¤í˜• ë™ê¸° ë¶€ì¡± â†’ ì§€ì› ê¸°ì—…ë§Œì˜ íŠ¹ì„±ê³¼ ì—°ê²°
         - ë‹¨ì  ì„œìˆ  ì„íŒ©íŠ¸ ë¶€ì¡± â†’ êµ¬ì²´ì  ì‹¤íŒ¨ ê²½í—˜ê³¼ ê°œì„  ì„±ê³¼ ì œì‹œ
      6. ê°•ì ì€ êµ¬ì²´ì  ì‚¬ë¡€ì™€ ìˆ˜ì¹˜ë¡œ ê°•ì¡°í•˜ê³ , ë‹¨ì ì€ ì‹¤ì œ ì‹¤íŒ¨ ê²½í—˜ê³¼ ê°œì„  ê³¼ì •ì„ í¬í•¨í•©ë‹ˆë‹¤.
      7. ëª¨ë“  ì¶”ìƒì  í‘œí˜„ì„ êµ¬ì²´ì  ì—í”¼ì†Œë“œë¡œ ëŒ€ì²´í•©ë‹ˆë‹¤.
      8. STAR ê¸°ë²•(Situation-Task-Action-Result)ì„ ì² ì €íˆ ì ìš©í•©ë‹ˆë‹¤.
      9. ê¸€ ì „ì²´ì˜ í†¤ì€ ì§„ì •ì„± ìˆê³  ì„¤ë“ë ¥ ìˆê²Œ, HR ë‹´ë‹¹ìê°€ ì½ê¸° í¸í•œ ë¬¸ì²´ë¡œ ì‘ì„±í•©ë‹ˆë‹¤.
      10. **ê²©ë ¤ ë©˜í†  ì½”ë©˜íŠ¸ëŠ” í¬í•¨í•˜ì§€ ì•Šê³ , ìµœì¢… ìê¸°ì†Œê°œì„œ ì›ê³  í˜•íƒœë¡œë§Œ ì¶œë ¥**í•©ë‹ˆë‹¤.
      
      #{company_name ? "ğŸ“Œ ì§€ì› ê¸°ì—…: #{company_name}" : ""}
      #{position ? "ğŸ“Œ ì§€ì› ì§ë¬´: #{position}" : ""}
      
      [ì§€ì›ìì˜ ìê¸°ì†Œê°œì„œ ì›ë³¸]
      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      #{original_content}
      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      
      [ë¶„ì„ í”¼ë“œë°±]
      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      #{feedback_analysis}
      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      
      ğŸ‘‰ ì¶œë ¥:
      ìœ„ ë¶„ì„ í”¼ë“œë°±ì„ ì¶©ì‹¤íˆ ë°˜ì˜í•œ **ìµœì¢… ìê¸°ì†Œê°œì„œ ë¦¬ë¼ì´íŠ¸ ë²„ì „**ì„ ì‘ì„±í•´ ì£¼ì„¸ìš”.
      
      âš ï¸ ë§¤ìš° ì¤‘ìš”í•œ ê·œì¹™:
      1. **ì›ë³¸ ìì†Œì„œì˜ í•­ëª©ì„ 100% ë™ì¼í•˜ê²Œ ìœ ì§€í•©ë‹ˆë‹¤**
         ì›ë³¸ í•­ëª©: #{original_sections.map.with_index { |s, i| "#{i+1}. #{s}" }.join(', ')}
      2. ìœ„ í•­ëª©ë“¤ì„ ì ˆëŒ€ ë³€ê²½í•˜ì§€ ë§ê³  ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ì„¸ìš”
      3. ê° í•­ëª©ë§ˆë‹¤ [í•œ ì¤„ ì œëª©] + 3ê°œ ë¬¸ë‹¨ êµ¬ì„±ì„ ì§€ì¼œì£¼ì„¸ìš”
      4. ì›ë³¸ì— ìˆëŠ” ëª¨ë“  í•­ëª©ì„ ë¹ ì§ì—†ì´ í¬í•¨í•˜ê³ , ëê¹Œì§€ ì™„ì„±í•´ì£¼ì„¸ìš”
      5. ì ˆëŒ€ í•­ëª©ëª…ì„ ë°”ê¾¸ì§€ ë§ˆì„¸ìš” (ì˜ˆ: "ì§€ì› ë™ê¸°"ë¥¼ "ì§€ì›ë™ê¸°"ë¡œ ë°”ê¾¸ì§€ ë§ ê²ƒ)
    PROMPT
    
    # max_tokensë¥¼ ì¶©ë¶„íˆ í¬ê²Œ ì„¤ì •
    response = make_api_request(prompt, "ìê¸°ì†Œê°œì„œ ë¦¬ë¼ì´íŒ… HR ì „ë¬¸ê°€", 12000)
    
    # ì‘ë‹µì—ì„œ ë¶ˆí•„ìš”í•œ ë©”íƒ€ í…ìŠ¤íŠ¸ ì œê±°
    content = parse_response(response)[:content] || ""
    
    # ë‚´ìš©ì´ ë„ˆë¬´ ì§§ìœ¼ë©´ ì—ëŸ¬ ë¡œê·¸
    if content.length < 2000
      Rails.logger.error "ë¦¬ë¼ì´íŠ¸ ê²°ê³¼ê°€ ë„ˆë¬´ ì§§ìŒ: #{content.length}ì"
      Rails.logger.error "ì›ë³¸ ì‘ë‹µì˜ ì²« 500ì: #{content[0..500]}"
    end
    
    content
  end
  
  # ìê¸°ì†Œê°œì„œ ë¶„ì„ ê²°ê³¼ í¬ë§·íŒ…
  def format_cover_letter_analysis(analysis)
    <<~FORMATTED
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      ğŸ“ ìê¸°ì†Œê°œì„œ ì‹¬ì¸µ ë¶„ì„ ê²°ê³¼
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      #{analysis}
      
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      ğŸ’¡ ë¶„ì„ ì™„ë£Œ | HR ë©˜í† ë§ ê´€ì  í”¼ë“œë°±
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    FORMATTED
  end
  
  # ê°„ë‹¨í•œ ì „ì²´ ë¶„ì„ í¬ë§·íŒ… (ê¸°ì—… ë¶„ì„ ì œì™¸)
  def format_full_analysis_simple(cover_letter_analysis, customized_letter)
    <<~ANALYSIS
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      ğŸ¯ AI ìê¸°ì†Œê°œì„œ ë¶„ì„ ë° ê°œì„  ì™„ë£Œ
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      ## ğŸ“ ìê¸°ì†Œê°œì„œ ë¶„ì„
      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      #{cover_letter_analysis}
      
      ## âœ¨ ê°œì„ ëœ ìê¸°ì†Œê°œì„œ
      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      #{customized_letter}
      
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      ğŸ’¼ ë¶„ì„ ì™„ë£Œ | Powered by GPT-4o
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    ANALYSIS
  end
  
  def format_full_analysis(company_analysis, cl_analysis, customized_letter)
    <<~ANALYSIS
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      ğŸ¯ AI ìê¸°ì†Œê°œì„œ 3ë‹¨ê³„ ì‹¬ì¸µ ë¶„ì„ ì™„ë£Œ
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      #{company_analysis}
      
      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      
      #{cl_analysis}
      
      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      
      #{customized_letter}
      
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      ğŸ’¼ ë¶„ì„ ì™„ë£Œ | Powered by GPT-4o
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    ANALYSIS
  end
  
  def make_api_request(prompt, role_description, max_tokens = 3000)
    uri = URI(OPENAI_API_URL)
    http = Net::HTTP.new(uri.host, uri.port)
    http.use_ssl = true
    http.read_timeout = 180  # 3ë¶„ìœ¼ë¡œ ì¦ê°€
    
    request = Net::HTTP::Post.new(uri)
    request['Authorization'] = "Bearer #{@api_key}"
    request['Content-Type'] = 'application/json'
    
    request.body = {
      model: @model,
      messages: [
        {
          role: 'system',
          content: "ë‹¹ì‹ ì€ #{role_description}ì…ë‹ˆë‹¤. í•œêµ­ ê¸°ì—…ê³¼ ì±„ìš© ì‹œì¥ì— ëŒ€í•œ ê¹Šì€ ì´í•´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì „ë¬¸ì ì´ê³  ì‹¤ìš©ì ì¸ ì¡°ì–¸ì„ ì œê³µí•©ë‹ˆë‹¤."
        },
        {
          role: 'user',
          content: prompt
        }
      ],
      temperature: 0.7,
      max_tokens: max_tokens
    }.to_json
    
    response = http.request(request)
    JSON.parse(response.body)
  end
  
  def parse_response(response)
    if response['error']
      { error: response['error']['message'] }
    elsif response['choices'] && response['choices'].first
      {
        success: true,
        content: response['choices'].first['message']['content'],
        usage: response['usage']
      }
    else
      { error: 'ì˜ˆìƒì¹˜ ëª»í•œ ì‘ë‹µ í˜•ì‹ì…ë‹ˆë‹¤' }
    end
  end

  def extract_sections_from_content(content)
    # ìì†Œì„œ ë‚´ìš©ì„ ì„¹ì…˜ë³„ë¡œ ë¶„ë¦¬
    sections = []
    
    # ìˆ«ìë¡œ ì‹œì‘í•˜ëŠ” ì„¹ì…˜ íŒ¨í„´ (ì˜ˆ: "1. ì§€ì›ë™ê¸°", "2. ì„±ì¥ê³¼ì •" ë“±)
    section_pattern = /^(\d+)\.\s*(.+?)(?=\n\d+\.\s+|\z)/m
    
    content.scan(section_pattern) do |number, section_content|
      title_and_content = section_content.split("\n", 2)
      title = title_and_content[0].strip
      body = title_and_content[1]&.strip || ""
      
      sections << {
        number: number,
        title: title,
        content: body
      }
    end
    
    # ì„¹ì…˜ì´ ì—†ìœ¼ë©´ ì „ì²´ë¥¼ í•˜ë‚˜ì˜ ì„¹ì…˜ìœ¼ë¡œ ì²˜ë¦¬
    if sections.empty?
      sections << {
        number: "1",
        title: "ìê¸°ì†Œê°œì„œ",
        content: content.strip
      }
    end
    
    sections
  end
end