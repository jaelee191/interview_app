require 'net/http'
require 'json'

class AdvancedCoverLetterService
  OPENAI_API_URL = 'https://api.openai.com/v1/chat/completions'
  
  def initialize
    @api_key = ENV['OPENAI_API_KEY']
    @model = ENV['OPENAI_MODEL'] || 'gpt-4.1'
  end
  
  def analyze_complete(content, company_name, position)
    return { error: "API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤" } unless @api_key
    
    # 1ë‹¨ê³„: ê¸°ì—… ë¶„ì„
    company_analysis = analyze_company(company_name)
    
    # 2ë‹¨ê³„: ìê¸°ì†Œê°œì„œ ë¶„ì„
    cover_letter_analysis = analyze_cover_letter(content)
    
    # 3ë‹¨ê³„: ë§ì¶¤í˜• ìê¸°ì†Œê°œì„œ ìƒì„±
    customized_letter = generate_customized_letter(
      company_name, 
      position,
      company_analysis,
      cover_letter_analysis,
      content
    )
    
    {
      success: true,
      company_analysis: company_analysis,
      cover_letter_analysis: cover_letter_analysis,
      customized_letter: customized_letter,
      full_analysis: format_full_analysis(company_analysis, cover_letter_analysis, customized_letter)
    }
  rescue StandardError => e
    Rails.logger.error "ê³ ê¸‰ ë¶„ì„ ì˜¤ë¥˜: #{e.message}"
    { error: "ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: #{e.message}" }
  end
  
  private
  
  def analyze_company(company_name)
    prompt = <<~PROMPT
      ë‹¹ì‹ ì€ ê¸°ì—… ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. #{company_name}ì— ëŒ€í•´ ë‹¤ìŒì„ ë¶„ì„í•´ì£¼ì„¸ìš”:

      **ë¶„ì„ í•­ëª©:**
      1. ê¸°ì—…ì˜ í•µì‹¬ ì‚¬ì—… ë¶„ì•¼ì™€ ë¹„ì „
      2. ìµœê·¼ 1ë…„ê°„ ì£¼ìš” ì´ìŠˆ ë° í˜„ì•ˆ (ê²½ì˜ì§„ ë°œì–¸, ì‹ ì‚¬ì—…, ìœ„ê¸°ìƒí™© ë“±)
      3. ì—…ê³„ ë‚´ í¬ì§€ì…˜ê³¼ ê²½ìŸìš°ìœ„
      4. ê¸°ì—…ì´ ì¶”êµ¬í•˜ëŠ” ì¸ì¬ìƒê³¼ í•µì‹¬ ì—­ëŸ‰
      5. ì¡°ì§ë¬¸í™”ì™€ ê°€ì¹˜ê´€

      **ì¶œë ¥ í˜•ì‹:**
      ## ğŸ¢ #{company_name} ë¶„ì„ ë¦¬í¬íŠ¸
      **í•µì‹¬ ì‚¬ì—…:** [ê°„ë‹¨ ì„¤ëª…]
      **ìµœê·¼ í˜„ì•ˆ:** [3-5ê°œ ì£¼ìš” ì´ìŠˆ]
      **ì¸ì¬ìƒ:** [ì›í•˜ëŠ” ì¸ì¬ ìœ í˜•]
      **í‚¤ì›Œë“œ:** [í•µì‹¬ í‚¤ì›Œë“œ 5ê°œ]
      
      í•œêµ­ ê¸°ì—…ì˜ ìµœì‹  ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ êµ¬ì²´ì ìœ¼ë¡œ ë¶„ì„í•´ì£¼ì„¸ìš”.
    PROMPT
    
    response = make_api_request(prompt, "ê¸°ì—… ë¶„ì„ ì „ë¬¸ê°€")
    parse_response(response)[:content]
  end
  
  def analyze_cover_letter(content)
    prompt = <<~PROMPT
      ë‹¹ì‹ ì€ êµ­ë‚´ ëŒ€ê¸°ì—… ì¸ì‚¬íŒ€ì—ì„œ 15ë…„ê°„ ìˆ˜ë§Œ ê±´ì˜ ìê¸°ì†Œê°œì„œë¥¼ í‰ê°€í•´ì˜¨ ì„ ë°°ì…ë‹ˆë‹¤.
      í›„ë°°ì—ê²Œ ì§„ì‹¬ ì–´ë¦° ì¡°ì–¸ì„ í•´ì£¼ë“¯ì´, ë”°ëœ»í•˜ë©´ì„œë„ ì†”ì§í•œ í”¼ë“œë°±ì„ ì œê³µí•´ì£¼ì„¸ìš”.
      
      ## ğŸ“ ìê¸°ì†Œê°œì„œ ì‹¬ì¸µ ë¶„ì„
      
      ì•ˆë…•í•˜ì„¸ìš”, ìê¸°ì†Œê°œì„œë¥¼ ê¼¼ê¼¼íˆ ì½ì–´ë³´ì•˜ìŠµë‹ˆë‹¤.
      
      ### ğŸ¯ ì²«ì¸ìƒê³¼ ì „ì²´ì ì¸ ëŠë‚Œ
      [ìê¸°ì†Œê°œì„œë¥¼ ì²˜ìŒ ì½ì—ˆì„ ë•Œì˜ ì†”ì§í•œ ì¸ìƒì„ 3-4ë¬¸ì¥ìœ¼ë¡œ í’ë¶€í•˜ê²Œ ì„œìˆ ]
      "ì•ˆë…•í•˜ì„¸ìš”! ìê¸°ì†Œê°œì„œë¥¼ ì²˜ìŒ ì½ì—ˆì„ ë•Œ ~í•œ ëŠë‚Œì„ ë°›ì•˜ìŠµë‹ˆë‹¤. 
      íŠ¹íˆ ~ë¶€ë¶„ì—ì„œ ~í•œ ì ì´ ë§¤ìš° ì¸ìƒì ì´ì—ˆê³ , ~í•œ ì—­ëŸ‰ì´ ë‹ë³´ì˜€ìŠµë‹ˆë‹¤.
      ì „ë°˜ì ìœ¼ë¡œ ~í•œ ì§€ì›ìë¡œ ë³´ì´ë©°, ~í•œ ì ì¬ë ¥ì´ ëŠê»´ì§‘ë‹ˆë‹¤.
      ë‹¤ë§Œ ~í•œ ë¶€ë¶„ì€ ì¡°ê¸ˆ ë” ë³´ì™„í•˜ë©´ í›¨ì”¬ ì¢‹ì„ ê²ƒ ê°™ë„¤ìš”."
      
      ### ğŸ’ª ì˜ ì“´ ë¶€ë¶„ (ì´ê±´ ì •ë§ ì¢‹ì•„ìš”!)
      [êµ¬ì²´ì ìœ¼ë¡œ ì–´ë–¤ ë¶€ë¶„ì´ ì™œ ì¢‹ì€ì§€ ì„ ë°°ì˜ ê´€ì ì—ì„œ ìƒì„¸í•˜ê²Œ ì„¤ëª…]
      
      1. **[êµ¬ì²´ì ì¸ ê°•ì  ì œëª©]**
         "~ë¶€ë¶„ì—ì„œ ~í•˜ê²Œ í‘œí˜„í•œ ê²ƒì´ ì •ë§ ì¢‹ì•˜ìŠµë‹ˆë‹¤. íŠ¹íˆ '~'ë¼ëŠ” í‘œí˜„ì€ ì •ë§ ì¸ìƒì ì´ì—ˆì–´ìš”.
         ì‹¤ì œë¡œ ì¸ì‚¬íŒ€ì—ì„œëŠ” ì´ëŸ° ë¶€ë¶„ì„ ë†’ê²Œ í‰ê°€í•˜ëŠ”ë°, ì™œëƒí•˜ë©´ ~í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. 
         ì œê°€ ë³¸ í•©ê²©ìë“¤ ì¤‘ ìƒìœ„ 10%ê°€ ì´ëŸ° ì‹ìœ¼ë¡œ ì‘ì„±í–ˆìŠµë‹ˆë‹¤. 
         ë§ì€ ì§€ì›ìë“¤ì´ ë†“ì¹˜ëŠ” ë¶€ë¶„ì¸ë° ì •í™•íˆ ì§šì–´ì£¼ì…¨ë„¤ìš”."
      
      2. **[ë‘ ë²ˆì§¸ ê°•ì  ì œëª©]**
         "~ê²½í—˜ì„ ~í•˜ê²Œ í’€ì–´ë‚¸ ê²ƒë„ íƒì›”í–ˆìŠµë‹ˆë‹¤. 
         ë‹¨ìˆœíˆ '~í–ˆë‹¤'ê°€ ì•„ë‹ˆë¼ '~ë¥¼ í†µí•´ ~ë¥¼ ë‹¬ì„±í–ˆê³ , ê·¸ ê³¼ì •ì—ì„œ ~ë¥¼ ë°°ì› ë‹¤'ëŠ” ì‹ìœ¼ë¡œ
         ê³¼ì •-ê²°ê³¼-í•™ìŠµì„ ëª¨ë‘ ë‹´ì•„ë‚¸ ì ì´ í”„ë¡œí˜ì…”ë„í•©ë‹ˆë‹¤.
         ì´ëŸ° ì„œìˆ  ë°©ì‹ì€ ì§€ì›ìì˜ ì‚¬ê³  í”„ë¡œì„¸ìŠ¤ë¥¼ ì˜ ë³´ì—¬ì£¼ê¸° ë•Œë¬¸ì— ë©´ì ‘ê´€ë“¤ì´ ì¢‹ì•„í•©ë‹ˆë‹¤."
      
      3. **[ì„¸ ë²ˆì§¸ ê°•ì  ì œëª©]**
         "ë˜í•œ ~í•œ ë¶€ë¶„ë„ ëˆˆì—¬ê²¨ë´¤ìŠµë‹ˆë‹¤. ë³´í†µ ì‹ ì… ì§€ì›ìë“¤ì€ ~í•˜ê²Œ ì“°ëŠ” ê²½í–¥ì´ ìˆëŠ”ë°,
         ë‹¹ì‹ ì€ ~í•˜ê²Œ ì ‘ê·¼í–ˆë”êµ°ìš”. ì´ê±´ ê²½ë ¥ìë“¤ë„ ì‰½ê²Œ í•˜ì§€ ëª»í•˜ëŠ” ë¶€ë¶„ì…ë‹ˆë‹¤.
         íŠ¹íˆ '~' ë¶€ë¶„ì€ ì •ë§ ì°¨ë³„í™”ëœ ê´€ì ì´ì—ˆì–´ìš”."
      
      ### ğŸ˜Ÿ ì•„ì‰¬ìš´ ë¶€ë¶„ (ì´ê±´ ê¼­ ë³´ì™„í•˜ì„¸ìš”)
      [ê°œì„ ì´ í•„ìš”í•œ ë¶€ë¶„ì„ ë¶€ë“œëŸ½ì§€ë§Œ ëª…í™•í•˜ê²Œ, ê·¸ë¦¬ê³  ìƒì„¸í•˜ê²Œ ì§€ì ]
      
      1. **[êµ¬ì²´ì ì¸ ê°œì„ ì  ì œëª©]**
         "~ë¶€ë¶„ì´ ì¡°ê¸ˆ ì•„ì‰¬ì› ìŠµë‹ˆë‹¤. ì§€ê¸ˆ '~'ë¼ê³  ì“°ì…¨ëŠ”ë°, ì´ í‘œí˜„ì´ ë„ˆë¬´ ì¶”ìƒì ì´ì—ìš”.
         ì˜ˆë¥¼ ë“¤ì–´ '~ë¥¼ ê°œë°œí•˜ê² ë‹¤'ë³´ë‹¤ëŠ” '~ê¸°ìˆ ì„ í™œìš©í•˜ì—¬ ~ë¥¼ ~% ê°œì„ í•˜ëŠ” ~ì‹œìŠ¤í…œì„ êµ¬ì¶•í•˜ê² ë‹¤'ì²˜ëŸ¼
         êµ¬ì²´ì ì¸ ë°©ë²•ë¡ ê³¼ ì˜ˆìƒ ì„±ê³¼ê¹Œì§€ ì œì‹œí•˜ë©´ í›¨ì”¬ ì„¤ë“ë ¥ì´ ìˆì„ ê±°ì˜ˆìš”.
         
         ì œê°€ ë³¸ í•©ê²©ìë“¤ì€ ëŒ€ë¶€ë¶„ ì´ëŸ° ì‹ìœ¼ë¡œ ì‘ì„±í–ˆìŠµë‹ˆë‹¤:
         'í˜„ì¬ ~ì˜ ë¬¸ì œì ì„ íŒŒì•…í•˜ê³ , ~ê¸°ìˆ ì„ ì ìš©í•˜ì—¬ 3ê°œì›” ë‚´ ~ë¥¼ ë‹¬ì„±í•˜ê² ìŠµë‹ˆë‹¤.'
         
         ì´ë ‡ê²Œ ì“°ë©´ ë©´ì ‘ê´€ì´ 'ì•„, ì´ ì‚¬ëŒì€ ì •ë§ êµ¬ì²´ì ì¸ ê³„íšì´ ìˆêµ¬ë‚˜'ë¼ê³  ëŠë‚ë‹ˆë‹¤."
      
      2. **[ë‘ ë²ˆì§¸ ê°œì„ ì  ì œëª©]**
         "~ê²½í—˜ì„ ì„¤ëª…í•˜ì‹  ë¶€ë¶„ë„ ë³´ì™„ì´ í•„ìš”í•©ë‹ˆë‹¤. 
         '~ë¥¼ í–ˆìŠµë‹ˆë‹¤'ë¡œ ëë‚˜ëŠ”ë°, ì—¬ê¸°ì„œ ë” ë‚˜ì•„ê°€ì•¼ í•´ìš”.
         
         ì¸ì‚¬ë‹´ë‹¹ìë“¤ì´ ì •ë§ ê¶ê¸ˆí•´í•˜ëŠ” ê±´ ì´ëŸ° ê²ƒë“¤ì…ë‹ˆë‹¤:
         â€¢ ì™œ ê·¸ ë°©ë²•ì„ ì„ íƒí–ˆë‚˜ìš”?
         â€¢ ì–´ë–¤ ì–´ë ¤ì›€ì´ ìˆì—ˆê³ , ì–´ë–»ê²Œ ê·¹ë³µí–ˆë‚˜ìš”?
         â€¢ ê·¸ ê²½í—˜ì—ì„œ ë¬´ì—‡ì„ ë°°ì› ê³ , ìš°ë¦¬ íšŒì‚¬ì—ì„œ ì–´ë–»ê²Œ í™œìš©í•  ê±´ê°€ìš”?
         
         ì˜ˆë¥¼ ë“¤ì–´ ì´ë ‡ê²Œ ìˆ˜ì •í•´ë³´ì„¸ìš”:
         '~í”„ë¡œì íŠ¸ì—ì„œ ~ë¬¸ì œì— ì§ë©´í–ˆì„ ë•Œ, Aì•ˆê³¼ Bì•ˆì„ ë¹„êµ ê²€í† í•œ ê²°ê³¼ ~ë•Œë¬¸ì— Bë¥¼ ì„ íƒí–ˆê³ ,
         ~ë¼ëŠ” ì˜ˆìƒì¹˜ ëª»í•œ ì´ìŠˆë¥¼ ~ë°©ë²•ìœ¼ë¡œ í•´ê²°í•˜ì—¬ ìµœì¢…ì ìœ¼ë¡œ ~ì„±ê³¼ë¥¼ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤.
         ì´ ê²½í—˜ì„ í†µí•´ ~ë¥¼ ë°°ì› ê³ , ê·€ì‚¬ì—ì„œ ~ì—…ë¬´ ì‹œ ì´ë¥¼ í™œìš©í•˜ì—¬ ~í•˜ê² ìŠµë‹ˆë‹¤.'"
      
      3. **[ì„¸ ë²ˆì§¸ ê°œì„ ì  ì œëª©]**
         "ë§ˆì§€ë§‰ìœ¼ë¡œ ~ë¶€ë¶„ì¸ë°ìš”, ì´ ë¶€ë¶„ì€ ì •ë§ ì¤‘ìš”í•œë° ë„ˆë¬´ ê°„ëµí•˜ê²Œ ì§€ë‚˜ê°€ì…¨ì–´ìš”.
         ì§€ê¸ˆì€ '~í•˜ê² ìŠµë‹ˆë‹¤'ë¡œë§Œ ë˜ì–´ ìˆëŠ”ë°, HOWê°€ ë¹ ì ¸ìˆìŠµë‹ˆë‹¤.
         
         ì´ ë¶€ë¶„ì„ ì´ë ‡ê²Œ í™•ì¥í•´ë³´ì„¸ìš”:
         â€¢ ë‹¨ê¸°(ì…ì‚¬ í›„ 3ê°œì›”): ~ë¥¼ íŒŒì•…í•˜ê³  ~ë¥¼ ìŠµë“í•˜ì—¬ ~
         â€¢ ì¤‘ê¸°(1ë…„): ~í”„ë¡œì íŠ¸ë¥¼ ì£¼ë„í•˜ì—¬ ~ì„±ê³¼ ì°½ì¶œ
         â€¢ ì¥ê¸°(3ë…„): ~ë¶„ì•¼ì˜ ì „ë¬¸ê°€ë¡œ ì„±ì¥í•˜ì—¬ ~ì— ê¸°ì—¬
         
         ì´ë ‡ê²Œ êµ¬ì²´ì ì¸ ë¡œë“œë§µì„ ì œì‹œí•˜ë©´ 'ì¤€ë¹„ëœ ì¸ì¬'ë¼ëŠ” ì¸ìƒì„ ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤."
      
      ### ğŸ” ë†“ì¹˜ê³  ìˆëŠ” ìˆ¨ì€ ë³´ì„ë“¤
      "ìê¸°ì†Œê°œì„œë¥¼ ì½ìœ¼ë©´ì„œ 'ì•„, ì´ ê²½í—˜ë„ ìˆëŠ”ë° ì™œ ì•ˆ ì¼ì„ê¹Œ?' ì‹¶ì€ ë¶€ë¶„ë“¤ì´ ìˆì—ˆìŠµë‹ˆë‹¤.
      
      â€¢ **[ì ì¬ ê²½í—˜ 1]**: ~í•˜ì‹  ê²½í—˜ì´ ìˆë‹¤ë©´, ì´ê±´ ê¼­ ë„£ìœ¼ì…”ì•¼ í•´ìš”. ì™œëƒí•˜ë©´ ~
      â€¢ **[ì ì¬ ê²½í—˜ 2]**: ~ëŠ¥ë ¥ì„ ë³´ì—¬ì¤„ ìˆ˜ ìˆëŠ” ì—í”¼ì†Œë“œê°€ ìˆë‹¤ë©´ ~ë¶€ë¶„ì— ì¶”ê°€í•˜ë©´ ì¢‹ê² ìŠµë‹ˆë‹¤.
      â€¢ **[ì ì¬ ê²½í—˜ 3]**: í˜¹ì‹œ ~í•´ë³¸ ì  ìˆìœ¼ì‹ ê°€ìš”? ìˆë‹¤ë©´ ì´ê±´ ì •ë§ ì°¨ë³„í™” í¬ì¸íŠ¸ê°€ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      
      ### ğŸ’¡ ì¸ì‚¬ë‹´ë‹¹ìì˜ ì‹œì„ ìœ¼ë¡œ ë³¸ ì˜ˆìƒ ì§ˆë¬¸
      "ë§Œì•½ ì œê°€ ë©´ì ‘ê´€ì´ë¼ë©´ ì´ëŸ° ì§ˆë¬¸ì„ í•˜ê³  ì‹¶ì„ ê²ƒ ê°™ì•„ìš”:
      
      1. "[ì˜ˆìƒ ì§ˆë¬¸ 1]" 
         â†’ ì´ ì§ˆë¬¸ì´ ë‚˜ì˜¬ ìˆ˜ ìˆìœ¼ë‹ˆ ~ì— ëŒ€í•´ ì¤€ë¹„í•˜ì‹œë©´ ì¢‹ê² ìŠµë‹ˆë‹¤.
      
      2. "[ì˜ˆìƒ ì§ˆë¬¸ 2]"
         â†’ ìì†Œì„œì—ì„œ ~ë¶€ë¶„ì´ ì• ë§¤í•´ì„œ ë‚˜ì˜¬ ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤.
      
      3. "[ì˜ˆìƒ ì§ˆë¬¸ 3]"
         â†’ ~ê²½í—˜ì— ëŒ€í•´ ë” êµ¬ì²´ì ìœ¼ë¡œ ë¬¼ì–´ë³¼ ê²ƒ ê°™ë„¤ìš”.
      
      ### ğŸ“Š í˜„ì‹¤ì ì¸ í‰ê°€ (100ì  ë§Œì )
      
      **í˜„ì¬ ì ìˆ˜: [ì ìˆ˜]/100ì **
      
      ì†”ì§íˆ ë§ì”€ë“œë¦¬ë©´, í˜„ì¬ ìƒíƒœë¡œëŠ” **[ìƒìœ„ ëª‡%]** ì •ë„ ìˆ˜ì¤€ì…ë‹ˆë‹¤.
      [ì ìˆ˜ì— ëŒ€í•œ ë”°ëœ»í•˜ì§€ë§Œ í˜„ì‹¤ì ì¸ ì„¤ëª…]
      
      â€¢ êµ¬ì¡°ì™€ ë…¼ë¦¬ì„±: [ì ìˆ˜]/20 - [í•œ ì¤„ í‰ê°€]
      â€¢ êµ¬ì²´ì„±ê³¼ ì‹ ë¢°ì„±: [ì ìˆ˜]/20 - [í•œ ì¤„ í‰ê°€]  
      â€¢ ì°¨ë³„í™”: [ì ìˆ˜]/20 - [í•œ ì¤„ í‰ê°€]
      â€¢ ì§ë¬´ ì í•©ì„±: [ì ìˆ˜]/20 - [í•œ ì¤„ í‰ê°€]
      â€¢ ë¬¸ì¥ë ¥: [ì ìˆ˜]/20 - [í•œ ì¤„ í‰ê°€]
      
      
      ### ğŸ’¬ ë§ˆì§€ë§‰ìœ¼ë¡œ...
      
      [ê²©ë ¤ì™€ ì‘ì›ì˜ ë©”ì‹œì§€ë¥¼ 2-3ë¬¸ì¥ìœ¼ë¡œ]
      ì˜ˆì‹œ: "ì „ë°˜ì ìœ¼ë¡œ ~í•œ ì ì¬ë ¥ì´ ë³´ì´ëŠ” ìê¸°ì†Œê°œì„œì…ë‹ˆë‹¤. íŠ¹íˆ ~í•œ ë¶€ë¶„ì€ ì •ë§ ì¢‹ì•˜ì–´ìš”. 
      ìœ„ì—ì„œ ë§ì”€ë“œë¦° ë¶€ë¶„ë“¤ë§Œ ë³´ì™„í•˜ì‹ ë‹¤ë©´ ì¶©ë¶„íˆ ê²½ìŸë ¥ ìˆëŠ” ìê¸°ì†Œê°œì„œê°€ ë  ê²ƒ ê°™ìŠµë‹ˆë‹¤. í™”ì´íŒ…!"
      
      ---
      ğŸ’¼ 15ë…„ì°¨ ì¸ì‚¬íŒ€ ì„ ë°°ê°€ ë“œë¦¬ëŠ” ì§„ì‹¬ ì–´ë¦° ì¡°ì–¸
      
      ìê¸°ì†Œê°œì„œ ë‚´ìš©:
      #{content}
    PROMPT
    
    response = make_api_request(prompt, "ëŒ€ê¸°ì—… ì¸ì‚¬íŒ€ 15ë…„ ê²½ë ¥ ì„ ë°°", 4000)
    parse_response(response)[:content]
  end
  
  def generate_customized_letter(company_name, position, company_analysis, cl_analysis, original_content)
    prompt = <<~PROMPT
      ë‹¹ì‹ ì€ ì „ë¬¸ ìê¸°ì†Œê°œì„œ ì‘ì„± ì»¨ì„¤í„´íŠ¸ì…ë‹ˆë‹¤. 

      **ì£¼ì–´ì§„ ì •ë³´:**
      - ëª©í‘œ ê¸°ì—…: #{company_name}
      - ì§€ì› ì§ë¬´: #{position}
      - ê¸°ì—… ë¶„ì„ ê²°ê³¼: 
      #{company_analysis}
      
      - ì§€ì›ì ë¶„ì„ ê²°ê³¼: 
      #{cl_analysis}
      
      - ê¸°ì¡´ ìê¸°ì†Œê°œì„œ: 
      #{original_content}

      **ì‘ì„± ê°€ì´ë“œë¼ì¸:**
      1. ê¸°ì—…ì˜ í˜„ì•ˆê³¼ ì§€ì›ì ê²½í—˜ì„ ìì—°ìŠ¤ëŸ½ê²Œ ì—°ê²°
      2. ê¸°ì—…ì´ ì›í•˜ëŠ” ì¸ì¬ìƒì— ë§ì¶° ê°•ì  ë¶€ê°
      3. êµ¬ì²´ì  ìˆ˜ì¹˜ì™€ ì„±ê³¼ë¡œ ì‹ ë¢°ì„± í™•ë³´
      4. ê¸°ì—… í‚¤ì›Œë“œë¥¼ ìì—°ìŠ¤ëŸ½ê²Œ í¬í•¨
      5. ì°¨ë³„í™”ëœ ì¸ì‚¬ì´íŠ¸ì™€ ê´€ì  ì œì‹œ

      **ì¶œë ¥ í˜•ì‹:**
      ## âœ¨ #{company_name} ë§ì¶¤ ìê¸°ì†Œê°œì„œ

      ### ì§€ì›ë™ê¸° ë° í¬ë¶€
      [ê¸°ì—… í˜„ì•ˆê³¼ ì—°ê²°ëœ ê°œì¸ ê²½í—˜ì„ ë°”íƒ•ìœ¼ë¡œ í•œ ë‹µë³€]
      - ê¸°ì—… ì´ìŠˆ ë°˜ì˜: [ì–´ë–¤ í˜„ì•ˆì„ ì–´ë–»ê²Œ ë°˜ì˜í–ˆëŠ”ì§€]
      - ì°¨ë³„í™” í¬ì¸íŠ¸: [ë‹¤ë¥¸ ì§€ì›ìì™€ êµ¬ë³„ë˜ëŠ” ê´€ì ]

      ### ì§ë¬´ ì—­ëŸ‰ ë° ê²½í—˜
      [ì§ë¬´ì™€ ê´€ë ¨ëœ êµ¬ì²´ì  ê²½í—˜ê³¼ ì„±ê³¼]
      - í•µì‹¬ ì—­ëŸ‰ ê°•ì¡°: [ê¸°ì—…ì´ ì›í•˜ëŠ” ì—­ëŸ‰ê³¼ ë§¤ì¹­]
      - ì„±ê³¼ ìˆ˜ì¹˜í™”: [êµ¬ì²´ì  ìˆ«ìì™€ ì„íŒ©íŠ¸]

      ### ì…ì‚¬ í›„ í¬ë¶€
      [ê¸°ì—…ì˜ ë¯¸ë˜ ë°©í–¥ì„±ê³¼ ì—°ê³„í•œ ë¹„ì „]
      - ê¸°ì—¬ ë°©ì•ˆ: [êµ¬ì²´ì ì¸ ê¸°ì—¬ ê³„íš]
      - ì„±ì¥ ë¹„ì „: [ì¥ê¸°ì  ëª©í‘œ]

      **ğŸ’¡ ì‘ì„± ì¸ì‚¬ì´íŠ¸:**
      - í™œìš©ëœ ê¸°ì—… í˜„ì•ˆ: [ë¦¬ìŠ¤íŠ¸]
      - ê°•ì¡°ëœ ê°œì¸ ì—­ëŸ‰: [ë¦¬ìŠ¤íŠ¸]  
      - ì°¨ë³„í™” ì „ëµ: [ì„¤ëª…]
    PROMPT
    
    response = make_api_request(prompt, "ìê¸°ì†Œê°œì„œ ì‘ì„± ì»¨ì„¤í„´íŠ¸", 6000)
    parse_response(response)[:content]
  end
  
  def format_full_analysis(company_analysis, cl_analysis, customized_letter)
    <<~ANALYSIS
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      ğŸ¯ AI ìê¸°ì†Œê°œì„œ 3ë‹¨ê³„ ì‹¬ì¸µ ë¶„ì„ ì™„ë£Œ
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      #{company_analysis}
      
      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      
      #{cl_analysis}
      
      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      
      #{customized_letter}
      
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      ğŸ’¼ ë¶„ì„ ì™„ë£Œ | Powered by GPT-4o
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    ANALYSIS
  end
  
  def make_api_request(prompt, role_description, max_tokens = 3000)
    uri = URI(OPENAI_API_URL)
    http = Net::HTTP.new(uri.host, uri.port)
    http.use_ssl = true
    http.read_timeout = 60
    
    request = Net::HTTP::Post.new(uri)
    request['Authorization'] = "Bearer #{@api_key}"
    request['Content-Type'] = 'application/json'
    
    request.body = {
      model: @model,
      messages: [
        {
          role: 'system',
          content: "ë‹¹ì‹ ì€ #{role_description}ì…ë‹ˆë‹¤. í•œêµ­ ê¸°ì—…ê³¼ ì±„ìš© ì‹œì¥ì— ëŒ€í•œ ê¹Šì€ ì´í•´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì „ë¬¸ì ì´ê³  ì‹¤ìš©ì ì¸ ì¡°ì–¸ì„ ì œê³µí•©ë‹ˆë‹¤."
        },
        {
          role: 'user',
          content: prompt
        }
      ],
      temperature: 0.7,
      max_tokens: max_tokens
    }.to_json
    
    response = http.request(request)
    JSON.parse(response.body)
  end
  
  def parse_response(response)
    if response['error']
      { error: response['error']['message'] }
    elsif response['choices'] && response['choices'].first
      {
        success: true,
        content: response['choices'].first['message']['content'],
        usage: response['usage']
      }
    else
      { error: 'ì˜ˆìƒì¹˜ ëª»í•œ ì‘ë‹µ í˜•ì‹ì…ë‹ˆë‹¤' }
    end
  end
end