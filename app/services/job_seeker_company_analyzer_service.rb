class JobSeekerCompanyAnalyzerService
  def initialize(company_name)
    @company_name = company_name
    @api_key = ENV['OPENAI_API_KEY']
  end

  def perform_job_seeker_analysis
    # 병렬 처리를 위한 Thread 사용
    results = {}
    threads = []
    
    # 2개의 API를 동시에 호출
    threads << Thread.new do
      results[:comprehensive] = generate_comprehensive_analysis
    end
    
    threads << Thread.new do
      results[:executive_summary] = generate_executive_summary
    end
    
    # 모든 스레드가 완료될 때까지 대기
    threads.each(&:join)
    
    # 결과 조합
    comprehensive_analysis = results[:comprehensive]
    
    {
      executive_summary: results[:executive_summary],
      company_overview: comprehensive_analysis[:company_overview],
      industry_market: comprehensive_analysis[:industry_market],
      hiring_strategy: comprehensive_analysis[:hiring_strategy],
      job_preparation: comprehensive_analysis[:job_preparation],
      competitor_comparison: comprehensive_analysis[:competitor_comparison],
      consultant_advice: comprehensive_analysis[:consultant_advice],
      metadata: {
        analysis_date: Time.current,
        analysis_version: '4.0',
        methodology: 'Job Seeker Focused Deep Analysis with GPT-4.1 (Parallel)',
        minimum_content_length: 3500,
        model_used: ENV['OPENAI_MODEL'] || 'gpt-4.1',
        parallel_processing: true
      }
    }
  end

  private

  def generate_comprehensive_analysis
    prompt = <<~PROMPT
      기업명: #{@company_name}
      현재 날짜: #{Time.current.strftime('%Y년 %m월')}
      
      너는 [기업분석 전문가이자 취업컨설턴트] 역할을 맡는다.  
      너의 임무는 #{@company_name}을 분석하여 취업 준비생이 자기소개서, 면접, 커리어 전략에 바로 활용할 수 있는 **심층 기업분석 리포트(최소 3,500자)**를 작성하는 것이다.  

      ### 작성 원칙
      1. 각 항목은 단순 나열이 아니라 **"왜 중요한가 → 취업 준비생에게 어떤 의미인가 → 어떻게 활용할 수 있는가"**의 흐름으로 서술한다.  
      2. **데이터, 실제 채용공고 키워드, 최근 3년 내 기업 이슈**를 반드시 반영한다.  
      3. 각 섹션 끝에는 **[취업 TIP]** 박스를 넣어 실질적 전략을 정리한다.  
      4. 특히 [3. 채용 전략 & 인재상 분석]과 [6. 핵심 요약 & 컨설턴트 조언]은 **세부적이고 행동 가능한 전략**을 포함해 상세히 작성한다. (각 최소 1,500자 이상)  
      5. [6. 핵심 요약 & 컨설턴트 조언] 파트에서는 단순 요약이 아니라,  
         - "취업 준비생이 반드시 기억해야 할 5가지"  
         - "각 항목이 왜 중요한지 + 실제 준비 방법(자소서·포트폴리오·면접 전략)"  
         - "합격을 위해 구직자가 지금 당장 해야 할 3가지 행동"  
         을 구체적으로 제시한다.  
      6. 전체 글은 컨설팅 보고서 스타일로, 최소 3,500자 이상 분량을 유지한다.  

      ### 분석 프레임워크
      1. **기업 개요 & 산업 포지션**  
         - 기업 연혁, 핵심 비즈니스 모델, 매출 구조(최근 3년 데이터)  
         - 최근 전략 변화 (AI, 글로벌 확장, M&A 등)  
         - 산업 내 위치(경쟁사 대비 강점/약점)  

      2. **산업·시장 분석**  
         - 해당 산업 규모·성장률, 주요 트렌드 (AI, ESG, 글로벌 등)  
         - 주요 경쟁사 비교 (시장점유율, 전략 차이)  
         - 기업이 직면한 기회와 위기  

      3. **채용 전략 & 인재상 분석** (최소 1,500자)
         - 3-1. 채용 방식: 왜 수시채용·프로젝트 단위 채용을 하는지, 이것이 구직자에게 의미하는 바  
         - 3-2. 직무별 채용 키워드: 개발/기획/데이터/디자인별 최근 요구 역량을 실제 공고 기반으로 정리  
         - 3-3. 인재상: 공식 인재상 + 실제 현업에서 요구되는 특성  
         - 각 세부 항목 후 반드시 "구직자 관점 해석 + 구체적 준비 전략" 포함  

      4. **취업 준비 전략 (자소서·면접 연결)**  
         - 자소서 작성 시 강조 포인트 (직무별 맞춤 사례 포함)  
         - 면접 예상 질문과 답변 전략  
         - 경쟁사와의 차별화 전략  

      5. **경쟁사 비교 및 선택 전략**  
         - 동일 산업 내 주요 경쟁사와 비교  
         - 구직자가 커리어 선택 시 고려할 장단점  

      6. **핵심 요약 & 컨설턴트 조언** (최소 1,500자)
         - 취업 준비생이 반드시 기억해야 할 핵심 5가지  
         - 각 항목의 중요성과 실제 준비 방법 (자소서, 면접, 포트폴리오 관점)  
         - 합격을 위해 구직자가 지금 당장 해야 할 3가지 행동  

      ### 출력 형식
      - 마크다운 구조 (제목·소제목·표·리스트 적극 활용)  
      - 각 파트는 최소 5문단 이상, [3번]과 [6번] 파트는 심층 분석으로 분량 확장  
      - 최종 리포트는 최소 3,500자 이상, 전문 컨설팅 보고서처럼 작성
      
      JSON 형식으로 응답:
      {
        "company_overview": "## 1. 기업 개요 & 산업 포지션\\n[상세 내용]",
        "industry_market": "## 2. 산업·시장 분석\\n[상세 내용]",
        "hiring_strategy": "## 3. 채용 전략 & 인재상 분석\\n[상세 내용 - 최소 1,500자]",
        "job_preparation": "## 4. 취업 준비 전략\\n[상세 내용]",
        "competitor_comparison": "## 5. 경쟁사 비교 및 선택 전략\\n[상세 내용]",
        "consultant_advice": "## 6. 핵심 요약 & 컨설턴트 조언\\n[상세 내용 - 최소 1,500자]"
      }
    PROMPT

    response = call_gpt_api(prompt, max_tokens: 4000, json_mode: true)
    
    begin
      JSON.parse(response)
    rescue JSON::ParserError => e
      Rails.logger.error "Failed to parse comprehensive analysis: #{e.message}"
      # Fallback to individual analysis methods
      {
        company_overview: analyze_company_overview,
        industry_market: analyze_industry_market,
        hiring_strategy: analyze_hiring_strategy,
        job_preparation: analyze_job_preparation,
        competitor_comparison: analyze_competitor_comparison,
        consultant_advice: generate_consultant_advice
      }
    end
  end

  def generate_executive_summary
    prompt = <<~PROMPT
      📌 기업분석 요약 (취업 준비생용)
      기업명: #{@company_name}
      현재 날짜: #{Time.current.strftime('%Y년 %m월')}
      
      너는 경력 15년의 취업 컨설턴트다. 
      취업 준비생이 #{@company_name}에 지원하기 전 반드시 알아야 할 핵심 정보를 요약하라.
      
      ## 📊 한 눈에 보는 #{@company_name}
      
      ### 🎯 지원자가 꼭 알아야 할 3가지
      1. [#{@company_name}의 현재 상황과 왜 지금 지원해야 하는지]
      2. [어떤 인재를 찾고 있으며, 준비해야 할 핵심 역량]
      3. [경쟁사 대비 차별점과 커리어 성장 가능성]
      
      ### 💡 채용 트렌드 (2025년 기준)
      • 채용 규모: [신입/경력 비율, 연간 채용 인원]
      • 주력 채용 직무: [가장 많이 뽑는 3개 직무]
      • 채용 방식: [공채/수시/인턴 전환 등]
      • 평균 연봉: [신입 기준, 업계 평균 대비]
      
      ### ⚡ 지원 전 체크리스트
      □ 최근 3개월 내 주요 뉴스 확인했는가?
      □ 주력 서비스/제품을 직접 사용해봤는가?
      □ 경쟁사와 차별점을 설명할 수 있는가?
      □ 자소서에 넣을 기업 키워드 3개를 준비했는가?
      □ 면접 예상 질문 10개를 뽑아봤는가?
      
      ### 🚨 주의사항
      • [이 기업의 최근 이슈나 리스크]
      • [지원 시 피해야 할 실수]
      
      구직자 입장에서 실용적이고 구체적으로 작성하라.
    PROMPT

    call_gpt_api(prompt, max_tokens: 1500)
  end

  def analyze_company_overview
    prompt = <<~PROMPT
      기업명: #{@company_name}
      현재 날짜: 2025년 8월
      
      다음 구조로 작성하되, 카카오 분석 예시처럼 자연스러운 문단 형식으로 작성하라:
      
      ## 1. 기업 개요 & 산업 포지션
      
      #{@company_name}는 [설립년도, 창업 배경, 초기 서비스]로 출발한 이후, 현재는 [현재 주요 사업 영역] 기업으로 성장했습니다. [핵심 성과 지표 - MAU, 시장점유율 등 구체적 수치 포함].
      
      **사업 구조**
      • [주력 사업부문 1] (설명): 매출 비중 약 XX%
      • [주력 사업부문 2] (설명): 매출 비중 약 XX%
      • [신규/성장 사업부문] (설명): 매출 비중 약 XX%
      
      **최근 3년 매출 추이**
      • 2023년: XX조(억) 원
      • 2024년: XX조(억) 원
      • 2025년(상반기/예상): XX조(억) 원
      
      #{@company_name}는 [핵심 전략 변화]를 선언했습니다. 대표적으로 **[구체적 프로젝트/기술 - 볼드체로 강조]**를 개발해 [적용 분야]에 적용 중이며, [투자 영역]에도 [투자 규모]을 투자하고 있습니다.
      
      [추가 문단: 최근 주요 이슈, M&A, 글로벌 진출 등]
      
      **[취업 TIP]**
      → 지원자는 #{@company_name}를 '[과거 이미지]'로만 보지 말고, [현재 핵심 정체성 3가지]라는 정체성으로 바라봐야 합니다. 자기소개서에서 "내 경험이 #{@company_name}의 [핵심 전략 3가지]에 어떻게 기여할 수 있는가"를 연결하는 것이 핵심입니다.
      
      자연스러운 문장으로 연결하여 읽기 쉽게 작성하라.
    PROMPT

    call_gpt_api(prompt, max_tokens: 2000)
  end

  def analyze_industry_market
    prompt = <<~PROMPT
      기업명: #{@company_name}
      현재 날짜: 2025년 8월
      
      다음 구조로 작성하되, 카카오 분석 예시처럼 자연스러운 문단 형식으로 작성하라:
      
      ## 2. 산업·시장 분석
      
      #{@company_name}가 속한 [산업 분류] 시장은 2025년 기준 [시장 규모]원 규모로, 연평균 [X]% 성장하고 있습니다. 전 세계적으로는 [글로벌 시장 규모]에 달하며, 한국은 [순위 및 점유율] 위치를 차지하고 있습니다.
      
      **2025년 핵심 트렌드**
      
      첫째, **AI와 자동화**가 업계 전반을 재편하고 있습니다. [구체적 변화 사례와 영향]. #{@company_name}도 [AI 관련 투자나 프로젝트]를 통해 대응하고 있습니다.
      
      둘째, **ESG 경영과 지속가능성**이 필수 요소가 되었습니다. [규제 변화, 소비자 인식 변화]. 특히 [구체적 사례]가 주목받고 있습니다.
      
      셋째, **글로벌 시장 진출**이 가속화되고 있습니다. #{@company_name}는 [해외 진출 현황, 수출 비중]을 달성했으며, [향후 계획]을 추진 중입니다.
      
      **경쟁 환경 분석**
      
      | 기업 | 시장점유율 | 핵심 강점 | 연간 채용 | 평균연봉(신입) |
      |------|-----------|-----------|-----------|--------------|
      | #{@company_name} | XX% | [강점 2-3개] | XXX명 | X,XXX만원 |
      | [경쟁사 A] | XX% | [강점 2-3개] | XXX명 | X,XXX만원 |
      | [경쟁사 B] | XX% | [강점 2-3개] | XXX명 | X,XXX만원 |
      
      #{@company_name}는 [핵심 차별화 요소]로 경쟁우위를 확보하고 있습니다. 특히 [구체적 강점]은 업계에서 독보적입니다. 다만 [경쟁사 A]의 [특정 영역] 강세와 [경쟁사 B]의 [특정 전략]은 주목할 만한 위협 요인입니다.
      
      **기회와 위기 요인**
      
      #{@company_name}에게 가장 큰 **기회**는 [구체적 기회 요인 - 신시장, 신기술, 정책 등]입니다. [왜 기회인지 설명]. 이는 구직자에게 [특정 직무/부서]의 채용 확대와 성장 기회를 의미합니다.
      
      반면 **위기 요인**으로는 [구체적 위험 - 규제, 경쟁, 시장 변화 등]이 있습니다. [위기의 영향]. 하지만 이는 오히려 [혁신 분야]에서의 도전적인 프로젝트 참여 기회가 될 수 있습니다.
      
      **[취업 TIP] 산업 이해도 어필 전략**
      → 면접에서 "우리 산업의 최대 이슈는?" 질문이 나올 확률 90%
      
      모범 답안 예시:
      "#{@company_name}가 속한 [산업]의 최대 과제는 [핵심 이슈]라고 생각합니다. 이는 [위기 요소]이기도 하지만, 동시에 [기회 전환 방법]의 기회이기도 합니다. 특히 #{@company_name}의 [강점]을 활용한다면 [구체적 제안]이 가능할 것 같습니다."
      
      준비 포인트:
      1. 최신 산업 리포트 2-3개 필독
      2. 경쟁사 비교 시 #{@company_name} 강점 3가지 암기
      3. 산업 트렌드별 개인 의견 정리
      
      자연스러운 문장으로 연결하여 읽기 쉽게 작성하라.
    PROMPT

    call_gpt_api(prompt, max_tokens: 2000)
  end

  def analyze_hiring_strategy
    prompt = <<~PROMPT
      기업명: #{@company_name}
      현재 날짜: 2025년 8월
      
      다음 구조로 작성하되, 카카오 분석 예시처럼 자연스러운 문단 형식으로 작성하라:
      
      ## 3. 채용 전략 & 인재상 분석
      
      ### 3-1. 채용 방식 분석
      
      #{@company_name}는 [채용 방식 - 공채/수시/인턴 전환]을 주력으로 하고 있습니다. 2024년에는 [총 채용 인원]명을 채용했으며, 2025년에는 [예상 인원]명 규모로 확대할 계획입니다. 신입과 경력 비율은 약 [X:Y]로, [신입/경력 선호 이유]를 반영한 것입니다.
      
      이러한 채용 방식은 #{@company_name}의 [비즈니스 전략 - 예: 신사업 확장, 디지털 전환]과 밀접하게 연관되어 있습니다. 특히 [특정 사업 부문]의 성장에 따라 [관련 직무]의 채용이 크게 늘어나고 있습니다.
      
      **👉 구직자 대응 전략**
      
      수시 채용 체제에서는 '상시 준비'가 핵심입니다. 월 1회 이력서를 업데이트하고, 원티드와 회사 채용 페이지에 알림을 설정하세요. #{@company_name}는 보통 [채용 공고 후 마감까지 기간]의 짧은 기간만 모집하므로 빠른 대응이 중요합니다.
      
      인턴 전환형의 경우, 정규직 전환율이 약 [X]%에 달합니다. 인턴 기간 중 [평가 기준 - 예: 프로젝트 성과, 팀워크]를 중점적으로 평가하므로, 이를 염두에 두고 준비해야 합니다.
      
      ### 3-2. 직무별 핵심 키워드
      
      **개발/엔지니어링 직군**
      #{@company_name}의 개발 직군은 '[필수 기술 스택]'을 기본으로 요구합니다. 최근 공고를 분석하면 "대용량 트래픽 처리 경험", "MSA 설계", "클라우드 네이티브" 같은 키워드가 자주 등장합니다.
      
      자소서 작성 시 단순히 "Python 능숙"이라고 쓰지 말고, "Python으로 일 처리량 40% 개선한 경험"처럼 구체적 성과와 연결하세요. #{@company_name}는 특히 [특정 기술이나 경험]을 가진 지원자를 선호합니다.
      
      **기획/마케팅 직군**
      데이터 기반 의사결정이 핵심입니다. "SQL로 유저 행동 분석", "A/B 테스트 설계", "그로스 해킹" 경험이 있다면 반드시 강조하세요. 단순한 "마케팅 캠페인 성공"보다는 "CTR 2.5% 달성, 업계 평균 대비 150%"처럼 정량화된 성과를 제시하는 것이 중요합니다.
      
      **디자인 직군**
      포트폴리오의 퀄리티가 합격을 좌우합니다. #{@company_name}는 [디자인 철학 - 예: 사용자 중심, 미니멀리즘]을 중시하며, 프로토타이핑과 사용성 테스트 경험을 우대합니다.
      
      ### 3-3. 인재상 심층 분석
      
      #{@company_name}의 공식 인재상은 "[인재상 1]", "[인재상 2]", "[인재상 3]"입니다. 
      
      하지만 실제 합격자들을 분석해보면, **"[실제 중요한 특징 1]"**이 가장 중요합니다. 예를 들어, [구체적 사례]. 또한 **"[실제 중요한 특징 2]"**도 자주 언급되는데, 이는 #{@company_name}의 [조직 문화나 업무 방식]과 관련이 있습니다.
      
      특히 주목할 점은 #{@company_name}가 "[특별히 선호하는 인재 유형]"을 선호한다는 것입니다. 최근 채용된 인재들의 공통점을 보면 [공통 특징 3-4개]를 가지고 있습니다.
      
      ### 3-4. 채용 프로세스 공략법
      
      **서류 전형 (경쟁률 약 XX:1)**
      #{@company_name}의 서류 심사는 [ATS/인사팀 직접 검토] 방식으로 진행됩니다. 필수 키워드인 "[키워드 1]", "[키워드 2]", "[키워드 3]"가 포함되지 않으면 탈락 확률이 높습니다. 
      
      **코딩테스트/직무테스트**
      개발 직군의 경우 [난이도 수준 - 예: 백준 실버~골드]의 알고리즘 문제가 출제됩니다. [프로그래머스/해커랭크] 플랫폼을 사용하며, 주로 [문제 유형]이 나옵니다. 기획/마케팅 직군은 [케이스 스터디/데이터 분석] 과제가 주어집니다.
      
      **면접 전형**
      1차 실무진 면접에서는 [직무 역량 검증 방식]을 통해 평가합니다. "우리 서비스의 문제점과 개선 방안"은 거의 100% 나오는 질문이니 반드시 준비하세요. 2차 임원 면접에서는 [가치관, 장기 비전]을 중점적으로 봅니다.
      
      **[취업 TIP] 차별화 전략**
      → #{@company_name}는 스펙보다 '실무 능력과 문화 적합성'을 중시합니다.
      1. 직무 관련 프로젝트 결과물 > 자격증
      2. 실무 인턴 경험 > 높은 학점
      3. 팀 프로젝트에서의 기여도 > 개인 성과
      4. #{@company_name} 서비스 개선 제안서 준비 (면접 시 제출)
      
      자연스러운 문장으로 연결하여 읽기 쉽게 작성하라.
    PROMPT

    call_gpt_api(prompt, max_tokens: 3000)
  end

  def analyze_job_preparation
    prompt = <<~PROMPT
      기업명: #{@company_name}
      현재 날짜: 2025년 8월
      
      다음 구조로 작성하되, 카카오 분석 예시처럼 자연스러운 문단 형식으로 작성하라:
      
      ## 4. 취업 준비 전략 (자소서·면접 가이드)
      
      ### 자기소개서 작성 전략
      
      #{@company_name}의 자소서는 보통 3-4개 문항으로 구성됩니다. 가장 중요한 "지원동기"는 반드시 #{@company_name}만의 차별점을 언급하며 시작해야 합니다. 예를 들어, "#{@company_name}의 [최근 뉴스나 전략]을 보고 [구체적 감상]을 느꼈습니다"처럼 시작하는 것이 좋습니다.
      
      중간 부분에서는 본인의 경험과 회사 비전을 연결하되, 추상적인 표현은 피하세요. "저는 [구체적 프로젝트]를 통해 [정량적 성과]를 달성했고, 이 경험이 #{@company_name}의 [구체적 업무]에 기여할 수 있다고 확신합니다"처럼 구체적으로 작성하세요.
      
      **#{@company_name} 맞춤 키워드 전략**
      
      최근 공고를 분석한 결과, "[키워드 1]", "[키워드 2]", "[키워드 3]"가 핵심 키워드입니다. 이 중 최소 2개는 반드시 자소서에 포함시키세요. 반면 "열정", "도전정신", "글로벌 인재" 같은 진부한 표현은 피하는 것이 좋습니다.
      
      직무 역량을 서술할 때는 STAR 기법을 활용하되, #{@company_name}가 중시하는 [핵심 역량]과 연결하세요. 예를 들어, [구체적 예시 상황]처럼 작성하면 효과적입니다.
      
      ### 면접 준비 전략
      
      **1차 실무 면접 공략법**
      
      #{@company_name}의 실무 면접은 약 [시간] 동안 진행되며, 주로 [면접 방식 - 예: 2:1, 다대다]으로 진행됩니다. 거의 100% 나오는 질문은 "우리 서비스/제품을 개선한다면?"입니다. 이 질문에는 반드시 [서비스명]을 직접 사용해본 경험과 함께, 사용자 관점의 구체적 개선안을 제시해야 합니다.
      
      "경쟁사 대비 우리 회사 강점은?" 질문도 빈출 문제입니다. 단순 비교가 아닌, #{@company_name}의 [핵심 차별화 요소]를 중심으로 답변하세요. 예를 들어, "[경쟁사 A]는 [특징]이 강점이지만, #{@company_name}는 [차별화 포인트]에서 독보적입니다"라는 구조로 답변하면 좋습니다.
      
      기술 질문의 경우, [주요 기술 스택]에 대한 심화 질문이 나올 수 있으니 준비하세요. 특히 [최신 기술 트렌드]에 대한 의견을 묻는 경우가 많으므로, 관련 아티클을 3-4개 정도 읽고 가는 것을 추천합니다.
      
      **2차 임원 면접 대비**
      
      임원 면접은 주로 [평가 포인트 - 예: 조직 적합성, 장기 비전]을 중점적으로 평가합니다. CEO [이름]의 인터뷰나 저서를 반드시 읽고 가세요. 특히 #{@company_name}의 비전인 "[회사 비전]"에 대한 본인의 해석과 기여 방안을 준비해야 합니다.
      
      "5년 후 커리어 목표"를 물을 때는 #{@company_name} 내에서의 성장을 전제로 답변하세요. 예를 들어, "#{@company_name}의 [사업 부문]에서 [구체적 역할]로 성장하여 [기여 내용]을 하고 싶습니다"처럼 회사와 함께 성장하는 비전을 제시하는 것이 중요합니다.
      
      ### 포트폴리오 준비 가이드
      
      **개발 직군**은 GitHub 레포지토리 정리가 필수입니다. README를 충실히 작성하고, 코드 퀄리티를 높이는 데 집중하세요. #{@company_name}는 특히 [선호하는 개발 방식 - 예: 클린 코드, 테스트 주도 개발]을 중시하므로 이를 보여줄 수 있는 프로젝트를 선별하세요.
      
      **기획/마케팅 직군**은 데이터 기반 의사결정 능력을 보여줘야 합니다. A/B 테스트 결과, 사용자 분석 리포트, 성과 지표 개선 사례를 각각 1개씩은 준비하세요.
      
      **디자인 직군**은 베한체나 노션으로 포트폴리오를 구성하되, 프로세스 설명을 반드시 포함하세요. #{@company_name}의 디자인 철학인 [디자인 철학]을 반영한 작업물을 우선 배치하는 것이 좋습니다.
      
      **[취업 TIP] 합격률 높이는 디테일**
      → 지원 1주일 전부터 #{@company_name} 관련 뉴스를 매일 체크하세요. 면접 당일 아침에도 확인하여 최신 이슈를 파악하는 것이 중요합니다. 또한 실무진의 LinkedIn을 확인하여 최근 관심사를 파악하면 면접에서 좋은 인상을 남길 수 있습니다.
      
      자연스러운 문장으로 연결하여 읽기 쉽게 작성하라.
    PROMPT

    call_gpt_api(prompt, max_tokens: 2500)
  end

  def analyze_competitor_comparison
    prompt = <<~PROMPT
      기업명: #{@company_name}
      현재 날짜: 2025년 8월
      
      다음 구조로 작성하되, 카카오 분석 예시처럼 자연스러운 문단 형식으로 작성하라:
      
      ## 5. 경쟁사 비교 및 선택 전략
      
      ### 동종업계 주요 기업 비교
      
      | 구분 | #{@company_name} | 경쟁사A | 경쟁사B | 경쟁사C |
      |------|------------------|---------|---------|---------|
      | 매출규모 | | | | |
      | 영업이익률 | | | | |
      | 시장점유율 | | | | |
      | 평균연봉(신입) | | | | |
      | 평균연봉(5년차) | | | | |
      | 채용규모 | | | | |
      | 이직률 | | | | |
      | 복지점수 | | | | |
      | 조직문화 | | | | |
      | 성장가능성 | | | | |
      
      ### 기업별 장단점 (구직자 관점)
      
      **#{@company_name}**
      ✅ 장점:
      • [구체적 장점 3가지]
      • 커리어 성장: [승진 속도, 교육 기회]
      • 조직 문화: [수평적/수직적, 워라밸]
      
      ⚠️ 단점:
      • [솔직한 단점 2가지]
      • 개선 중인 부분: [회사의 노력]
      
      **경쟁사와 차별점**
      • vs A사: [핵심 차이]
      • vs B사: [핵심 차이]
      • vs C사: [핵심 차이]
      
      ### 커리어 패스 비교
      
      **#{@company_name}에서의 5년**
      • 1-2년차: [담당 업무, 성장 곡선]
      • 3-4년차: [책임 범위, 연봉 수준]
      • 5년차+: [커리어 옵션, 시장 가치]
      
      **이직 시 유리한 점**
      • #{@company_name} 출신 선호 기업
      • 인정받는 경력 분야
      • 평균 연봉 상승률
      
      ### 의사결정 프레임워크
      
      **#{@company_name}가 맞는 사람**
      ✅ [성향/가치관/목표]
      ✅ [선호하는 조직 문화]
      ✅ [커리어 목표]
      
      **다른 회사를 고려해야 할 사람**
      ❌ [맞지 않는 성향]
      ❌ [다른 커리어 목표]
      
      ### [취업 TIP] 면접 대비
      → "왜 경쟁사가 아닌 우리 회사인가?"
      
      모범 답안 구조:
      "#{@company_name}만의 [차별점]이 제 [가치관/목표]와 일치합니다.
      특히 [구체적 사례]를 보고 확신을 가지게 되었습니다.
      경쟁사도 훌륭하지만, [결정적 차이]가 저에게는 중요합니다."
      
      준비할 차별화 포인트 3가지를 구체적으로 작성하라.
      
      자연스러운 문장으로 연결하여 읽기 쉽게 작성하라.
    PROMPT

    call_gpt_api(prompt, max_tokens: 2000)
  end

  def generate_consultant_advice
    prompt = <<~PROMPT
      기업명: #{@company_name}
      현재 날짜: 2025년 8월
      
      다음 구조로 작성하되, 카카오 분석 예시처럼 자연스러운 문단 형식으로 작성하라.
      구직자가 #{@company_name} 취업에 성공하기 위한 핵심 전략을
      최소 1500자 이상으로 매우 구체적이고 실용적으로 작성하라:
      
      ## 6. 핵심 요약 & 컨설턴트 조언
      
      ### 🎯 취업 준비생이 반드시 기억해야 할 5가지
      
      **1. [가장 중요한 핵심 역량]**
      • 왜 중요한가: [비즈니스 연관성]
      • 어떻게 증명하나: [구체적 방법]
      • 자소서 활용법: [예시 문장]
      • 면접 활용법: [답변 구조]
      • 준비 방법: [당장 시작할 수 있는 것]
      
      **2. [기업 특화 준비 사항]**
      • 왜 중요한가: [차별화 포인트]
      • 어떻게 증명하나: [포트폴리오/경험]
      • 자소서 활용법: [키워드와 연결]
      • 면접 활용법: [사례 준비]
      • 준비 방법: [3개월 계획]
      
      **3. [산업 이해도]**
      • 왜 중요한가: [장기 성장 관점]
      • 어떻게 증명하나: [시장 분석 능력]
      • 자소서 활용법: [트렌드 언급]
      • 면접 활용법: [의견 제시]
      • 준비 방법: [정보 수집 채널]
      
      **4. [조직 문화 적합성]**
      • 왜 중요한가: [장기 근속 가능성]
      • 어떻게 증명하나: [가치관 일치]
      • 자소서 활용법: [경험과 연결]
      • 면접 활용법: [에피소드 준비]
      • 준비 방법: [문화 파악 방법]
      
      **5. [성장 가능성]**
      • 왜 중요한가: [투자 가치]
      • 어떻게 증명하나: [학습 능력]
      • 자소서 활용법: [성장 스토리]
      • 면접 활용법: [미래 비전]
      • 준비 방법: [역량 개발 계획]
      
      ### 📋 단계별 준비 전략 (3개월 계획)
      
      **[D-90] 1개월차: 기초 조사**
      □ 회사 홈페이지 전체 탐독
      □ 최근 1년 뉴스 스크랩 (최소 30건)
      □ 주요 서비스/제품 직접 사용
      □ 재무제표 분석 (매출/이익 추이)
      □ 경쟁사 3곳 비교 분석
      □ 현직자 인터뷰 or 후기 수집
      
      **[D-60] 2개월차: 역량 준비**
      □ 직무 키워드 추출 (최소 20개)
      □ STAR 에피소드 10개 정리
      □ 포트폴리오 제작/업데이트
      □ 자격증/시험 준비 (필요시)
      □ 모의 자소서 3회 작성
      □ 스터디 참여 or 멘토링
      
      **[D-30] 3개월차: 실전 대비**
      □ 최종 자소서 완성 (5회 이상 수정)
      □ 면접 예상 질문 50개 준비
      □ 모의 면접 3회 이상
      □ 1분 자기소개 10회 연습
      □ 면접 복장/매너 점검
      □ 최신 이슈 업데이트
      
      ### ✅ 지금 당장 해야 할 3가지 행동
      
      **1. 오늘 시작: 회사 리서치 노트 만들기**
      • 노션/원노트에 #{@company_name} 페이지 생성
      • 섹션: 뉴스/제품분석/경쟁사/채용공고/면접후기
      • 매일 10분씩 정보 업데이트
      • 1주일 후 패턴 분석 → 인사이트 도출
      
      **2. 이번 주 완료: 직무 역량 매칭표 작성**
      • 최근 채용공고 5개 수집
      • 요구 역량 추출 → 엑셀 정리
      • 내 경험과 매칭 (있음/없음/보완가능)
      • 없는 역량 → 획득 계획 수립
      
      **3. 이번 달 완료: 네트워킹 시작**
      • LinkedIn에서 현직자 10명 찾기
      • 정중한 메시지로 조언 요청
      • 커피챗 or 화상 미팅 제안
      • 질문 리스트 준비 (10개)
      
      ### 💡 차별화 전략 (남들이 안 하는 것)
      
      1. **"제품 개선 제안서" 준비**
      • #{@company_name} 서비스 하나 선택
      • 사용자 관점 문제점 3가지
      • 개선 아이디어 + 기대효과
      • 면접 시 제출 (강력한 차별화)
      
      2. **"90일 온보딩 계획" 작성**
      • 입사 후 30/60/90일 계획
      • 학습 목표 + 기여 방안
      • 면접 마지막 질문에 활용
      
      3. **"산업 리포트" 작성**
      • A4 2장 분량 간단 리포트
      • 최신 트렌드 + 시사점
      • 전문성 어필 자료
      
      ### 🚨 주의사항 & 실수 방지
      
      **절대 하지 말아야 할 것**
      ❌ 회사 비전/미션을 모른 채 지원
      ❌ 경쟁사와 혼동하는 실수
      ❌ 부정적 뉴스에 대한 준비 없음
      ❌ 연봉/복지만 강조하는 지원동기
      ❌ 과장된 경험 (검증 시 탈락)
      
      **자주 하는 실수**
      • 기업 분석 = 홈페이지 복사
      • 직무 이해 부족한 지원
      • 팀 경험 없이 개인 성과만 강조
      • 단기 이직 의사 노출
      • 면접 후 후속 조치 없음
      
      ### 📌 최종 메시지
      
      #{@company_name} 취업은 단순한 '합격'이 아니라
      '커리어 전환점'이 되어야 합니다.
      
      이 회사가 당신에게 줄 수 있는 것:
      • [커리어 성장 기회]
      • [전문성 개발 환경]
      • [네트워크와 브랜드]
      
      당신이 이 회사에 줄 수 있는 것:
      • [당신만의 강점]
      • [열정과 성장 의지]
      • [장기적 기여 가능성]
      
      준비된 자만이 기회를 잡습니다.
      지금 시작하세요. 3개월 후면 충분히 준비될 수 있습니다.
      
      행운을 빕니다! 화이팅! 💪
      
      ---
      
      이 조언은 실제 합격자 사례와 채용 담당자 인터뷰를 바탕으로
      작성된 실전 가이드입니다. 구체적이고 실행 가능한 전략으로
      반드시 1500자 이상 작성하라.
      
      자연스러운 문장으로 연결하여 읽기 쉽게 작성하라.
    PROMPT

    call_gpt_api(prompt, max_tokens: 3000)
  end

  def call_gpt_api(prompt, max_tokens: 2500, json_mode: false)
    require 'net/http'
    require 'json'
    
    uri = URI('https://api.openai.com/v1/chat/completions')
    http = Net::HTTP.new(uri.host, uri.port)
    http.use_ssl = true
    http.read_timeout = 60
    
    request = Net::HTTP::Post.new(uri)
    request['Authorization'] = "Bearer #{@api_key}"
    request['Content-Type'] = 'application/json'
    
    body_params = {
      model: ENV['OPENAI_MODEL'] || 'gpt-4.1',
      messages: [
        { 
          role: 'system', 
          content: '당신은 15년 경력의 시니어 취업 컨설턴트입니다. 현재 날짜는 2025년 8월입니다. 
          구직자가 실제로 활용할 수 있는 구체적이고 실용적인 조언을 제공합니다. 
          각 분석은 "왜 중요한가 → 어떻게 준비하나 → 실제 활용법"의 구조로 작성합니다.
          모든 내용은 최소 3,500자 이상의 심층 분석으로 작성하며, 
          특히 채용 전략과 컨설턴트 조언 파트는 각각 1,500자 이상으로 상세히 작성합니다.' 
        },
        { role: 'user', content: prompt }
      ],
      temperature: 0.7,
      max_tokens: max_tokens
    }
    
    # JSON 모드 설정
    if json_mode
      body_params[:response_format] = { type: "json_object" }
    end
    
    request.body = body_params.to_json
    
    response = http.request(request)
    result = JSON.parse(response.body)
    
    if result['choices']
      result['choices'][0]['message']['content']
    else
      "분석 중 오류가 발생했습니다: #{result['error']&.dig('message')}"
    end
  rescue => e
    Rails.logger.error "GPT API Error: #{e.message}"
    "분석 중 오류가 발생했습니다: #{e.message}"
  end
end