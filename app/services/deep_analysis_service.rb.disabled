require 'net/http'
require 'json'

class DeepAnalysisService
  OPENAI_API_URL = 'https://api.openai.com/v1/chat/completions'
  
  def initialize
    @api_key = ENV['OPENAI_API_KEY']
    @model = 'gpt-5' # GPT-5 ëª¨ë¸ ì‚¬ìš©
  end
  
  def perform_deep_analysis(content, company_name, position, user_profile = nil)
    return { error: "API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤" } unless @api_key
    
    # 9ê°€ì§€ ì „ë¬¸ ë¶„ì„ ëª¨ë“ˆ ì‹¤í–‰
    analyses = {
      quantitative_score: quantitative_evaluation(content, company_name, position),
      competency_matrix: analyze_competency_matrix(content, position),
      star_analysis: analyze_star_framework(content),
      experience_assets: analyze_experience_assets(content, company_name),
      sentence_impact: analyze_sentence_impact(content),
      keyword_intelligence: analyze_keywords(content, company_name, position),
      risk_diagnosis: diagnose_risks(content),
      differentiation: analyze_differentiation(content, position),
      pass_prediction: predict_pass_rate(content, company_name, position)
    }
    
    # ì¢…í•© ë¶„ì„ ë³´ê³ ì„œ ìƒì„±
    comprehensive_report = generate_comprehensive_report(analyses, content, company_name, position)
    
    {
      success: true,
      analyses: analyses,
      comprehensive_report: comprehensive_report,
      visualization_data: prepare_visualization_data(analyses)
    }
  rescue StandardError => e
    Rails.logger.error "ì‹¬ì¸µ ë¶„ì„ ì˜¤ë¥˜: #{e.message}"
    { error: "ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: #{e.message}" }
  end
  
  private
  
  # 1. 100ì  ì •ëŸ‰ í‰ê°€ ì‹œìŠ¤í…œ
  def quantitative_evaluation(content, company_name, position)
    prompt = <<~PROMPT
      ë‹¹ì‹ ì€ 20ë…„ ê²½ë ¥ì˜ ì±„ìš© ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ìê¸°ì†Œê°œì„œë¥¼ 100ì  ë§Œì ìœ¼ë¡œ ì •ëŸ‰ í‰ê°€í•´ì£¼ì„¸ìš”.
      
      **í‰ê°€ ê¸°ì¤€ (ê° 20ì )**
      1. ì§ë¬´ ì í•©ì„± (0-20ì )
      2. êµ¬ì²´ì„±ê³¼ ì‹ ë¢°ì„± (0-20ì )
      3. ë…¼ë¦¬ì„±ê³¼ êµ¬ì¡° (0-20ì )
      4. ì°¨ë³„í™”ì™€ ë…ì°½ì„± (0-20ì )
      5. í‘œí˜„ë ¥ê³¼ ë¬¸ì¥ë ¥ (0-20ì )
      
      **ì¶œë ¥ í˜•ì‹ (JSON):**
      {
        "total_score": 85,
        "categories": {
          "job_fit": {
            "score": 17,
            "feedback": "ì§ë¬´ ê´€ë ¨ ê²½í—˜ì´ í’ë¶€í•˜ë‚˜ ìµœì‹  ê¸°ìˆ  íŠ¸ë Œë“œ ì–¸ê¸‰ ë¶€ì¡±"
          },
          "specificity": {
            "score": 18,
            "feedback": "êµ¬ì²´ì  ìˆ˜ì¹˜ì™€ ì„±ê³¼ ì œì‹œ ìš°ìˆ˜"
          },
          "logic": {
            "score": 16,
            "feedback": "ì „ë°˜ì  ë…¼ë¦¬ íë¦„ì€ ì¢‹ìœ¼ë‚˜ ì¼ë¶€ ë‹¨ë½ ì—°ê²° ê°œì„  í•„ìš”"
          },
          "differentiation": {
            "score": 15,
            "feedback": "ë…ì°½ì  ê´€ì  ë¶€ì¡±, ì¼ë°˜ì ì¸ í‘œí˜„ ë§ìŒ"
          },
          "expression": {
            "score": 19,
            "feedback": "ë¬¸ì¥ë ¥ ìš°ìˆ˜, ì „ë¬¸ ìš©ì–´ ì ì ˆíˆ ì‚¬ìš©"
          }
        },
        "grade": "B+",
        "percentile": "ìƒìœ„ 15%",
        "improvement_priority": ["ì°¨ë³„í™” ì „ëµ", "ìµœì‹  íŠ¸ë Œë“œ ë°˜ì˜", "ìŠ¤í† ë¦¬í…”ë§ ê°•í™”"]
      }
      
      ì§€ì› ê¸°ì—…: #{company_name}
      ì§€ì› ì§ë¬´: #{position}
      ìê¸°ì†Œê°œì„œ: #{content}
    PROMPT
    
    response = make_api_request(prompt, "ì±„ìš© í‰ê°€ ì „ë¬¸ê°€", 2000)
    parse_json_response(response)
  end
  
  # 2. í•µì‹¬ ì—­ëŸ‰ ë§¤íŠ¸ë¦­ìŠ¤ (5-star rating)
  def analyze_competency_matrix(content, position)
    prompt = <<~PROMPT
      ìê¸°ì†Œê°œì„œì—ì„œ ë“œëŸ¬ë‚˜ëŠ” í•µì‹¬ ì—­ëŸ‰ì„ 5ì  ì²™ë„ë¡œ í‰ê°€í•´ì£¼ì„¸ìš”.
      
      **í‰ê°€í•  ì—­ëŸ‰ ì¹´í…Œê³ ë¦¬:**
      - ê¸°ìˆ  ì—­ëŸ‰ (Technical Skills)
      - ì†Œí”„íŠ¸ ìŠ¤í‚¬ (Soft Skills)
      - ë¦¬ë”ì‹­ (Leadership)
      - ë¬¸ì œí•´ê²° (Problem Solving)
      - í˜‘ì—…ëŠ¥ë ¥ (Collaboration)
      - ì°½ì˜ì„± (Creativity)
      - ì„±ì¥ê°€ëŠ¥ì„± (Growth Potential)
      
      **ì¶œë ¥ í˜•ì‹ (JSON):**
      {
        "competencies": {
          "technical_skills": {
            "rating": 4.5,
            "evidence": ["Python í”„ë¡œì íŠ¸ 3ë…„", "AWS ì¸ì¦ ë³´ìœ "],
            "missing": ["ìµœì‹  AI/ML ê²½í—˜"]
          },
          "soft_skills": {
            "rating": 4.0,
            "evidence": ["íŒ€ í”„ë¡œì íŠ¸ ë¦¬ë”©", "ê³ ê° ì»¤ë®¤ë‹ˆì¼€ì´ì…˜"],
            "missing": ["ê°ˆë“± ê´€ë¦¬ ì‚¬ë¡€"]
          },
          "leadership": {
            "rating": 3.5,
            "evidence": ["ë™ì•„ë¦¬ íšŒì¥ ê²½í—˜"],
            "missing": ["ëŒ€ê·œëª¨ íŒ€ ë¦¬ë”©"]
          },
          "problem_solving": {
            "rating": 4.8,
            "evidence": ["ë³µì¡í•œ ë²„ê·¸ í•´ê²°", "í”„ë¡œì„¸ìŠ¤ ê°œì„ "],
            "missing": []
          },
          "collaboration": {
            "rating": 4.2,
            "evidence": ["í¬ë¡œìŠ¤íŒ€ í˜‘ì—…", "ë©˜í† ë§ ê²½í—˜"],
            "missing": ["ê¸€ë¡œë²Œ í˜‘ì—…"]
          },
          "creativity": {
            "rating": 3.8,
            "evidence": ["ìƒˆë¡œìš´ ì†”ë£¨ì…˜ ì œì•ˆ"],
            "missing": ["í˜ì‹ ì  í”„ë¡œì íŠ¸"]
          },
          "growth_potential": {
            "rating": 4.6,
            "evidence": ["ì§€ì†ì  í•™ìŠµ", "ìê²©ì¦ ì·¨ë“"],
            "missing": []
          }
        },
        "overall_rating": 4.2,
        "strongest_competency": "problem_solving",
        "weakest_competency": "leadership",
        "recommendations": ["ë¦¬ë”ì‹­ ê²½í—˜ ë³´ê°•", "ì°½ì˜ì  í”„ë¡œì íŠ¸ ìˆ˜í–‰"]
      }
      
      ì§€ì› ì§ë¬´: #{position}
      ìê¸°ì†Œê°œì„œ: #{content}
    PROMPT
    
    response = make_api_request(prompt, "ì—­ëŸ‰ í‰ê°€ ì „ë¬¸ê°€", 2000)
    parse_json_response(response)
  end
  
  # 3. STAR ë¶„ì„ (Situation-Task-Action-Result)
  def analyze_star_framework(content)
    prompt = <<~PROMPT
      ìê¸°ì†Œê°œì„œì˜ ê° ê²½í—˜ì„ STAR í”„ë ˆì„ì›Œí¬ë¡œ ë¶„ì„í•´ì£¼ì„¸ìš”.
      
      **STAR Framework:**
      - Situation: ìƒí™© ì„¤ëª…ì˜ ëª…í™•ì„±
      - Task: ê³¼ì œ/ëª©í‘œì˜ êµ¬ì²´ì„±
      - Action: í–‰ë™/í•´ê²°ê³¼ì •ì˜ ìƒì„¸í•¨
      - Result: ê²°ê³¼/ì„±ê³¼ì˜ ì •ëŸ‰í™”
      
      **ì¶œë ¥ í˜•ì‹ (JSON):**
      {
        "star_analyses": [
          {
            "experience": "ì¸í„´ì‹­ í”„ë¡œì íŠ¸",
            "situation": {
              "quality": "excellent",
              "score": 9,
              "content": "ìŠ¤íƒ€íŠ¸ì—…ì˜ ê¸‰ê²©í•œ ì„±ì¥ìœ¼ë¡œ ì¸í•œ ì‹œìŠ¤í…œ ê³¼ë¶€í•˜"
            },
            "task": {
              "quality": "good",
              "score": 7,
              "content": "ì„œë²„ ì•ˆì •í™” ë° ì„±ëŠ¥ ê°œì„ "
            },
            "action": {
              "quality": "excellent",
              "score": 9,
              "content": "ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜ ë„ì…, ìºì‹± ì „ëµ ìˆ˜ë¦½"
            },
            "result": {
              "quality": "good",
              "score": 8,
              "content": "ì‘ë‹µì†ë„ 50% ê°œì„ , ì„œë²„ ë¹„ìš© 30% ì ˆê°"
            },
            "total_score": 33,
            "improvement": "Task ë¶€ë¶„ì— ë” êµ¬ì²´ì ì¸ ëª©í‘œ ìˆ˜ì¹˜ ì œì‹œ í•„ìš”"
          }
        ],
        "overall_star_score": 85,
        "missing_elements": ["ì¼ë¶€ ê²½í—˜ì— Result ëˆ„ë½", "Actionì˜ êµ¬ì²´ì  ë°©ë²•ë¡  ë¶€ì¡±"],
        "strong_points": ["ì •ëŸ‰ì  ì„±ê³¼ ì œì‹œ", "ìƒí™© ì„¤ëª… ëª…í™•"]
      }
      
      ìê¸°ì†Œê°œì„œ: #{content}
    PROMPT
    
    response = make_api_request(prompt, "STAR ë¶„ì„ ì „ë¬¸ê°€", 2500)
    parse_json_response(response)
  end
  
  # 4. ê²½í—˜ ìì‚° ë¶„ì„
  def analyze_experience_assets(content, company_name)
    prompt = <<~PROMPT
      ì§€ì›ìì˜ ê²½í—˜ì„ ìì‚° ê°€ì¹˜ë¡œ ë¶„ì„í•´ì£¼ì„¸ìš”.
      
      **ê²½í—˜ ìì‚° ì¹´í…Œê³ ë¦¬:**
      - í•µì‹¬ ê²½í—˜ (Core Experience): ì§ë¬´ ì§ê²° ê²½í—˜
      - ì „ì´ ê°€ëŠ¥ ê²½í—˜ (Transferable): íƒ€ ë¶„ì•¼ í™œìš© ê°€ëŠ¥
      - ì ì¬ ê²½í—˜ (Potential): ë¯¸ë˜ ì„±ì¥ ê°€ëŠ¥ì„±
      - íŠ¹ìˆ˜ ê²½í—˜ (Unique): ì°¨ë³„í™”ëœ ë…íŠ¹í•œ ê²½í—˜
      
      **ì¶œë ¥ í˜•ì‹ (JSON):**
      {
        "experience_assets": {
          "core_experiences": [
            {
              "experience": "ë°±ì—”ë“œ ê°œë°œ 3ë…„",
              "value": "high",
              "relevance": 95,
              "application": "ì¦‰ì‹œ ì‹¤ë¬´ íˆ¬ì… ê°€ëŠ¥"
            }
          ],
          "transferable_experiences": [
            {
              "experience": "í•™ìƒíšŒ ì¬ë¬´ ë‹´ë‹¹",
              "value": "medium",
              "relevance": 60,
              "application": "ì˜ˆì‚° ê´€ë¦¬ ë° ì˜ì‚¬ê²°ì •"
            }
          ],
          "potential_experiences": [
            {
              "experience": "ì˜¤í”ˆì†ŒìŠ¤ ê¸°ì—¬",
              "value": "high",
              "relevance": 80,
              "application": "ê¸€ë¡œë²Œ í˜‘ì—… ë° ì½”ë“œ í’ˆì§ˆ"
            }
          ],
          "unique_experiences": [
            {
              "experience": "AI ìŠ¤íƒ€íŠ¸ì—… ì°½ì—… ê²½í—˜",
              "value": "very_high",
              "relevance": 85,
              "application": "ì‚¬ì—… ì „ë°˜ ì´í•´ ë° ë¦¬ë”ì‹­"
            }
          ]
        },
        "total_asset_value": "8.5/10",
        "company_fit": "#{company_name}ì˜ í˜ì‹  ë¬¸í™”ì™€ ë†’ì€ ì í•©ë„",
        "missing_assets": ["ëŒ€ê¸°ì—… ê²½í—˜", "ê¸€ë¡œë²Œ í”„ë¡œì íŠ¸"],
        "leverage_strategy": "ì°½ì—… ê²½í—˜ì„ í†µí•œ ownership ê°•ì¡°"
      }
      
      ê¸°ì—…: #{company_name}
      ìê¸°ì†Œê°œì„œ: #{content}
    PROMPT
    
    response = make_api_request(prompt, "ê²½í—˜ ìì‚° í‰ê°€ ì „ë¬¸ê°€", 2000)
    parse_json_response(response)
  end
  
  # 5. ë¬¸ì¥ ì„íŒ©íŠ¸ ë¶„ì„
  def analyze_sentence_impact(content)
    prompt = <<~PROMPT
      ìê¸°ì†Œê°œì„œì˜ ë¬¸ì¥ë³„ ì„íŒ©íŠ¸ë¥¼ ë¶„ì„í•´ì£¼ì„¸ìš”.
      
      **í‰ê°€ ê¸°ì¤€:**
      - ì²« ë¬¸ì¥ í›…(Hook): ê´€ì‹¬ ìœ ë°œë„
      - í•µì‹¬ ë¬¸ì¥: ê¸°ì–µì— ë‚¨ëŠ” ì •ë„
      - ì „í™˜ ë¬¸ì¥: ë…¼ë¦¬ì  ì—°ê²°ì„±
      - ë§ˆë¬´ë¦¬ ë¬¸ì¥: ì—¬ìš´ê³¼ ì¸ìƒ
      
      **ì¶œë ¥ í˜•ì‹ (JSON):**
      {
        "sentence_analysis": {
          "opening_impact": {
            "sentence": "ì‹¤íŒ¨ë¥¼ ë‘ë ¤ì›Œí•˜ì§€ ì•ŠëŠ” ë„ì „ ì •ì‹ ìœ¼ë¡œ...",
            "impact_score": 6,
            "feedback": "ì§„ë¶€í•œ í‘œí˜„, êµ¬ì²´ì  ì‚¬ë¡€ë¡œ ì‹œì‘ ê¶Œì¥",
            "suggestion": "'3ë²ˆì˜ ì°½ì—… ì‹¤íŒ¨ê°€ ì €ë¥¼ ë” ê°•í•˜ê²Œ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤'ë¡œ ë³€ê²½"
          },
          "power_sentences": [
            {
              "sentence": "ê³ ê° ì´íƒˆë¥ ì„ 3ê°œì›”ë§Œì— 40%ì—ì„œ 15%ë¡œ ê°ì†Œì‹œì¼°ìŠµë‹ˆë‹¤",
              "impact_score": 9,
              "reason": "êµ¬ì²´ì  ìˆ˜ì¹˜ì™€ ë‹¨ê¸°ê°„ ì„±ê³¼"
            }
          ],
          "weak_sentences": [
            {
              "sentence": "ì—´ì‹¬íˆ ë…¸ë ¥í•˜ê² ìŠµë‹ˆë‹¤",
              "impact_score": 2,
              "reason": "ì¶”ìƒì ì´ê³  ì§„ë¶€í•¨",
              "suggestion": "êµ¬ì²´ì  ì‹¤í–‰ ê³„íš ì œì‹œ"
            }
          ],
          "closing_impact": {
            "sentence": "ê·€ì‚¬ì™€ í•¨ê»˜ ì„±ì¥í•˜ê³  ì‹¶ìŠµë‹ˆë‹¤",
            "impact_score": 5,
            "feedback": "í‰ë²”í•œ ë§ˆë¬´ë¦¬",
            "suggestion": "ê¸°ì—…ì˜ ë¹„ì „ê³¼ ê°œì¸ ëª©í‘œ ì—°ê²°"
          }
        },
        "overall_impact": 6.8,
        "memorable_quotient": "ì¤‘ê°„",
        "improvement_areas": ["ì˜¤í”„ë‹ ê°•í™”", "í´ë¦¬ì…° ì œê±°", "êµ¬ì²´ì„± ì¶”ê°€"]
      }
      
      ìê¸°ì†Œê°œì„œ: #{content}
    PROMPT
    
    response = make_api_request(prompt, "ë¬¸ì¥ ë¶„ì„ ì „ë¬¸ê°€", 2000)
    parse_json_response(response)
  end
  
  # 6. í‚¤ì›Œë“œ ì¸í…”ë¦¬ì „ìŠ¤
  def analyze_keywords(content, company_name, position)
    prompt = <<~PROMPT
      ìê¸°ì†Œê°œì„œì˜ í‚¤ì›Œë“œë¥¼ ì „ëµì ìœ¼ë¡œ ë¶„ì„í•´ì£¼ì„¸ìš”.
      
      **ë¶„ì„ í•­ëª©:**
      - ì§ë¬´ í‚¤ì›Œë“œ ë§¤ì¹­ë„
      - ê¸°ì—… í•µì‹¬ê°€ì¹˜ ë°˜ì˜ë„
      - íŠ¸ë Œë“œ í‚¤ì›Œë“œ í™œìš©
      - ì°¨ë³„í™” í‚¤ì›Œë“œ
      
      **ì¶œë ¥ í˜•ì‹ (JSON):**
      {
        "keyword_analysis": {
          "job_keywords": {
            "matched": ["ê°œë°œ", "í”„ë¡œê·¸ë˜ë°", "ë¬¸ì œí•´ê²°", "í˜‘ì—…"],
            "missing": ["ì• ìì¼", "DevOps", "í´ë¼ìš°ë“œ", "CI/CD"],
            "match_rate": 65
          },
          "company_values": {
            "matched": ["í˜ì‹ ", "ë„ì „"],
            "missing": ["ì •ì§", "ê³ ê°ì¤‘ì‹¬"],
            "match_rate": 50
          },
          "trend_keywords": {
            "included": ["AI", "ìë™í™”"],
            "recommended": ["ì§€ì†ê°€ëŠ¥ì„±", "ESG", "ë””ì§€í„¸ì „í™˜"],
            "trend_score": 60
          },
          "differentiation_keywords": {
            "unique": ["ë¸”ë¡ì²´ì¸ íŠ¹í—ˆ", "í•´ì»¤í†¤ ìš°ìŠ¹"],
            "overused": ["ì„±ì‹¤", "ì±…ì„ê°", "ì—´ì •"],
            "uniqueness_score": 70
          },
          "keyword_density": {
            "optimal_range": "2-4%",
            "current": "3.2%",
            "status": "ì ì •"
          }
        },
        "overall_keyword_score": 72,
        "seo_optimization": "good",
        "recommendations": [
          "ê¸°ì—… í•µì‹¬ê°€ì¹˜ í‚¤ì›Œë“œ ë³´ê°•",
          "ìµœì‹  ê¸°ìˆ  íŠ¸ë Œë“œ ë°˜ì˜",
          "ì§„ë¶€í•œ í‘œí˜„ êµì²´"
        ]
      }
      
      ê¸°ì—…: #{company_name}
      ì§ë¬´: #{position}
      ìê¸°ì†Œê°œì„œ: #{content}
    PROMPT
    
    response = make_api_request(prompt, "í‚¤ì›Œë“œ ì „ëµ ì „ë¬¸ê°€", 2000)
    parse_json_response(response)
  end
  
  # 7. ë¦¬ìŠ¤í¬ ì§„ë‹¨ (Red/Yellow Flags)
  def diagnose_risks(content)
    prompt = <<~PROMPT
      ìê¸°ì†Œê°œì„œì˜ ì ì¬ì  ë¦¬ìŠ¤í¬ë¥¼ ì§„ë‹¨í•´ì£¼ì„¸ìš”.
      
      **ë¦¬ìŠ¤í¬ ë ˆë²¨:**
      - ğŸ”´ Red Flag: ì¦‰ì‹œ ìˆ˜ì • í•„ìš”
      - ğŸŸ¡ Yellow Flag: ê°œì„  ê¶Œì¥
      - ğŸŸ¢ Green: ë¬¸ì œì—†ìŒ
      
      **ì¶œë ¥ í˜•ì‹ (JSON):**
      {
        "risk_diagnosis": {
          "red_flags": [
            {
              "issue": "ê³¼ì¥ëœ í‘œí˜„",
              "location": "2ë²ˆì§¸ ë‹¨ë½",
              "example": "'ì—…ê³„ ìµœê³  ìˆ˜ì¤€ì˜ ì‹¤ë ¥'",
              "risk": "ì‹ ë¢°ì„± í›¼ì†",
              "solution": "ê°ê´€ì  ì§€í‘œë¡œ ëŒ€ì²´"
            }
          ],
          "yellow_flags": [
            {
              "issue": "ëª¨í˜¸í•œ ì„±ê³¼",
              "location": "í”„ë¡œì íŠ¸ ì„¤ëª…",
              "example": "'ë§ì€ ê°œì„ '",
              "risk": "êµ¬ì²´ì„± ë¶€ì¡±",
              "solution": "ì •ëŸ‰ì  ìˆ˜ì¹˜ ì œì‹œ"
            }
          ],
          "green_signals": [
            {
              "strength": "ì¼ê´€ëœ ìŠ¤í† ë¦¬ë¼ì¸",
              "impact": "ì‹ ë¢°ë„ í–¥ìƒ"
            }
          ],
          "integrity_check": {
            "consistency": 85,
            "credibility": 78,
            "authenticity": 82
          }
        },
        "overall_risk_level": "medium",
        "critical_issues": 2,
        "minor_issues": 5,
        "risk_score": 65,
        "priority_fixes": ["ê³¼ì¥ í‘œí˜„ ì œê±°", "ìˆ˜ì¹˜ êµ¬ì²´í™”", "ì¦ë¹™ ê°€ëŠ¥ì„± í™•ë³´"]
      }
      
      ìê¸°ì†Œê°œì„œ: #{content}
    PROMPT
    
    response = make_api_request(prompt, "ë¦¬ìŠ¤í¬ í‰ê°€ ì „ë¬¸ê°€", 2000)
    parse_json_response(response)
  end
  
  # 8. ì°¨ë³„í™” ì „ëµ
  def analyze_differentiation(content, position)
    prompt = <<~PROMPT
      ìê¸°ì†Œê°œì„œì˜ ì°¨ë³„í™” ìš”ì†Œë¥¼ ë¶„ì„í•˜ê³  ì „ëµì„ ì œì‹œí•´ì£¼ì„¸ìš”.
      
      **ì°¨ë³„í™” ë¶„ì„:**
      - í˜„ì¬ ì°¨ë³„ì 
      - ê²½ìŸì ëŒ€ë¹„ ìš°ìœ„
      - ì ì¬ ì°¨ë³„í™” ìš”ì†Œ
      - í¬ì§€ì…”ë‹ ì „ëµ
      
      **ì¶œë ¥ í˜•ì‹ (JSON):**
      {
        "differentiation_analysis": {
          "current_differentiators": [
            {
              "factor": "ì°½ì—… ê²½í—˜",
              "uniqueness": "high",
              "relevance": "medium",
              "impact": 8
            }
          ],
          "competitive_advantages": [
            {
              "advantage": "ê¸°ìˆ +ë¹„ì¦ˆë‹ˆìŠ¤ ìœµí•© ì—­ëŸ‰",
              "vs_competitors": "ìƒìœ„ 10%",
              "evidence": "ê°œë°œìì´ë©´ì„œ ì‚¬ì—… ê²½í—˜"
            }
          ],
          "hidden_differentiators": [
            {
              "potential": "ì˜¤í”ˆì†ŒìŠ¤ ê¸°ì—¬ë„",
              "current_emphasis": "low",
              "recommended_emphasis": "high",
              "how_to_leverage": "GitHub í”„ë¡œí•„ ê°•ì¡°"
            }
          ],
          "positioning_strategy": {
            "current_position": "ì¼ë°˜ ê°œë°œì",
            "recommended_position": "ê¸°ìˆ  ì°½ì—…ê°€í˜• ê°œë°œì",
            "key_message": "ë¹„ì¦ˆë‹ˆìŠ¤ë¥¼ ì´í•´í•˜ëŠ” ê°œë°œì",
            "supporting_points": ["ì°½ì—… ê²½í—˜", "ê³ ê° ê´€ì ", "ì œí’ˆ ì‚¬ê³ "]
          },
          "differentiation_score": 73,
          "uniqueness_index": "ìƒìœ„ 20%"
        },
        "recommendations": [
          "ì°½ì—… ìŠ¤í† ë¦¬ ì „ë©´ ë°°ì¹˜",
          "ê¸°ìˆ -ë¹„ì¦ˆë‹ˆìŠ¤ ì‹œë„ˆì§€ ê°•ì¡°",
          "êµ¬ì²´ì  ì„íŒ©íŠ¸ ìˆ˜ì¹˜í™”"
        ]
      }
      
      ì§ë¬´: #{position}
      ìê¸°ì†Œê°œì„œ: #{content}
    PROMPT
    
    response = make_api_request(prompt, "ì°¨ë³„í™” ì „ëµ ì „ë¬¸ê°€", 2000)
    parse_json_response(response)
  end
  
  # 9. í•©ê²© ê°€ëŠ¥ì„± ì˜ˆì¸¡
  def predict_pass_rate(content, company_name, position)
    prompt = <<~PROMPT
      ìê¸°ì†Œê°œì„œ ê¸°ë°˜ í•©ê²© ê°€ëŠ¥ì„±ì„ ì˜ˆì¸¡í•´ì£¼ì„¸ìš”.
      
      **ì˜ˆì¸¡ ëª¨ë¸ ê³ ë ¤ì‚¬í•­:**
      - ì§ë¬´ ì í•©ë„
      - ê¸°ì—… ë¬¸í™” ì í•©ë„
      - ê²½ìŸë ¥ ìˆ˜ì¤€
      - ì°¨ë³„í™” ì •ë„
      - ë¦¬ìŠ¤í¬ ìš”ì¸
      
      **ì¶œë ¥ í˜•ì‹ (JSON):**
      {
        "pass_prediction": {
          "overall_probability": 68,
          "confidence_level": "medium",
          "breakdown": {
            "document_quality": 75,
            "job_fit": 70,
            "company_fit": 65,
            "competitiveness": 60,
            "differentiation": 70
          },
          "competitive_position": {
            "estimated_rank": "ìƒìœ„ 30%",
            "total_applicants": "ì˜ˆìƒ 200ëª…",
            "your_position": "60ìœ„ê¶Œ"
          },
          "success_factors": [
            "ê°•ë ¥í•œ í”„ë¡œì íŠ¸ ê²½í—˜",
            "ì •ëŸ‰ì  ì„±ê³¼ ì œì‹œ",
            "ì„±ì¥ ê°€ëŠ¥ì„±"
          ],
          "risk_factors": [
            "ëŒ€ê¸°ì—… ê²½í—˜ ë¶€ì¡±",
            "ì§ë¬´ ê²½ë ¥ ì§§ìŒ",
            "ì°¨ë³„í™” ë¶€ì¡±"
          ],
          "scenario_analysis": {
            "best_case": {
              "probability": 85,
              "condition": "ë©´ì ‘ ìš°ìˆ˜ ìˆ˜í–‰ì‹œ"
            },
            "likely_case": {
              "probability": 68,
              "condition": "í˜„ì¬ ìƒíƒœ ìœ ì§€ì‹œ"
            },
            "worst_case": {
              "probability": 40,
              "condition": "ê²½ìŸì ìˆ˜ì¤€ ë†’ì„ì‹œ"
            }
          },
          "improvement_impact": {
            "if_improved": 82,
            "key_improvements": ["ì°¨ë³„í™” ê°•í™”", "ê¸°ì—… ì—°êµ¬ ì‹¬í™”"],
            "expected_lift": "+14%"
          }
        },
        "recommendation": "ì„œë¥˜ í•©ê²© ê°€ëŠ¥ì„± ìˆìœ¼ë‚˜ ê°œì„  í•„ìš”",
        "action_items": ["ì°¨ë³„í™” í¬ì¸íŠ¸ ê°•í™”", "ê¸°ì—… ë§ì¶¤ ìˆ˜ì •", "ë¦¬ìŠ¤í¬ ìš”ì¸ ë³´ì™„"]
      }
      
      ê¸°ì—…: #{company_name}
      ì§ë¬´: #{position}
      ìê¸°ì†Œê°œì„œ: #{content}
    PROMPT
    
    response = make_api_request(prompt, "í•©ê²© ì˜ˆì¸¡ ì „ë¬¸ê°€", 2500)
    parse_json_response(response)
  end
  
  # ì¢…í•© ë³´ê³ ì„œ ìƒì„±
  def generate_comprehensive_report(analyses, content, company_name, position)
    prompt = <<~PROMPT
      9ê°€ì§€ ë¶„ì„ ê²°ê³¼ë¥¼ ì¢…í•©í•˜ì—¬ ì „ëµì  ê°œì„  ë°©í–¥ì„ ì œì‹œí•´ì£¼ì„¸ìš”.
      
      **ì¢…í•© ë¶„ì„ ê²°ê³¼:**
      #{analyses.to_json}
      
      **ì¶œë ¥ í˜•ì‹:**
      ## ğŸ“Š AI ì‹¬ì¸µë¶„ì„ ì¢…í•© ë³´ê³ ì„œ
      
      ### ğŸ¯ ì¢…í•© í‰ê°€
      - **ì´ì **: [ì ìˆ˜]/100
      - **ë“±ê¸‰**: [S/A/B/C/D]
      - **í•©ê²© ê°€ëŠ¥ì„±**: [%]
      - **ê²½ìŸë ¥ ìˆ˜ì¤€**: ìƒìœ„ [%]
      
      ### ğŸ’ª í•µì‹¬ ê°•ì  TOP 3
      1. [ê°•ì 1]: [êµ¬ì²´ì  ì„¤ëª…]
      2. [ê°•ì 2]: [êµ¬ì²´ì  ì„¤ëª…]
      3. [ê°•ì 3]: [êµ¬ì²´ì  ì„¤ëª…]
      
      ### âš ï¸ ê°œì„  í•„ìˆ˜ ì‚¬í•­ TOP 3
      1. [ê°œì„ ì 1]: [êµ¬ì²´ì  ë°©ë²•]
      2. [ê°œì„ ì 2]: [êµ¬ì²´ì  ë°©ë²•]
      3. [ê°œì„ ì 3]: [êµ¬ì²´ì  ë°©ë²•]
      
      ### ğŸ¯ ì „ëµì  í¬ì§€ì…”ë‹
      **í˜„ì¬ í¬ì§€ì…˜**: [ì„¤ëª…]
      **ëª©í‘œ í¬ì§€ì…˜**: [ì„¤ëª…]
      **ì „í™˜ ì „ëµ**: [êµ¬ì²´ì  ë°©ë²•]
      
      ### ğŸ“ˆ ê°œì„  ë¡œë“œë§µ
      **ì¦‰ì‹œ ìˆ˜ì • (1ì¼ ì´ë‚´)**
      - [í•­ëª©1]
      - [í•­ëª©2]
      
      **ë‹¨ê¸° ê°œì„  (1ì£¼ì¼ ì´ë‚´)**
      - [í•­ëª©1]
      - [í•­ëª©2]
      
      **ì¤‘ê¸° ë³´ê°• (1ê°œì›” ì´ë‚´)**
      - [í•­ëª©1]
      - [í•­ëª©2]
      
      ### ğŸ’¡ ì°¨ë³„í™” ì „ëµ
      [êµ¬ì²´ì ì¸ ì°¨ë³„í™” ë°©í–¥ê³¼ ì‹¤í–‰ ë°©ë²•]
      
      ### ğŸ¯ ìµœì¢… ì œì–¸
      [ì¸ì‚¬ë‹´ë‹¹ì ê´€ì ì—ì„œ ë³¸ í•µì‹¬ ì¡°ì–¸]
      
      ê¸°ì—…: #{company_name}
      ì§ë¬´: #{position}
    PROMPT
    
    response = make_api_request(prompt, "ì¢…í•© ë¶„ì„ ì „ë¬¸ê°€", 3000)
    parse_response(response)[:content]
  end
  
  # ì‹œê°í™” ë°ì´í„° ì¤€ë¹„
  def prepare_visualization_data(analyses)
    {
      radar_chart: {
        categories: ["ì§ë¬´ì í•©ì„±", "êµ¬ì²´ì„±", "ë…¼ë¦¬ì„±", "ì°¨ë³„í™”", "í‘œí˜„ë ¥"],
        scores: [
          analyses[:quantitative_score]["categories"]["job_fit"]["score"] * 5,
          analyses[:quantitative_score]["categories"]["specificity"]["score"] * 5,
          analyses[:quantitative_score]["categories"]["logic"]["score"] * 5,
          analyses[:quantitative_score]["categories"]["differentiation"]["score"] * 5,
          analyses[:quantitative_score]["categories"]["expression"]["score"] * 5
        ]
      },
      competency_bars: analyses[:competency_matrix]["competencies"].map do |key, value|
        {
          name: key.to_s.humanize,
          score: value["rating"] * 20
        }
      end,
      risk_pie: {
        red: analyses[:risk_diagnosis]["critical_issues"],
        yellow: analyses[:risk_diagnosis]["minor_issues"],
        green: 10 - analyses[:risk_diagnosis]["critical_issues"] - analyses[:risk_diagnosis]["minor_issues"]
      },
      pass_gauge: analyses[:pass_prediction]["overall_probability"],
      improvement_impact: {
        current: analyses[:pass_prediction]["overall_probability"],
        potential: analyses[:pass_prediction]["improvement_impact"]["if_improved"]
      }
    }
  end
  
  def make_api_request(prompt, role_description, max_tokens = 3000)
    uri = URI(OPENAI_API_URL)
    http = Net::HTTP.new(uri.host, uri.port)
    http.use_ssl = true
    http.read_timeout = 60
    
    request = Net::HTTP::Post.new(uri)
    request['Authorization'] = "Bearer #{@api_key}"
    request['Content-Type'] = 'application/json'
    
    body_params = {
      model: @model,
      messages: [
        {
          role: 'system',
          content: "ë‹¹ì‹ ì€ #{role_description}ì…ë‹ˆë‹¤. í•œêµ­ ì±„ìš© ì‹œì¥ê³¼ ê¸°ì—… ë¬¸í™”ë¥¼ ê¹Šì´ ì´í•´í•˜ê³  ìˆìœ¼ë©°, ë°ì´í„° ê¸°ë°˜ì˜ ì •í™•í•œ ë¶„ì„ì„ ì œê³µí•©ë‹ˆë‹¤."
        },
        {
          role: 'user',
          content: prompt
        }
      ],
      temperature: 0.7,
      max_tokens: max_tokens
    }
    
    # JSON ì‘ë‹µ í˜•ì‹ ì§€ì • (í•„ìš”í•œ ê²½ìš°)
    if prompt.include?("JSON")
      body_params[:response_format] = { type: "json_object" }
    end
    
    request.body = body_params.to_json
    
    response = http.request(request)
    JSON.parse(response.body)
  end
  
  def parse_response(response)
    if response['error']
      { error: response['error']['message'] }
    elsif response['choices'] && response['choices'].first
      {
        success: true,
        content: response['choices'].first['message']['content'],
        usage: response['usage']
      }
    else
      { error: 'ì˜ˆìƒì¹˜ ëª»í•œ ì‘ë‹µ í˜•ì‹ì…ë‹ˆë‹¤' }
    end
  end
  
  def parse_json_response(response)
    result = parse_response(response)
    return result if result[:error]
    
    begin
      JSON.parse(result[:content])
    rescue JSON::ParserError
      { error: 'JSON íŒŒì‹± ì‹¤íŒ¨', content: result[:content] }
    end
  end
end